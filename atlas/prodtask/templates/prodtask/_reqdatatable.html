{% extends parent_template %}
{% load i18n %}
{% load url from future %}
{% load static from staticfiles %}
{% load js %}

{% block bl_title %}Core App of Monitoring{% endblock %}

{% block bl_subtitle %}
{% if title %}{{ title }}{% else %}Datatable{% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
	<style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
        @import "{% static "css/jquery.dataTables_themeroller.css" %}";
	</style>
   <style type="text/css">
 	span.obsolete	{ color : lightblue;}
	span.holding 	{ color : black;	}
	span.pending	{ color : blue;		}
	span.waiting	{ color : blue;	}
	span.submitting	{ color : blue;	}
	span.archived 	{ color : magenta;	}
 	span.submitted	{ color : green;	}

	span.running 	{ color : LightGreen;	}

	span.done 		{ color : darkgreen;	}
	span.finished	{ color : darkgreen;	}

	span.failures	{ color : orange;	}

	span.failed 	{ color : red;	}
	span.aborted 	{ color : red;	}
	span.broken		{ color : red;	}

	span.navy		{ color : blue; }
    span.registered { color : blue;}
  </style>
   <style type="text/css">
 	td.obsolete	{ background-color : lightblue;}
	td.holding 	{ background-color : black;	}
	td.pending	{ background-color : blue;		}
	td.waiting	{ background-color : blue;	}
	td.submitting	{ background-color : blue;	}
	td.archived 	{ background-color : magenta;	}
 	td.submitted	{ background-color : green;	}

	td.running 	{ background-color : LightGreen;	}

	td.done 		{ background-color : darkgreen;	}
	td.finished	{ background-color : darkgreen;	}

	td.failures	{ background-color : orange;	}

	td.failed 	{ background-color : red;	}
	td.aborted 	{ background-color : red;	}
	td.broken		{ background-color : red;	}

	td.navy		{ background-color : blue; }
    td.registered { background-color : blue;}
  </style>

   <style>
    tr.bottom_row_task td {border-bottom: 1px solid black;}
   </style>

    <style>
    td.approved { color : green;	}
    td.not_approved { color : red;}
    td.partially_approved { color : orange;	}
    td.hidden { color : #463cff;	}
   </style>

{% endblock %}

{% block base_js %}
{{ block.super }}

{%  django_js %}
<script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript" src="{% static "js/jquery.cookie.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.json-2.4.min.js" %}"></script>
<script type="text/javascript" src="{% static 'js/foundation.js' %}"></script>
<script type="text/javascript" src="{% static 'js/slice.js' %}"></script>

{% endblock %}


{% block body %}
<!-- TODO: Replace next tables by independet from field objects   -->

<div style="display:none">
    <input type="hidden" id="doColor" />
    <input type="hidden" id="skippedColor" />
    <input type="hidden" id="foreignColor" />
</div>
<script>
var step_bc=["#FFB734","#FFFFFF","#ffff00"]
$("#doColor").css({'background-color':step_bc[0]});
$("#skippedColor").css({'background-color':step_bc[1]});
$("#foreignColor").css({'background-color':step_bc[2]});
$(document).ready(function(){
var temp_ref_link = '{{ trequest.ref_link}}';
$('#request_link').html(temp_ref_link.slice(temp_ref_link.lastIndexOf('/')+1,temp_ref_link.length));
{% if not edit_mode %}
    $("#patternTable").hide();
    $("#approveButton").hide();
    $("#saveButton").hide();
    $("#approveEvgenButton").hide();
    $(".hiddenNonEdit").hide();
    $("#updateStepParams").hide();
{% endif %}

var slices_changes = {};

    {% if not user.is_authenticated %}
      $(".btn_is_authenticated").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
      $(".btn_is_authorized").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
    {% endif %}

    {% if not autorized_change_request %}
      $(".btn_is_authenticated").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
    {% endif %}

$(".stepchoose").css({"font-size": "12px","width": "50px","padding":"0px","border": "1px solid black",
                         "cursor":"pointer","user-select": "none"});
$(".inputListRow").children("td").css({"padding":"1px"})
$(".inputListTables").css({"border": "1px solid black","margin": "1px"})
$(".outsideInputListTables").css({"border": "hidden","margin": "1px"})
$(".showFullSpan").css({"cursor":"pointer","user-select":"none"});
$(".showSmallSpan").css({"cursor":"pointer"});

{#Color pattern steps#}
 {% for step in step_list %}
    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});

 {% endfor %}

 $("#selectPattern").change(function(){
    {% for pattern, steps  in pattern_list %}
        if ($("#selectPattern").val() == "{{ pattern }}"){

            {% for step, fields in steps %}
                $("#patternform{{forloop.counter0}}").val("{{ step }}");
                if("{{ step }}" != ""){
                    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});
                } else{
                    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#skippedColor").css("background-color")});
                }
                i = {{  forloop.counter0 }};
                {% for field_name, field_value in fields %}
                    patternDict[i]['{{ field_name }}']='{{ field_value }}';

                {% endfor %}

            {% endfor %}
        }
    {% endfor %}
});

    $(".stepchoose").click(function(){
        var currentColor = $(this).css("background-color");
        var currentIndex = (step_bc.indexOf(currentColor)+1)%2;
        $(this).css({"background-color":step_bc[currentIndex]});
        step_bc[currentIndex] =  $(this).css("background-color");
        if($(this).attr("id").substr(0,4) == 'step'){
            var step_td_short = "td#short".concat($(this).attr("id").substr(4)).concat(".showFullSpan");
            $(step_td_short).css({"background-color":step_bc[currentIndex]});
        };
    })  ;
    {#    replace hide/show on dynamic creation#}
    $(".showFullSpan").click(function(){
       $(this).parent().parent().parent().hide(0);
       $(this).parentsUntil(".inputListDivs").children(".inputListTablesLong").show(0);
        return false;
    });
    $(".showSmallSpan").click(function(){
       $(this).parent().parent().parent().siblings(".inputListTables").show(0);
       $(this).parent().parent().parent().siblings(".inputListTables").children().show(0);
        $(this).parent().parent().parent().hide(0);
         return false;
    });

    $("#filter").keyup(function(){
       var valThis = $(this).val().toLowerCase();
       if(valThis == ""){
           $(".inputListDivs").show();
       } else{
           $(".inputListDivs").hide();
           $(".filterField").each(function(){
              if($(this).text().toLowerCase().indexOf(valThis)>=0){
                  $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().show();
              }
           });
       }
    });
{#    $("#newComment").keyup(function(event){#}
{#    if(event.keyCode == 13){#}
{#        addComment(event);#}
{#    };#}
{#    });#}
    {#Fill pattern table#}
    (function(){
       {% for inputList, step_exec_dict, approved, show_task, foreignStepID, approve_level  in inputLists %}
           {% for step in step_exec_dict %}
                        {% ifequal step.skipped 'skipped' %}
                            var stepColor = $("#skippedColor").css("background-color");
                        {% endifequal %}
                        {% ifequal step.skipped 'run' %}
                            var stepColor = $("#doColor").css("background-color");
                        {% endifequal %}
                        {% ifequal step.skipped 'foreign' %}
                            var stepColor = $("#foreignColor").css("background-color");
                        {% endifequal %}
                        {% if  forloop.counter0 < approve_level %}
                            var borderColor = 'green';
                        {%  else  %}
                            var borderColor = 'grey';
                        {% endif  %}
                        $("#short{{ inputList.slice }}s{{ forloop.counter0 }}.showFullSpan").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});
                        $("#short{{ inputList.slice }}s{{ forloop.counter0 }}.notShowFullSpan").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});
                        $("#step{{ inputList.slice }}s{{ forloop.counter0 }}.stepchoose").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});


           {% endfor %}

       {% endfor %}
         {% for step in step_list %}
            patternDict.push({});
            {% endfor %}
    })();
    (function(){
            $('.storeInput').bind('change',function(){changeSliceChanges(this);});
        })();
    $("#approveDialog").dialog({
        autoOpen: false,
        buttons : {
                OK : function(){
                    $( this ).dialog( "close" );
                }
            }
        });
    $("#problemDialog").dialog({
        autoOpen: false,
        buttons : {
                Cancel : function(){
                    $( this ).dialog( "close" );
                }
            }
        });
    makeJobOptionURL();
    $("#tagFormatSelect").change(function(){return tagFormatChange()});
    {% if not show_as_huge %}
        refreshTagFormats(null);
    {% endif %}
});

    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    function makeJobOptionURL(){
        $('.makeJOUrl').each(function(){

              var joboptions = $(this).html().replace(/ /g,'');
		      if ((joboptions!='')&&(joboptions!=undefined)) {
                var jo = joboptions.split(".");
                var dsid = jo[1].substring(0, 3) + "xxx";
                var link = "https://svnweb.cern.ch/cern/wsvn/atlasoff/Generators/" + jo[0] + "JobOptions/trunk/share/DSID" + dsid + "/" + joboptions
                $(this).attr('href', link);
               }
        });
    }

    function approveSlices(isApprove, approveLevel, slices){
        var toChangeDatasets = [];
        var toChangeDatasets = [];
        var startFindig = false;
        var sendData = Object();
        var doReload = false;
            for(var i=0;i<slices.length;i++){
                {#                   8 = "checkbox".length#}
                var sliceID = slices[i];
                var existSkipped = false;
                if (sliceID == '-1'){
                    doReload = true;
                }
                    if (! sendData[sliceID]){
                        sendData[sliceID] = Object();
                    }
                    var sliceSteps=[];
                    var foreignID = "0";
                    {% for step in step_list %}
                        var val = " ";
                        var step_td_short = "td#short".concat(sliceID).concat("s{{ forloop.counter0 }}.showFullSpan");
                        var isSkipped = ($(step_td_short).css("background-color") ==  $("#skippedColor").css("background-color"));
                        if (isSkipped){
                            existSkipped = true;
                        }
                        if ($(step_td_short).css("background-color") !=  $("#foreignColor").css("background-color")){
                            val = $(step_td_short).html();
                        } else {
                            val = " ";
                        }

                        var step_td_short_foreign = "td#short".concat(sliceID).concat("s{{ forloop.counter0 }}.notShowFullSpan");
                        if ($(step_td_short_foreign).css("background-color") ==  $("#foreignColor").css("background-color")){
                            foreignID = $(step_td_short_foreign).children(".foreignStepID").html();
                            val = " ";
                        }
                        if (sliceID in changesList){
                            if(changesList[sliceID].stepsInSlice.length>{{ forloop.counter0 }}){
                                sliceSteps[{{ forloop.counter0 }}] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':changesList[sliceID].stepsInSlice[{{ forloop.counter0 }}]};
                            }
                            else{
                                sliceSteps[{{ forloop.counter0 }}] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':''};
                            }

                        }
                        else{
                            sliceSteps[{{ forloop.counter0 }}] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':''};
                        }
                    {% endfor %}
                     sliceSteps[{{  step_list|length }}] = {"foreign_id":foreignID};
                     sliceSteps[{{  step_list|length }}+1] = {"input_dataset":$("#inputDatasetSelect" + sliceID).val()};


                    if (sliceID in changesList){
                        sendData[sliceID] = {'sliceSteps':sliceSteps, 'changes':changesList[sliceID]};
                    } else {
                        sendData[sliceID] = {'sliceSteps':sliceSteps, 'changes':''};
                    }
                    if (existSkipped &&  ($("#inputDatasetSelect" + sliceID).val() != "") && ($("#inputDatasetName" + sliceID).val() == "")){
                        toChangeDatasets.push(sliceID);
                    }
                    if (existSkipped &&  !($("#inputDatasetSelect" + sliceID).val()) ){
                        startFindig = true;
                    }

            }

            if (true){
                $( "#waitingDialog" ).dialog();

                var ajaxURL = '';
                if (isApprove){
                    ajaxURL = "{% url 'prodtask:home' %}" +"request_steps_approve/{{ pr_id }}/"+approveLevel.toString()+'/';
                } else {
                    ajaxURL = "{% url 'prodtask:request_steps_save' pr_id %}";
                }

                $.ajax({
                    url: ajaxURL,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        if(status){
                            var missedList = $.evalJSON(data).missing_tags;
                            var errorSlices =  $.evalJSON(data).error_slices;
                            var notChangedSlices = $.evalJSON(data).no_action_slices;
                            var slices = $.evalJSON(data).slices;
                            var wrongSLices = $.evalJSON(data).wrong_slices;
{#                            console.log(wrongSLices);#}
                            var doubleTrf = $.evalJSON(data).double_trf;
                            var newStatus = $.evalJSON(data).new_status;
                            var removeDataset =  $.evalJSON(data).removed_input;
                            if ((newStatus != undefined) && (newStatus != '')){
                                $('#requestStatus').html(newStatus);
                            }
                            if ((missedList.length != 0)||(doubleTrf.length != 0)) {
                                if (missedList.length != 0) {
                                    $("#missing_tags_string").html(missedList.toString());
                                    $("#missing_tags").show();
                                }
                                if (doubleTrf.length != 0){
                                    $("#doubleTagsString").html(doubleTrf.toString());
                                    $("#doubleTags").show();
                                }
                            } else {
                                if(wrongSLices.length>0){
                                    $("#wrongSliceString").html(wrongSLices.toString());
                                    $("#wrongSlice").show();
                                } else {
                                    $("#wrongSlice").hide();
                                }
                                if((slices.length >0)||(errorSlices.length>0)||(notChangedSlices.length>0)){
                                   var datasets = $.evalJSON(data).datasets_dict;
                                   $("#missing_tags").hide();
                                   $("#doubleTags").hide();
                                    $("#approveDialog").html('');
                                   if (errorSlices.length==1){
                                       $("#approveDialog").append($('<p/>').html('Slice has problem: '+errorSlices[0]));
                                   } else{
                                       if (errorSlices.length>1){
                                           $("#approveDialog").append($('<p/>').html(errorSlices.length+'Slices have problem: '+errorSlices.toString()));
                                       }
                                   }
                                   if (notChangedSlices.length==1){
                                       $("#approveDialog").append($('<p/>').html('Slice was not changed: '+notChangedSlices[0]));
                                   } else{
                                       if (notChangedSlices.length>1){
                                           $("#approveDialog").append($('<p/>').html(notChangedSlices.length+'Slices were not changed: '+notChangedSlices.toString()));
                                       }
                                   }
                                    if(doReload){
                                        location.reload();
                                    }
                                   if(isApprove){
                                       $("#approveDialog").append($('<p/>').html("Sucessfully approved slices: "+slices.toString()));
                                       $("#approveDialog").attr("title","Steps approved");
                                       for (i=0;i<slices.length;i++){
                                           $("#aprroveLabel".concat(slices[i])).css({'color':'greenyellow'}).html("Approved");
                                           $("#aprroveLabelLong".concat(slices[i])).css({'color':'greenyellow'}).html("Approved")
                                       }

                                   } else {
                                       $("#approveDialog").append($('<p/>').html("Sucessfully saved slices: "+slices.toString()));
                                       $("#approveDialog").attr("title","Steps saved");
                                   }
                                   $("#approveDialog").dialog("open");
                                }
                            }
                            if (startFindig){
                                findInputForSlices(slices);
                            } else{
                                for (var i=0;i<toChangeDatasets.length;i++){
                                    $("#inputDatasetName"+toChangeDatasets[i]).html($("#inputDatasetSelect"+toChangeDatasets[i]).val());
                                }
                            }
                            for (var i=0; i < removeDataset.length; i++){
                                 $("#inputDatasetName"+removeDataset[i]).html('');
                            }
                            if (slices.length < 200){
                                for (var i = 0; i < slices.length; i++) {
                                    changeSliceSaveStatus(slices[i]);
                                }
                            }

                        } else {
                            $( "#problemDialog" ).dialog("open");
                        }

                    }
                });
            }


    }


    function approveClick(event,isApprove, approveLevel){
        event.preventDefault();
        var slices = [];
        $(".checkboxSlice:checked").each(function() {
            {#                   8 = "checkbox".length#}
            var sliceID = $(this).attr("id").slice(8);
            var existSkipped = false;
            if ($("#inputList_div".concat(sliceID)).is(":visible")) {
                slices.push(sliceID);
            }
        });
        approveSlices(isApprove,approveLevel, slices);
    };
    function approveEmpty(event){
        event.preventDefault();
        var slices = [];
        approveSlices(true,99, slices);
    };

    function emptyPattern(){
      var patternIsEmpty = true;
      {% for step in step_list %}
            patternIsEmpty = patternIsEmpty && ($("#patternform{{forloop.counter0}}").val() == '');
      {% endfor %}
      return patternIsEmpty;
    };
    var currentTags = [];
    function tagInfoUpdate(){
        var newTags = [];
        $(".patternForm").each(function(){
            if (this.val() != ''){
                newTags.push(this.val());
            }
        for (i=0;i<newTags.length;i++){
            if ($.inArray(newTags,currentTags) == -1){

            }
        }
        });
    }
    function bindClick(event){
        event.preventDefault();

            $(".checkboxSlice").each(function(){
                if ($(this).is(':checked')){
{#                   8 = "checkbox".length#}
                   var sliceID = $(this).attr("id").slice(8);
                   if ($("#inputList_div".concat(sliceID)).is(":visible")){
                       {% for step in step_list %}
                           var stepValue = $("#patternform{{ forloop.counter0 }}").val();
                           var step_td_short = "td#short".concat(sliceID).concat("s{{ forloop.counter0 }}.showFullSpan");

                           var stepColor = $("#startStep{{ forloop.counter0 }}").css("background-color");
                           $(step_td_short).css({"background-color":stepColor});
                           var stepFormLong = "#".concat(sliceID).concat("s{{ forloop.counter0 }}.slice_form");
                           var step_th_long = "th#step".concat(sliceID).concat("s{{ forloop.counter0 }}.stepchoose");
                           $(step_th_long).css({"background-color":stepColor});
                           if($('#replaceByPattern').is(':checked')||(stepValue!='')){
                               $(stepFormLong).val(stepValue);
                               $(step_td_short).html(stepValue);
                           }
                           $("#saveStatus"+sliceID.toString()).html("edit (not saved)");
                       {% endfor %}
                           var sliceIDint = parseInt(sliceID);
                           if (!(sliceIDint in changesList)){
                                changesList[sliceIDint] = new RequestSlice();
                            }

                            for(var i=0;i<patternDict.length;i++){
                                if (changesList[sliceIDint].stepsInSlice.length <= i){
                                    var newStep = new ProcessingStep();
                                    changesList[sliceIDint].addStep(newStep);
                                  }
                                var currentStep = changesList[sliceIDint].getStepByNumber(i);
                                for (field in patternDict[i]){
                                    currentStep[field] = patternDict[i][field];
                                }
                            }
                   }
                };
            });


    };

    function showPatternClick(event){
        event.preventDefault();
        $('#patternModalBody').html('');
         {% for step in step_list %}
             var currentStep = '{{ step.name }}:'+'{';
             for (field in patternDict[{{ forloop.counter0 }}]){
                currentStep = currentStep + ' ' + field + ':' + patternDict[{{ forloop.counter0 }}][field] +'; ';
             }
             currentStep = currentStep + '}';
             $('#patternModalBody').append($('<li/>').html(currentStep));
        {% endfor %}
            $('#patternModal').foundation('reveal', 'open')
    };


    function longFormChange(event){
      var step_td_short = "td#short".concat($(event.target).attr('id'))  ;
      $(step_td_short).html($(event.target).val());
      $("#saveStatus"+$(event.target).attr('id').split("s")[0]).html("edit (not saved)");
    };

    function selectClick(event){
      event.preventDefault();
      var firstCheckBox = true;
      var markAsChecked = false;
      $(".checkboxSlice").each(function(){
          var sliceID = $(this).attr("id").slice(8);
          if ($("#inputList_div".concat(sliceID)).is(":visible")){
              if (firstCheckBox){
                  markAsChecked = !($(this).prop('checked'));
                  firstCheckBox = false;
              }
              $(this).prop('checked', markAsChecked);
          }
      });

    };
     function checkSlice(event) {

             currentSlice = ($(event.target).attr('id')).slice('checkbox'.length);
             if (event.shiftKey) {
                 if (lastCheckedSlice > -1) {

                     if (lastCheckedSlice > currentSlice) {
                         fromSlice = currentSlice;
                         toSlice = lastCheckedSlice;
                     } else {
                         fromSlice = lastCheckedSlice;
                         toSlice = currentSlice;
                     }
                     for(var i=fromSlice;i<=toSlice;i++){
                        if ($("#inputList_div".concat(i)).is(":visible")){
                            $('#checkbox'+i).prop("checked",lastChecked);
                        }
                     }

                 }

                 lastCheckedSlice = currentSlice;
             }
            lastCheckedSlice = parseInt(currentSlice);
            lastChecked = $(event.target).is(':checked');
     }
          function approveReprocessingClick(event){
            var sendData = Object();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                if ($("#inputList_div".concat(sliceID)).is(":visible")){
                    sliceList[i] = sliceID;
                    i++;
                }
            });
            sendData = {'tagsFormats':$("#tagsFormatsTA").val(),'slices':sliceList}
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:request_reprocessing_steps_create' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                    }
                });
              return false;
       };
          function chnageStatusToTest(event){
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:make_test_request' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');

                    }
                });
              return false;
       };
        function chnageRequestToFast(event){
            event.preventDefault();
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:make_request_fast' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        $("#isFast").html(" :Yes");
                    }
                });
              return false;
        }
        function tagFormatChange(){
{#                 event.preventDefault();#}
                 sendData = {'tag_format':$("#tagFormatSelect").val()};
                  $( "#waitingDialog" ).dialog();
                  $.ajax({
                        url: "{% url 'prodtask:project_mode_from_tag' pr_id %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        success: function(data,status) {
                            $( "#waitingDialog" ).dialog('close');
                            var project_mode = $.evalJSON(data).project_mode;
                            var input_events = $.evalJSON(data).input_events;
                            var priority = $.evalJSON(data).priority;
                            var nEventsPerJob = $.evalJSON(data).nEventsPerJob;
                            var nEventsPerInputFile = $.evalJSON(data).nEventsPerInputFile;
                            $("#project_mode_input").val(project_mode);
                            $('#input_events_input').val(input_events);
                            $('#priority_input').val(priority);
                            $('#nEventsPerJob_input').val(nEventsPerJob);
                            $('#nEventsPerInputFile_input').val(nEventsPerInputFile);
                            $('#destination_input').val($.evalJSON(data).destination);
                        }
                    });
                  return false;
        };

         function refreshTagFormats(event){
             if(event != undefined){
                 event.preventDefault();
             }

             sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:get_tag_formats' pr_id%}",
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var tagFormats = $.evalJSON(data).data;
                        $("#tagFormatSelect").html("");
                        for (var i=0;i<tagFormats.length;i++){
                            $("#tagFormatSelect").append($('<option>', {
                                value: tagFormats[i],
                                text: tagFormats[i]
                            }));
                        }
                        tagFormatChange();
                    }
                });

              return false;
         };

        function updateStepParametrs(event){
            event.preventDefault();
            sendData = {'tag_format':$("#tagFormatSelect").val(),'project_mode':$("#project_mode_input").val(),
              'input_events':$('#input_events_input').val(),'priority':$('#priority_input').val(),
              'nEventsPerJob':$('#nEventsPerJob_input').val(),
                  'nEventsPerInputFile':$('#nEventsPerInputFile_input').val(),
              'destination_token':$('#destination_input').val()};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:update_project_mode' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var slices = $.evalJSON(data).slices;
                        if(slices.length >0){
                            $("#approveDialog>span").text("Sucessfully update slices: ".concat(slices.toString()));
                            $("#approveDialog").attr("title","Steps updated");
                            $("#approveDialog").dialog("open");
                        }
                    }
                });
              return false;
        };

        function findInputClick(event) {
            event.preventDefault();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                sliceList.push(sliceID);
            });
            findInputForSlices(sliceList);
        }
        function addComment(event){
            event.preventDefault();
            sendData = {'comment':$('#newComment').val()};
            $.ajax({
                    url: "{% url 'prodtask:add_request_comment' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {

                        $('#commentList').prepend('<li>Now; {{ request.user.username }}-'+sendData['comment']+'</li>');
                        $('#lastComment').html('{{ request.user.username }}-'+sendData['comment']);
                    }
                });
        }
        function makeUserOwner(event){
            event.preventDefault();
            sendData = {};
            $.ajax({
                    url: "{% url 'prodtask:make_user_as_owner' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        var newOwnerName =  $.evalJSON(data).ownerName;
                        if ((newOwnerName!='')&&(newOwnerName!=undefined)){
                            $('#ownerName').html(newOwnerName);
                        }
                    }
                });
        }
        function findInputForSlices(sliceList){

            sendData = sliceList;
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:find_input_datasets' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var slices = $.evalJSON(data).data;
                        var slice;
                        for (slice in slices) {
                            var sliceName = "#inputDatasetSelect" + slice;
                            $(sliceName).html("");
                            for (var i=0;i<slices[slice].length;i++){
                                $(sliceName).append($('<option>', {
                                    value: slices[slice][i].dataset_name,
                                    text: slices[slice][i].dataset_name + " - " + slices[slice][i].events
                                }));
                                $(sliceName).show();
                            }
                            $("#inputDatasetSelectCount"+slice).html(slices[slice].length.toString())
                            if(slices[slice].length == 1){
                                $("#inputDatasetSelectCount"+slice).css({'color':'green'})
                            }else{
                                 $("#inputDatasetSelectCount"+slice).css({'color':'red'})
                            }
                        }
                    }
                });
              return false;
        };

        function prepareSliceInfo(check_steps,sliceID){
            changeMode = false;
                for(var i=0;i<check_steps.db_step_type.length;i++) {
                    {#                 console.log(i);#}
                    stepHasChanges = false;
                    currentTag =  $.trim($("#"+sliceID.toString() + 's' + i.toString()).val());
{#                    console.log(currentTag,check_steps.db_step_type[i].step_name);#}
                    if ((check_steps.db_step_type[i].step_name != "") || (currentTag != '')) {
                        if (currentTag != check_steps.db_step_type[i].step){
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').val(currentTag);
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').parent().css({'color': 'red'});
                           stepHasChanges = true;
                        }
                        else{
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').val(currentTag);
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').parent().css({'color': 'initial'});
                        }
                        for (fieldName in check_steps.db_step_type[i]) {
                            if ((fieldName != 'step_name')&&(fieldName != 'step')) {
                                {#                            console.log(check_steps.db_step_type[i][fieldName]);#}
                                {#                            console.log(fieldName);#}
                                notUpdateFromDB = false;
                                if (parseInt(sliceID) in changesList) {
                                    if (changesList[sliceID].stepsInSlice.length > i) {
                                        if (changesList[sliceID].getStepByNumber(i)[fieldName] != undefined) {
                                            if (changesList[sliceID].getStepByNumber(i)[fieldName] != check_steps.db_step_type[i][fieldName]) {
                                                notUpdateFromDB = true;
                                                $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).val(changesList[sliceID].getStepByNumber(i)[fieldName]);
                                                $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).parent().css({'color': 'red'});
                                                stepHasChanges = true;

                                            }
                                        }
                                    }
                                }
                                if (!notUpdateFromDB) {
                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).parent().css({'color': 'initial'});
                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).val(check_steps.db_step_type[i][fieldName]);
                                }
                            }

                        }
                    } else {
                        $('#sliceModal .storeOutput'+ i.toString()).each(function () {
                            $(this).val('');
                            $(this).parent().css({'color': 'initial'});
                        });
                    }
{#                    console.log(stepHasChanges);#}
                    currentHTML = $("#sectionName" + i.toString()).html()
                    if (stepHasChanges){

                              if (currentHTML.indexOf('*') == -1) {
                                  $("#sectionName" + i.toString()).html(currentHTML + '*');
                              }
                    }
                    else{
                                  newName = currentHTML.replace('*','');
                                 $("#sectionName" + i.toString()).html(newName);
                    }

                }
            console.log(check_steps);
            check_steps['is_eaqual'] = undefined;
            check_steps['db_step_type'] = undefined;
            for (sliceField in check_steps){
                notUpdateFromDB = false;
                if (parseInt(sliceID) in changesList) {
                    if (changesList[sliceID][sliceField]!= undefined) {
                            if (changesList[sliceID][sliceField] != check_steps[sliceField]) {
                                notUpdateFromDB = true;
                                $('#'+sliceField+'Modal').val(changesList[sliceID][sliceField]);
                                $('#'+sliceField+'Modal').parent().css({'color': 'red'});
                            }
                    }
                }
                if (!notUpdateFromDB) {
                   $('#'+sliceField+'Modal').parent().css({'color': 'initial'});
                   $('#'+sliceField+'Modal').val(check_steps[sliceField]);
                }
            }

            $('#sliceModalSlice').html(sliceID);
            $('#sliceModal').foundation('reveal', 'open');
            changeMode = true;
        }

        $(document).foundation();
        function formSliceInfo(event, id){
          event.preventDefault();
          var sliceID = id.slice(10);
          $("#sliceInfo").attr({'class':'small content f-dropdown'});
          $("#sliceInfo").html('');
          var check_steps = changeSliceSaveStatus(sliceID);
            $('#sliceModal').on('opened', function () {
              $(this).foundation('section', 'reflow');
            });
          prepareSliceInfo(check_steps,sliceID);
        }

        function saveOneSlice(event){
            event.preventDefault();
            var slices = [];
            var sliceID=$('#sliceModalSlice').html();
            slices.push(sliceID);
            approveSlices(false,99,slices);
        }
        function checkSliceIsSaved(sliceNumber){
            var is_equal = undefined;
            var step_types = undefined;
            var slice_data = {};
            $.ajaxSetup({async: false});
            $.get(Django.url('prodtask:slice_steps',"{{ pr_id }}",sliceNumber),function(data,status){
                step_types = data.step_types;
                slice_data['datasetName'] = data.dataset;
                slice_data['jobOption'] = data.jobOption;
                slice_data['eventsNumber'] = data.totalEvents;
                slice_data['comment']=data.comment;
                is_equal = true;
                var current_step_tag = [];
                for (var i=0;i<{{ step_list|length }};i++){
                    step_id = "#short" + sliceNumber + 's' + i.toString();
                    if ($(step_id).attr('class') == "notShowFullSpan" ){
                        current_step_tag.push({
                            step: $(step_id).children('a').html(),
                            step_type: 'foreign'
                        });

                    } else{

                            var current_type = '';
                            if ($(step_id).css("background-color") == $("#skippedColor").css("background-color")) {
                                current_type = 'is_skipped';
                            } else {
                                current_type = 'not_skipped';
                            }
                            current_step_tag.push({
                                step: $(step_id).html(),
                                step_type: current_type
                            });

                    }
                }

{#                if (step_types.length != current_step_tag.length){#}
{#                    is_equal = false;#}
{#                }#}
                for (var i=0;(i<step_types.length) ;i++){
                        no_changes = clearChanges(parseInt(sliceNumber),i,step_types[i]);

                        if (!(no_changes)){
                            is_equal = false;
                        }

                        if ((step_types[i].step != '') || (current_step_tag[i].step != '')){
                            if ((step_types[i].step != current_step_tag[i].step) || (step_types[i].step_type != current_step_tag[i].step_type) || !(no_changes)) {
                                is_equal = false;
                            }
                        }

                }
                is_equal = clearChangesSlice(parseInt(sliceNumber),slice_data);
            });
            $.ajaxSetup({async: true});
            console.log({is_equal:is_equal,db_step_type:step_types, datasetName:slice_data['datasetName'],comment:slice_data['comment'], jobOption:slice_data['jobOption'], eventsNumber: slice_data['eventsNumber'] });
            return {is_equal:is_equal,db_step_type:step_types, datasetName:slice_data['datasetName'],comment:slice_data['comment'], jobOption:slice_data['jobOption'], eventsNumber: slice_data['eventsNumber'] };
        }

        function clearChangesSlice(sliceNumber, sliceData){
            var no_changes = true;
{#            console.log(changesList[sliceNumber],sliceData)#}
            if (sliceNumber in changesList){
                for (var field in sliceData){

{#                    console.log(sliceData[field]);#}
                    if (field in changesList[sliceNumber]){
                        if (changesList[sliceNumber][field] != undefined){
                            if (changesList[sliceNumber][field] != sliceData[field]){
                                                        console.log(changesList[sliceNumber][field]);
                                console.log(sliceData[field]);
                                no_changes = false;
                            }else{
                                   changesList[sliceNumber][field] = undefined;
                               }
                        }
                    }
                }

            }
            return no_changes;
        }

        function clearChanges(sliceNumber,i,current_step){
            var no_changes = true;
            if (sliceNumber in changesList){
                if (changesList[sliceNumber].stepsInSlice.length > i){
{#                    console.log(current_step);#}
                    current_changes = changesList[sliceNumber].getStepByNumber(i);
                    for (fieldName in current_step){
                        if (fieldName in current_changes){
                            if (current_changes[fieldName] != undefined){
                               if  (current_changes[fieldName] != current_step[fieldName]){
                                   no_changes = false;
                               }else{
                                   current_changes[fieldName] = undefined;
                               }
                            }
                        }
                    }
                }
            }
            return no_changes;
        }

        function changeSliceSaveStatus(sliceNumber){
            sliceDBInfo = checkSliceIsSaved(sliceNumber);
            if (! sliceDBInfo.is_equal){
                $("#saveStatus"+sliceNumber).html("edit (not saved)");
            }else{
                $("#saveStatus"+sliceNumber).html("edit (saved)");
            }
            return sliceDBInfo;
        }
        function cloneRequest(event){
            event.preventDefault();
            var sliceList=[];
            if ($('#radioCloneAll').is(':checked')){
                $(".checkboxSlice").each(function(){
                    {#                   8 = "checkbox".length#}
                    var sliceID = $(this).attr("id").slice(8);
                    sliceList.push(sliceID);
                });
            }
            else{
                $(".checkboxSlice:checked").each(function(){
                    {#                   8 = "checkbox".length#}
                    var sliceID = $(this).attr("id").slice(8);
                    sliceList.push(sliceID);
                });
            }
            description = $('#newDescription').val();
            newRef = $('#newLink').val();
              var sendData = {slices:sliceList,description:description,ref:newRef};
             console.log(sendData);
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: Django.url('prodtask:request_clone2',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');


                       var newRequestID = $.evalJSON(data).new_request;
                       var is_good =  $.evalJSON(data).success;

                        if(is_good){
                           window.location.href = Django.url('prodtask:input_list_approve',newRequestID.toString());
                        }
                        }
                    }

                );
        }
        function cloneSlicesClick(event, makeLink, cloneFromStepNumber){
            event.preventDefault();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                sliceList.push(sliceID);
            });
            var sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: Django.url('prodtask:clone_slices_in_req',"{{ pr_id }}",cloneFromStepNumber,makeLink),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };
        function showModalClone(event){
            event.preventDefault();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                sliceList.push(sliceID);
            });
            $('#allClone').html('All'+'('+$('.checkboxSlice').length+')');
            $('#selectClone').html('Only selected'+'('+sliceList.length+')');
             $('#cloneModal').foundation('reveal', 'open');

        }

         function rejectSlicesClick(event){
            event.preventDefault();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                sliceList.push(sliceID);
            });
            sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:reject_slices_in_req' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };

         function hideClick(event){
            event.preventDefault();
            var sliceList=[];
            var i=0;
            $(".checkboxSlice:checked").each(function(){
                {#                   8 = "checkbox".length#}
                var sliceID = $(this).attr("id").slice(8);
                sliceList.push(sliceID);
            });
            sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:hide_slices_in_req' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };

        function closeDeftRef(event){
            event.preventDefault();
            sendData = {'close':true};
              $.ajax({
                    url: "{% url 'prodtask:close_deft_ref' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $('#closeDeftRef').css({'display':'none'});
                        $('#deftRef').css({'display':'none'});
                    }
              });
              return false;
        };

function spreadAMI(that){
    currentStep = $(that).attr("class").replace("storeInput",'').replace("step",'').replace(' ','').slice('storeOutput'.length).replace(' ','');
    currentSlice = $('#sliceModalSlice').html();
    $("#short"+currentSlice+"s"+currentStep).html($(that).val());
    $("#"+currentSlice+"s"+currentStep+".slice_form").val($(that).val());

}


        function showModalComment(event){
                event.preventDefault();
            $.ajaxSetup({async: false});
            $.get("{% url 'prodtask:request_comments' pr_id %}",function(data,status){
                $('#commentList').html('');
                var comments = data.comments;
                for (var i=0;i<comments.length;i++){
                    $('#commentList').prepend('<li>'+comments[i]+'</li>');
                }
            });
            $.ajaxSetup({async: true});
                $('#commentModalWindow').foundation('reveal', 'open');
            }

function changeSliceChanges(that){
    if(changeMode) {
        currentClass = $(that).attr("class").replace("storeInput", '').split(' ');
        $(that).parent().css({'color': 'red'});
        var currentStepNumber = '';
        var currentField = '';
        var isSliceData = false;
{#        console.log(that);#}
        for (i = 0; i < currentClass.length; i++) {
            if (currentClass[i] != '') {
                if (currentClass[i].lastIndexOf('storeOutputSlice', 0) === 0) {
                    isSliceData = true;
                }
                else if (currentClass[i].lastIndexOf('storeOutput', 0) === 0) {
                    currentStepNumber = currentClass[i].slice('storeOutput'.length);
                    currentHTML = $("#sectionName" + currentStepNumber).html();

                    if (currentHTML.indexOf('*') == -1) {
                        $("#sectionName" + currentStepNumber).html(currentHTML + '*');
                    }
                }
                else {
                    currentField = currentClass[i];
                }
            }
        }
        currentSlice = $('#sliceModalSlice').html();
        if (!(currentSlice in changesList)) {
            changesList[currentSlice] = new RequestSlice();
        }
        if (isSliceData) {
            changesList[currentSlice][currentField] = $(that).val();
            $('.change' + currentField + currentSlice.toString()).html(changesList[currentSlice][currentField]);
            if (currentField=='jobOption'){
                makeJobOptionURL();
            }
        } else {

            if (changesList[currentSlice].stepsInSlice.length < (parseInt(currentStepNumber) + 1)) {
                for (i = changesList[currentSlice].stepsInSlice.length; i < (parseInt(currentStepNumber) + 1); i++) {
                    var newStep = new ProcessingStep();
                    changesList[currentSlice].addStep(newStep);
                }
            }
            var currentChangeStep = changesList[currentSlice].getStepByNumber(parseInt(currentStepNumber));
            currentChangeStep[currentField] = $(that).val();
        }
        {#        console.log(currentChangeStep,currentField,$(that).val());#}
    }
};


function ProcessingStep() {
  this.step = undefined;
  this.ctag = undefined;
  this.output_formats = undefined;
  this.input_format = undefined;
  this.status = undefined;
  this.priority = undefined;
  this.memory = undefined;
  this.nEventsPerJob = undefined;
  this.nEventsPerInputFile = undefined;
  this.project_mode = undefined;
  this.token = undefined;
  this.position = undefined;
  this.status = undefined;
  this.input_events = undefined;
  this.merging_tag = undefined;
  this.nFilesPerMergeJob = undefined;
  this.nGBPerMergeJob = undefined;
  this.nMaxFilesPerMergeJob = undefined;
  this.nFilesPerJob = undefined;
};

 function RequestSlice(sliceNumber) {
    this.stepsInSlice = [];
    this.sliceNumber = sliceNumber;
    this.datasetName = undefined;
    this.jobOption = undefined;
    this.eventsNumber = undefined;
    this.comment = undefined;
};

RequestSlice.prototype.addStep = function(newStep){
      this.stepsInSlice.push(newStep);
};

RequestSlice.prototype.getStepByNumber = function(stepNumber){
  if( this.stepsInSlice.length > stepNumber){
      return this.stepsInSlice[stepNumber];
  } else {
      throw 'Wrong step number';
  }
};

var changesList = {};
var patternDict = [];
var changeMode = true;
var lastCheckedSlice = -1;
var lastChecked = true;
</script>

<div id="approveDialog" style="display: none">
    <span></span>
</div>
 <div id="problemDialog" title='Error' style="display: none">
    <span>Something has gone wrong!</span>
</div>
<div id="waitingDialog" title="Run" style="display: none">
  <p>Please wait...</p>
</div>
<div id="reloadDialog" title="Run" style="display: none">
  <p>Page reloading…</p>
</div>
<div class="row">
<div class="large-12">
<table>
<tr>
  <th></th>
  <th>Request ID:</th>
  <th>Description:</th>
  <th>Reference:</th>
  <th>Manager:</th>
  <th>Physic group:</th>
  <th>Project:</th>
  <th>Status:</th>
</tr>
<tr>
  <td><a href="#" data-dropdown="drop1" >&#9776;</a>
      <ul id="drop1" class="f-dropdown" data-dropdown-content>
        {% if user.is_authenticated %}
          <li><a href="{% url 'prodtask:request_update' pr_id %}">Update</a></li>
          <li><a href="#" onclick="showModalClone(event);">Clone</a></li>
          <li><a href="#" onclick="approveEmpty(event);">Approve</a></li>
        {% else %}
          <li><a href="{% url 'prodtask:login' %}?next={{ request.get_full_path|urlencode }}">Login</a></li>
        {% endif %}
    </ul>
  </td>
  <td>{{ trequest.reqid}}</td>
  <td>{{ trequest.description}}</td>
  <td><a href='{{trequest.ref_link}}' id='request_link'>{{ trequest.ref_link}}</a></td>
  <td><span id="ownerName">{{ trequest.manager}}</span><a class='button tiny btn_is_authenticated' onclick="makeUserOwner(event);">Me</a></td>
  <td>{{ trequest.phys_group}}</td>
  <td>{{ trequest.project}}</td>
{% if trequest.cstatus == 'registered' %}
      <td><span id="requestStatus">{{ trequest.cstatus}}</span> <a href="#" onclick="approveEmpty(event);" class="button btn_is_authenticated">Approve</a></td>
{% else %}
      <td><span id="requestStatus">{{ trequest.cstatus}}</span></td>
{% endif %}
</tr>
</table>
</div>
</div>

<div>
    <div class="row">
        <div class="large-5 column"><span>last comment: <span id="lastComment">{{ comment_author }}-{{ last_comment }}</span></span></div>
        <div class="large-2 column"><a class="button postfix" onclick="showModalComment(event);">New comment</a></div>
         <div class="large-5 column"></div>
    </div>
</div>
<div class="row">
<div class="large-12">
    <div>
    <a onclick="$('#longDescription').toggle('slow')" style="cursor: pointer;"><u>Show/hide long description</u></a>
    <div id="longDescription" style="display: none">{{ long_description|linebreaks}}</div>
    </div>
        {% if hidden_slices > 0 %}
    <h6> Total input: {{ totalSlice }}, from them approved: {{ approvedCount }} and hidden: {{ hidden_slices }}</h6>
{% else %}
    <h6> Total input: {{ totalSlice }}, from them approved: {{ approvedCount }}</h6>
{% endif %}
{% if approvedCount > 0 %}
{#    <u><a href="http://bigpanda.cern.ch/jobs/?jobsetid={{ pr_id }}" class="tiny secondary" >All jobs from request</a></u>#}
{% endif %}
<h6> With pattern: {{ pattern }}</h6>
<table style="padding: 0px;margin-bottom:0px;border: hidden">
<tr><td><button id="select_slice_checkobx" title="Select/unselect all" onclick="selectClick(event);">Select All</button></td>
    <td>Filter:</td><td><form><input type="text" id="filter" style="width: 500px"></form></td></tr>
</table>
{% if has_deft_problem %}
    <table>
    <tr>
    <td>
    <button class="btn_is_authenticated" id='closeDeftRef' onclick="closeDeftRef(event);">Remove</button>
    </td>
    <td>
        <div id="deftRef" class="alert-box alert round" ><strong >Error: </strong> <span> Some task can't be created by DEfT: </span>
    <a href="https://its.cern.ch/jira/browse/{{ jira_problem_link }}" target="_blank">{{ jira_problem_link }}</a></div>
    </td>
    </tr>
    </table>
{% endif %}
</div>
</div>
<div id="missing_tags" class="alert-box alert round" style="display: none"><strong >Error: </strong>
    <span> Please create these tags before approval: </span>
    <a href="http://panda.cern.ch/server/pandamon/query?mode=defNewTag" target="_blank"><span id="missing_tags_string"></span></a></div>
<div id="doubleTags" class="alert-box alert round" style="display: none"><strong >Error: </strong>
    <span> Please replace these old tags with double trf before approval: </span><span id="doubleTagsString"></span></div>
<div id="wrongSlice" class="alert-box alert round" style="display: none"><strong >Error: </strong>
<span> Check these slices: </span><span id="wrongSliceString"></span></div>

{% if show_as_huge %}
    <div>
    <div class="row" >
        <div class="large-12 column">Steps:</div>
    </div>
    <div class="row" >
        <div class="large-2 column">Total steps: {{ total_steps }} </div>
        <div class="large-3 column">steps approved: {{ approved_steps }} </div>
        <div class="large-8 column"></div>
    </div>
    <div class="row" >
        <div class="large-12 column">Tasks:</div>
    </div>
    <div class="row" >
        <div class="large-3 column"><span style="color: red">failed/broken/aborted {{ total_tasks.red }} </span></div>
        <div class="large-2 column"><span style="color: green">done {{ total_tasks.done }} </span> </div>
        <div class="large-2 column"><span style="color: green">finished {{ total_tasks.finished }} </span> </div>
        <div class="large-2 column"><span style="color: greenyellow">running {{ total_tasks.running }} </span> </div>
        <div class="large-2 column"><span style="color: blue">other states {{ total_tasks.blue }} </span> </div>
        <div class="large-1 column"> </div>
    </div>
    </div>

{% endif %}

<table style="margin-left: 50px;border: hidden" id="patternTable">
<tr>
    <th colspan="10">
        <select id="selectPattern" >
            <option value="" disabled selected>Select pattern</option>
            {% for pattern, steps in pattern_list %}
                <option value="{{ pattern }}">{{ pattern }}</option>
            {% endfor %}
        </select>
    </th>
    <th >
        <td><button id="showPattern" title="Show current pattern" onclick="showPatternClick(event);">Show</button></td>
    </th>
    <th >
        <td><button class="btn_is_authenticated" id="bind" title="Create step execution" onclick="bindClick(event);">Bind</button></td>
    </th>

</tr>
<tr>
{% for step in step_list %}
        <th class="stepchoose" id="startStep{{ forloop.counter0 }}"  > <div > {{step.name}}</div></th>
{% endfor %}
</tr>
    <tr>
        {% for step in step_list %}
            <td style="padding: 0px;width: 50px">
            <form><input type="text" class="patternForm"  id="patternform{{forloop.counter0}}" value=""/></form>
            </td>
        {% endfor %}
          <td colspan="4">
              <label> Replace empty
                <input type="checkbox" id="replaceByPattern"  />
              </label>
          </td>
    </tr>
</table>

<div id="sliceInfo" class="small content f-dropdown" data-dropdown-content>
     <strong>Slice:</strong>
</div>

    <div >
    {% for inputList, step_exec_dict, approved, show_task, foreignStepID, approveLevel, cloned  in inputLists %}
        <div class="inputListDivs" id="inputList_div{{ inputList.slice }}">

        <table class="outsideInputListTables" id="outsideInputListTables{{ inputList.slice }}"><tr>
            <td style="width: 29px;padding:0px;margin:0px"><form ><input  type="checkbox" class="checkboxSlice" id="checkbox{{ inputList.slice }}" onclick='checkSlice(event);' checked></form></td>
            <td style="padding:0px;margin:0px">
            <table class="inputListTables" >
            <tr class="inputListRow">
                <td style="width: 20px" ><a name="inputList{{ inputList.slice }}">{{ inputList.slice }}</a></td>
                {% if  not_use_input_date_for_pattern %}
                    <td colspan="10" style="width: 500px" >
                        <span class="showFullSpan changedatasetName{{ inputList.slice }}" id="inputDatasetName{{ inputList.slice }}" style="padding:0px" title="{{ inputList.dataset }}">
                            {{ inputList.dataset }}
                        </span>
                    </td>
                    <td colspan="2"><a href=""  id="sliceInputJobOptions{{ inputList.slice }}" class="changejobOption{{ inputList.slice }} makeJOUrl "  target="_blank" title="{{ inputList.input_data }}">{{ inputList.input_data }}</a></td>
                    {% if cloned != 'no' %}
                        <td><a href="#inputList{{ cloned }}" style="color: red"><u>Cloned</u></a></td>

                    {% else %}
                        <td></td>
                    {% endif %}
                {% else %}
                    <td colspan="10" style="width: 500px" >
                        <span class="showFullSpan">+ </span><a href='' class='changejobOption{{ inputList.slice }} makeJOUrl' target="_blank" style="padding:0px" id="sliceInputJobOptions{{ inputList.slice }}" title="{{ inputList.input_data }}">
                            {{ inputList.input_data}}
                        </a>
                    </td>
                    <td  colspan="2"><span class="changedatasetName{{ inputList.slice }}" id="inputDatasetName{{ inputList.slice }}">{{ inputList.dataset }}</span></td>
                    <td></td>
                {% endif %}
{#                <td>{{ inputList.brief }}</td>#}

            </tr>
            {% if  not not_use_input_date_for_pattern %}
              <tr>
                    <td colspan="11" style="width: 500px" >
                        <span class="showFullSpan changecomment{{ inputList.slice }}" style="padding:0px" title="{{ inputList.comment }}">
                            {{ inputList.comment }}
                        </span>
                    </td>
                    <td colspan="2" >events: <span  class="changeeventsNumber{{ inputList.slice }}">{{ inputList.input_events }}</span></td>
                   {% if cloned != 'no' %}
                        <td><a href="#inputList{{ cloned }}" style="color: red"><u>Cloned</u></a></td>

                    {% else %}
                        <td></td>
                    {% endif %}
              </tr>
            {% endif %}
            <tr>
                <td colspan="11" style="width: 500px" >
                    <select id="inputDatasetSelect{{ inputList.slice }}" style="display: none">

                    </select>
                </td>
                <td colspan="2"><strong id="inputDatasetSelectCount{{ inputList.slice }}"></strong></td><td></td>
            </tr>

            <tr class="inputListRow">
                <td style="width: 20px"> </td>
                {% for step in step_exec_dict %}
                        {% ifequal step.skipped 'foreign' %}
                        <td class="notShowFullSpan" id="short{{ inputList.slice }}s{{ forloop.counter0 }}"
                            style="font-size:12px;width:50px;padding:0px;border:1px solid black"><a href="#inputList{{ step.slice }}">{{ step.tag }}</a><span class="foreignStepID" style="display: none">{{ foreignStepID }}</span></td>
                        {% else %}
                        <td class="showFullSpan" id="short{{ inputList.slice }}s{{ forloop.counter0 }}"
                            style="font-size:12px;width:50px;padding:0px;border:1px solid black">{{ step.tag }}</td>
                        {% endifequal %}
                {% endfor %}

                    <td colspan="2" id="aprroveLabel{{ inputList.slice }}" class="{{ approved }}" style="width: 8em;text-align:center">{{ approved }}</td><td>
                       <u> <a href="#" id="saveStatus{{ inputList.slice }}" onclick="formSliceInfo(event, this.id);" data-options="is_hover:true" >
                            edit (saved)
                        </a></u></td>

            {% if show_task %}
                        <tr>
                        <td>T:</td>

                        {% for step in step_exec_dict %}
                        {% if step.tasks|length == 1 %}
                        {% for task in step.tasks %}
                        {% if task %}

                        <td  style="padding: 0px;width: 50px;border:1px solid black" class="{{ task.status }}" >
                            <div>
                               <a  href="http://bigpanda.cern.ch/task/{{ task.id }}"><span style="color: #000000">{{ task.short }}</span></a>
                            </div>
                        </td>
                        {% else %}
                            <td  style="padding: 0px;width: 50px;border:1px solid black" ></td>
                        {% endif %}
                        {% endfor %}

                        {% else %}
                        <td style="padding:0px;margin:0px">
                        <table style="padding:0px;margin:0px">
                        {% for task in step.tasks %}
                        {% if task %}

                        <tr style="padding:0px;margin:0px;height: 20px">
                        <td  style="padding: 0px;width: 50px;border:1px solid black" class="{{ task.status }}" >
                            <div>
                               <a  href="http://bigpanda.cern.ch/task/{{ task.id }}"><span style="color: #000000">{{ task.short }}</span></a>
                            </div>
                        </td>
                        {% else %}
                            <td  style="padding: 0px;width: 50px;border:1px solid black" ></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        </table>
                        </td>
                        {% endif %}
                        {% endfor %}
                        <td colspan="3"></td>
                        </tr>
            {% endif%}
            </tr>
            </table>
            <table class="inputListTablesLong" style="display: none">
                <tr><td style="width: 20px" class='showSmallSpan' >{{ inputList.slice }}</td>
                 <td colspan="11" class='showSmallSpan'>Dataset: <span class="changedatasetName{{ inputList.slice }} filterField">{{ inputList.dataset }}</span></td></tr>
                <tr><td></td><td colspan="11" >JobOption: <a href='' target="_blank" class="changejobOption{{ inputList.slice }} filterField makeJOUrl">{{ inputList.input_data }}</a></td></tr>
                <tr><td></td><td colspan="11">Brief: <span class="filterField">{{ inputList.brief }}</span></td></tr>
                <tr><td></td><td colspan="11">Comment: <span class=" changecomment{{ inputList.slice }} filterField">{{ inputList.comment }}</span></td></tr>
                <tr><td></td><td colspan="3">Priority: {{ inputList.priority }}</td><td colspan="8">Input events: <span class="changeeventsNumber{{ inputList.slice }}">{{ inputList.input_events }}</span></td></tr>
                <tr style="display: none"><td></td><td colspan="9">
                    <select id="selectPattern" >
                        <option value="" disabled selected>Select pattern</option>
                        {% for pattern in pattern_list %}
                            <option value="{{ pattern }}">{{ pattern }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><button id="bind{{ inputList.slice }}" class="slice_bind btn_is_authenticated" title="Create step execution">Bind</button></td>
                <td><button class="btn_is_authenticated" id="approveButton{{ inputList.slice }}" title="Approve">Approve</button></td>
                <tr>
                {% if show_task %}
                        <tr><td></td><td colspan="11">Tasks:</td></tr>
                        {% for step in step_exec_dict %}
                        {% for task in step.tasks %}
                        {% if task %}
                            <tr><td></td>
                            <td colspan="2"><a href="{% url 'prodtask:task' task.id %}">{{ task.id }}</a></td>
                            <td colspan="2" ><span class="{{ task.status }}" >{{ task.status }}</span></td>
                            <td colspan="7">{{ task.name }}</td>
                            </tr>
                            <tr class="bottom_row_task"><td></td><td colspan="4">timestamp:{{ task.timestamp }}
                                                                </td>
                            <td colspan="5" >
                                <a href="http://bigpanda.cern.ch/jobs/?jeditaskid={{task.id }}">
                                    <u>Jobs: {{ task.total_done_jobs }}/{{ task.total_req_jobs }}</u>
                                </a>
                            </td>
                            <td colspan="4">bug: {{ task.bug_report }}</td>
                            </tr>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}

                {% else %}
                    <th rowspan="2"></th>
                    {% for step in step_list %}
                            <th class="stepchoose" id="step{{ inputList.slice }}s{{ forloop.counter0 }}" > {{step.name}}</th>
                    {% endfor %}

                        <th rowspan="2" id="aprroveLabelLong{{ inputList.slice }}" class="{{ approved }}"> {{ approved }} </th>

                    </tr>
                        <tr style="padding: 0px">
                        {% for step in step_exec_dict %}
                            <td  style="padding: 0px;width: 50px" >
                                <div  >
                                    <form><input type="text" onchange="longFormChange(event)" class="slice_form" id="{{ inputList.slice }}s{{ forloop.counter0 }}"  value="{{ step.tag }}" style="padding: 0px"></form>
                                </div>
                            </td>
                        {% endfor %}
                        </tr>
                {% endif %}
            </table>
        </td>
        </tr></table>
        </div>
	{% endfor %}
    </div>

 <strong class="hiddenNonEdit">Work with selected slices:</strong>
 <form>
    <div class="row collapse hiddenNonEdit">

                {% if not user.is_authenticated %}
                    <a class="small radio button success"
                       href="{% url 'prodtask:login' %}?next={{ request.get_full_path|urlencode }}"
                    >Login</a>
                {% endif %}

            <button class="btn_is_authenticated" id="saveButton" title="Save selected slices without approval" onclick="approveClick(event,false,'-1');">Save</button>
            <button class="btn_is_authenticated" id="approveButton" title="Approve selected slices" onclick="approveClick(event,true,'99');">Approve</button>
            <button class="btn_is_authenticated" title="Clone slices" onclick="cloneSlicesClick(event,'0',-1);">Clone </button>
            <button class="btn_is_authenticated"  title="Fix slices" href="#" data-dropdown="dropCloneMenu">Fix </button>
            <button class="btn_is_authenticated" id="rejectSlice" title="Reject slices, if tasks are not started yet" onclick="rejectSlicesClick(event);">Reject </button>
            <button class="btn_is_authenticated" id="hideButton" title="Hide slices from request page" onclick="hideClick(event);">Hide</button>
            <button class="btn_is_authenticated" id="checkInputButton" title="Find input data for skipped steps" onclick="findInputClick(event);">Find input</button>


        <div id="dropCloneMenu" class="f-dropdown content" data-dropdown-content>
                <div class="row">
                    <label> Clone from step:
                    <select id="cloneFromStep" >
                    <option value="-1">all</option>
                    {% for step in step_list %}
                            <option value="{{forloop.counter0}}">{{ step.name }}</option>
                    {% endfor %}
                    </select>
                    </label>
                </div>
             <div class="row">
                 <button id="cloneSlice" class="btn_is_authenticated" title="Clone slices" onclick="cloneSlicesClick(event,'1',$('#cloneFromStep').val());">Fix</button>
             </div>
        </div>

    </div>
    <div class="row">
    <div class="large-7 columns">
    <div class="row collapse ">
                <div class="large-5 columns">
                    <a href="#" class="button prefix btn_is_authenticated"  onclick="approveClick(event,true,$('#approveToInput').val());">Approve only steps before:</a>
                </div>

                <div class="large-1 columns">
                    <select id="approveToInput" >
                    {% for step in step_list %}
                        {% if forloop.counter0 > 0 %}
                            <option value="{{forloop.counter0}}">{{ step.name }}</option>
                        {% endif %}
                    {% endfor %}
                    </select>
                </div>
                <div class="large-1 columns">&nbsp;</div>
    </div>
    </div>
    </div>
 </form>
{#<button id="approveEvgenButton" title="Approve evgen in selected slices" onclick="approveClick(event,true,true);">Approve Evgen</button>#}

{% if not show_as_huge %}
<form>
    <div class="row">
        <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>AMITag:formats
                        <select id="tagFormatSelect">

                        </select>
                    </label>
                </div>
                <div class="large-2 columns">
                  <a href="#" class="button postfix" onclick="refreshTagFormats(event)">Refresh</a>
                </div>
            </div>
        </div>
    </div>
     <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>Input events number
                        <input type="number" placeholder="input_events" id="input_events_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
     <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>Priority
                        <input type="number" placeholder="priority" id="priority_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
    <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>Project mode
                        <input type="text" placeholder="project_mode" id="project_mode_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
    <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>nEventsPerJob
                        <input type="number" placeholder="nEventsPerJob" id="nEventsPerJob_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
    <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>nEventsPerInputFile
                        <input type="number" placeholder="nEventsPerInputFile" id="nEventsPerInputFile_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
       <div class="row">
       <div class="large-8 columns">
            <div class="row collapse">
                <div class="large-10 columns">
                    <label>Destination token
                        <input type="text" placeholder="Destination token" id="destination_input">
                    </label>
                </div>
            </div>
       </div>
    </div>
     <div class="row">
       <div class="large-2 columns">
            <a href="#" class="button postfix btn_is_authenticated" id="updateStepParams" onclick="updateStepParametrs(event)">Update</a>
       </div>
    </div>
</form>
{% endif %}
{#<div id="sliceModal" class="reveal-modal" data-reveal>#}
{#  <h2 id="sliceNumberModal"></h2>#}
{#  <dl class="tabs" data-tab>#}
{#        {% for step in step_list %}#}
{#            <dd><a href="#panel{{forloop.counter0}}">{{step.name}}</a></dd>#}
{#        {% endfor %}#}
{#  </dl>#}
{#    <div class="tabs-content">#}
{#         {% for step in step_list %}#}
{#             <div class="content" id="panel{{forloop.counter0}}">#}
{#                <p>This is the {{forloop.counter0}} panel of the basic tab example.</p>#}
{#            </div>#}
{#        {% endfor %}#}
{#    </div>#}
{#  <a class="close-reveal-modal">&#215;</a>#}
{#</div>#}

<div id="patternModal" class="reveal-modal" data-reveal>
  <ul id="patternModalBody">
  </ul>
  <a id='closeReveal' class="close-reveal-modal" >&#215;</a>
</div>

<div id="cloneModal" class="reveal-modal" data-reveal>
    <p>Request: {{  trequest.reqid }}<br/>
    <p>Old description: {{  trequest.description }}<br/>
    <label> New description:
        <input type="text" id="newDescription" placeholder=" "   />
    </label>
    <p>Old link: {{  trequest.ref_link }}<br/>
    <label> New link:
        <input type="text" id="newLink" placeholder=" "   />
    </label>
      <label for="radioClone"><input name="radioClone" type="radio" id="radioCloneAll"  CHECKED><span class="custom radio checked"></span><span id='allClone'>All</span></label>
      <label for="radioClone"><input name="radioClone" type="radio" id="radioCloneSelect" ><span class="custom radio"></span > <span id='selectClone'>Selected</span></label>
    <button id="cloneRequestButton" title="clone request" onclick="cloneRequest(event);$('#closeCloneReveal').click()">Clone request</button>
<a id='closeCloneReveal' class="close-reveal-modal" >&#215;</a>
</div>


<div id="sliceModal" class="reveal-modal" data-reveal>
<p>Slice: <span id="sliceModalSlice"></span><br/>
    <div>
    <div class="row">
        <div class="column large-12">
            <label> Dataset: <input id='datasetNameModal' type="text" class="datasetName storeOutputSlice  storeInput" placeholder=" "  /></label>
        </div>
    </div>
    <div class="row">
        <div class="column large-9">
            <label> job options: <input id="jobOptionModal" type="text" class="jobOption storeOutputSlice storeInput" placeholder=" "  /></label>
        </div>
        <div class="column large-3">
            <label> Input events: <input id='eventsNumberModal' type="number" class="eventsNumber storeOutputSlice storeInput"  placeholder="-1"  /></label>
        </div>
    </div>
    <div class="row">
        <div class="column large-12">
            <label> Comment: <input id="commentModal" type="text" class="comment storeOutputSlice storeInput" placeholder=" "  /></label>
        </div>
    </div>
    </div>

<div>
<div class="section-container auto" id="sliceInfoContainer" data-section>
        {% for step in step_list %}
               {% if  forloop.counter0 == 0%}

                <section class="active">
                   {% else %}
                   <section>
                {% endif %}
                 <p class="title" data-section-title><a href="#" id="sectionName{{forloop.counter0}}">{{step.name}}</a></p>
                    <div class="content" data-section-content>
                        <fieldset>
                        <div class="row">
                                <div class="large-3 columns">
                                  <label> AMI tag
                                    <input type="text" class="step storeOutput{{forloop.counter0}} storeInput" placeholder=" " onchange="spreadAMI(this);"  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>Events per Input file
                                    <input type="number" class="nEventsPerInputFile storeOutput{{forloop.counter0}} storeInput"  placeholder=""  />
                                  </label>

                                </div>
                                 <div class="large-2 columns">
                                  <label>Events per job
                                    <input type="number" class="nEventsPerJob storeOutput{{forloop.counter0}} storeInput"  placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>Total events
                                    <input type="number" class="input_events storeOutput{{forloop.counter0}} storeInput" placeholder="-1"  />
                                  </label>
                                </div>
                               </div>
                               <div class="row">
                                <div class="large-2 columns">
                                  <label>Files per job
                                    <input type="number" class="nFilesPerJob storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>nGB per job
                                    <input type="number" class="nGBPerJob storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                <div class="large-2 columns">
                                  <label>max attempt
                                    <input type="number" class="maxAttempt storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                </div>
                                <div class="row">
                                <div class="large-5 columns">
                                  <label>Output formats
                                    <input type="text" class="output_formats storeOutput{{forloop.counter0}} storeInput" placeholder=" "  />
                                  </label>
                                </div>

                                 <div class="large-5 columns">
                                  <label>Input format
                                    <input type="text" class="input_format storeOutput{{forloop.counter0}} storeInput" placeholder=" "  />
                                  </label>
                                </div>
                                 </div>
                                <div class="row">
                                <div class="large-9 columns">
                                  <label>project mode
                                    <input type="text" class="project_mode storeOutput{{forloop.counter0}} storeInput" placeholder=" " />
                                  </label>
                                </div>
                                <div class="large-3 columns">
                                  <label>Priority
                                    <input type="number" class="priority storeOutput{{forloop.counter0}} storeInput" placeholder=" " />
                                  </label>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-12 columns">
                                  <label>Destination
                                    <input type="text" class="token storeOutput{{forloop.counter0}} storeInput" placeholder=" " />
                                  </label>
                                </div>
                              </div>
                                <div class="row">
                                <div class="large-12 columns">
                                  <strong>JEDI internal merging:
                                  </strong>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-3 columns">
                                  <label>merging tag
                                    <input type="text" class="merging_tag storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                 <div class="large-3 columns">
                                  <label>nFilesPerMergeJob
                                    <input type="number" class="nFilesPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                  <div class="large-3 columns">
                                  <label>nGBPerMergeJob
                                    <input type="number" class="nGBPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                 <div class="large-3 columns">
                                  <label>nMaxFilesPerMergeJob
                                    <input type="number" class="nMaxFilesPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                  </div>
                              </div>
                            </fieldset>
                    </div>
            </section>
        {% endfor %}

</div>
</div>
   <button id="saveButton" class="btn_is_authenticated" title="Save selected slice without approval" onclick="saveOneSlice(event);$('#closeReveal').click()">Save</button>
  <a id='closeReveal' class="close-reveal-modal" onclick="changeSliceSaveStatus($('#sliceModalSlice').html());">&#215;</a>
</div>

<div id="commentModalWindow" class="reveal-modal" data-reveal>
    <h3>Comments:</h3>
    <div class="row">
            <div class="large-4 column">
                <label>{{ request.user.username }}:
                <textarea  id="newComment"  maxlength="250"  ></textarea></label>
            </div>
            <div class="large-1 column">
                <a href='#' class="button btn_is_authorized postfix" onclick="addComment(event);">Add</a>
            </div>
            <div class="large-7 column"></div>
        </div>

    <ul id="commentList">

    </ul>
  <a  class="close-reveal-modal">&#215;</a>
</div>

{% if hidden_slices > 0 %}
    <a href= "{% url 'prodtask:input_list_approve_full' pr_id %}">Show {{ hidden_slices }} hidden slices </a>
    <p/>

{% endif %}
{% if show_is_fast %}
    <a href="#" class="tiny secondary" onclick="chnageRequestToFast(event);">Start tasks without delay</a>
    {% if trequest.is_fast %}
        <span id="isFast"> :Yes</span>
    {% else %}
        <span id="isFast"> :No</span>
    {% endif %}
{% endif %}
    <p/>
    <a href="#" class="tiny secondary" onclick="chnageStatusToTest(event);">Make as test</a>
{% endblock %}