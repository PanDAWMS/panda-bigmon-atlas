{% extends parent_template %}
{% load i18n %}

{% load static from staticfiles %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block bl_title %}Core App of Monitoring{% endblock %}

{% block subtitle %}
{{pre_form_text|safe}}
{% endblock %}

{% block extra_css %}
{{ block.super }}
	<style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
        @import "{% static "css/jquery.dataTables_themeroller.css" %}";
        @import "{% static "css/font-awesome.min.css" %}";
        @import "{% static "css/prodtask.css" %}";

    </style>
   <style type="text/css">

 	span.obsolete	{ color : lightblue;}
	span.holding 	{ color : black;	}
	span.pending	{ color : blue;		}
	span.waiting	{ color : blue;	}
	span.submitting	{ color : blue;	}
	span.archived 	{ color : magenta;	}
 	span.submitted	{ color : green;	}

	span.running 	{ color : LightGreen;	}

	span.done 		{ color : darkgreen;	}
	span.finished	{ color : darkgreen;	}

	span.failures	{ color : orange;	}

	span.failed 	{ color : red;	}
	span.aborted 	{ color : red;	}
	span.broken		{ color : red;	}

	span.navy		{ color : blue; }
    span.registered { color : blue;}
  </style>
   <style type="text/css">
 	td.obsolete	{ background-color : lightblue;}
	td.holding 	{ background-color : black;	}
	td.pending	{ background-color : blue;		}
	td.waiting	{ background-color : blue;	}
	td.submitting	{ background-color : blue;	}
	td.archived 	{ background-color : magenta;	}


	td.running 	{ background-color : LightGreen;	}

	td.done 		{ background-color : darkgreen;	}
	td.finished.full_finished	{ background-color : darkgreen;	}
    td.finished.finished60  { background-color : papayawhip;	}
    td.finished.finished80  { background-color : olive;	}
    td.finished.finished90  { background-color : darkgreen;	}
    span.full_finished { color : black;	}
	span.finished60 { color : red;	}
    span.finished80 { color : orange;	}
    span.finished90 { color : floralwhite;	}
    td.failures	{ background-color : orange;	}

	td.failed 	{ background-color : red;	}
	td.aborted 	{ background-color : red;	}
	td.broken		{ background-color : red;	}

	td.navy		{ background-color : blue; }
    td.registered { background-color : blue;}
    td.action.active { background-color : blueviolet;}
    td.action.executing { background-color : blueviolet;}
    td.action.failed { background-color : red;}
  </style>

   <style>
    tr.bottom_row_task td {border-bottom: 1px solid black;}
   </style>
   <style>
    tr.CurrentCampaign  {border: 2px solid green;}
   </style>

    <style>
    td.submitted { color : green;	}
    td.not_submitted { color : red;}
    td.partially_submitted { color : orange;	}
    td.submitted.original { background-color: indianred; color : black;	}
    td.not_submitted.original {background-color: indianred; color : black;	}
    td.partially_submitted.original { background-color: indianred; color : black;		}

    span.hidden { color : #463cff;	}

   </style>

{% endblock %}

{% block base_js %}
{{ block.super }}

<script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript" src="{% static "js/jquery.cookie.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.json-2.4.min.js" %}"></script>
<script type="text/javascript" src="{% static 'js/foundation.js' %}"></script>
<script type="text/javascript" src="{% static 'js/spin.min.js' %}"></script>
<script type="text/javascript" src="{% static "js/prodtask.js" %}"></script>


{% endblock %}


{% block body %}
<!-- TODO: Replace next tables by independet from field objects   -->

<div style="display:none">
    <input type="hidden" id="doColor" />
    <input type="hidden" id="skippedColor" />
    <input type="hidden" id="foreignColor" />
</div>
<script>


var step_bc=["#FFB734","#FFFFFF","#ffff00"];
$("#doColor").css({'background-color':step_bc[0]});
$("#skippedColor").css({'background-color':step_bc[1]});
$("#foreignColor").css({'background-color':step_bc[2]});

$.fn.mirror = function (selector) {
    return this.each(function () {
        var $this = $(this);
        var $selector = $(selector);
        $this.bind('keyup', function () {
            $selector.val(($this.val()));
        });
    });
};
$(document).ready(function(){
var temp_ref_link = '{{ trequest.ref_link}}';
$('#request_link').html(temp_ref_link.slice(temp_ref_link.lastIndexOf('/')+1,temp_ref_link.length));
{% if not edit_mode %}
    $("#patternTable").hide();
    $("#approveButton").hide();
    $("#saveButton").hide();
    $("#saveButtonSlice").hide();
    $("#approveEvgenButton").hide();
    $(".hiddenNonEdit").hide();
    $("#updateStepParams").hide();
{% endif %}
 $("#filter").keyup(function(){changeStatusFilter()});
var slices_changes = {};
changeSliceOrder();
    {% if not user.is_authenticated %}
      $(".btn_is_authenticated").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
      $(".btn_is_authorized").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
    {% endif %}

    {% if not autorized_change_request %}
      $(".btn_is_authenticated").each(function(){
          this.disabled=true;
          $(this).attr('onclick','');
          $(this).addClass('disabled')});
    {% endif %}

$(".stepchoose").css({"font-size": "12px","width": "50px","padding":"0px","border": "1px solid black",
                         "cursor":"pointer","user-select": "none"});
$(".inputListRow").children("td").css({"padding":"1px"})
$(".inputListTables.noSliceError").css({"border": "1px solid black","margin": "1px"})
    $(".inputListTables.sliceError").css({"border": "3px solid red","margin": "1px"})

$(".outsideInputListTables").css({"border": "hidden","margin": "1px"})
$(".showFullSpan").css({"cursor":"pointer","user-select":"none"});
$(".showTasksInSlice").css({"cursor":"pointer","user-select":"none"});
$(".showSmallSpan").css({"cursor":"pointer"});

{#Color pattern steps#}
 {% for step in step_list %}
    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});
     $("#bstartStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});
     $("#patternform{{ forloop.counter0 }}").mirror("#bpatternform{{ forloop.counter0 }}");
     $("#bpatternform{{ forloop.counter0 }}").mirror("#patternform{{ forloop.counter0 }}");

 {% endfor %}
$('#chooseStepBulk').change(function(){changeStepBulk();});
$('#amitagBulkSelect').change(function(){clickAmiStepBulk();});
$('#radioSetStepBulk').change(function(){changeStepBulk();});
 $(".selectPattern").change(function(){
     $('.selectPattern').val($(this).val());
    {% for pattern, steps  in pattern_list %}
        if ($(this).val() == "{{ pattern }}"){
            {% for step, fields in steps %}
                $("#patternform{{forloop.counter0}}").val("{{ step }}");
                $("#bpatternform{{forloop.counter0}}").val("{{ step }}");

                if("{{ step }}" != ""){
                    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});
                    $("#bstartStep{{ forloop.counter0 }}").css({"background-color":$("#doColor").css("background-color")});

                } else{
                    $("#startStep{{ forloop.counter0 }}").css({"background-color":$("#skippedColor").css("background-color")});
                    $("#bstartStep{{ forloop.counter0 }}").css({"background-color":$("#skippedColor").css("background-color")});

                }
                i = {{  forloop.counter0 }};
                    {% for field_name, field_value in fields %}
                        patternDict[i]['{{ field_name }}']='{{ field_value }}';

                    {% endfor %}
            {% endfor %}
        }
    {% endfor %}
});
{#$('.replaceEmptyCeckboxes').change(function(){$('.replaceEmptyCeckboxes').attr('checked',$(this).is(':checked'));})#}


    $(".stepchoose").click(function(){
        var currentColor = $(this).css("background-color");
        var currentIndex = (step_bc.indexOf(currentColor)+1)%2;
        $(this).css({"background-color":step_bc[currentIndex]});
        step_bc[currentIndex] =  $(this).css("background-color");
        if($(this).attr("id").substr(0,4) === 'step'){
            var step_td_short = "td#short".concat($(this).attr("id").substr(4)).concat(".showFullSpan");
            $(step_td_short).css({"background-color":step_bc[currentIndex]});
        }
        if($(this).attr("id").substr(0,4) === 'star'){
            $('#b'+$(this).attr("id")).css({"background-color":step_bc[currentIndex]});
        }
        if($(this).attr("id").substr(0,4) === 'bsta'){
            $('#'+$(this).attr("id").substr(1)).css({"background-color":step_bc[currentIndex]});
        }
    })  ;
    {#    replace hide/show on dynamic creation#}
    $(".showFullSpan").click(function(event){


        realID = $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").attr('id');

        preparedID = 'saveStatus'+realID.slice('outsideInputListTables'.length);
        return formSliceInfo(event,preparedID);
    });

    $(".showTasksInSlice").click(function(event){
        var sliceList=[];
        var oldID = $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").attr('id');
        sliceList.push(oldID.slice("outsideInputListTables".length));
        return showTasksFromSlices(sliceList);
    });


    {#Fill pattern table#}
    (function(){
       {% for inputList, step_exec_dict, approved, show_task, show_action, foreignStepID, approve_level, cloned, is_waiting,  slice_output,slice_output_full,real_events, total_events  in inputLists %}
           {% for step in step_exec_dict %}
                        {% ifequal step.skipped 'skipped' %}
                            var stepColor = $("#skippedColor").css("background-color");
                        {% endifequal %}
                        {% ifequal step.skipped 'run' %}
                            var stepColor = $("#doColor").css("background-color");
                        {% endifequal %}
                        {% ifequal step.skipped 'foreign' %}
                            var stepColor = $("#foreignColor").css("background-color");
                        {% endifequal %}
                        {% if  forloop.counter0 < approve_level %}
                            var borderColor = 'green';
                        {%  else  %}
                            {% if  is_waiting %}
                                var borderColor = 'blue';
                            {%  else  %}
                                var borderColor = 'grey';
                            {% endif  %}
                        {% endif  %}
                        $("#short{{ inputList.slice }}s{{ forloop.counter0 }}.showFullSpan").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});
                        $("#short{{ inputList.slice }}s{{ forloop.counter0 }}.notShowFullSpan").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});
                        $("#step{{ inputList.slice }}s{{ forloop.counter0 }}.stepchoose").css({"background-color":stepColor,
                            "border":'solid',
                        "border-color":borderColor});


           {% endfor %}

       {% endfor %}
         {% for step in step_list %}
            patternDict.push({});
            {% endfor %}
    })();
    (function(){
            $('.storeInput').bind('change',function(){changeSliceChanges(this);});
           $('.hashtags').attr('href',construct_django_url('/prodtask/request_hashtags_outputs/', '{{ hashtags_path }}'));

    })();
    (function(){
            $('.sliceSplit').each(function(){
                if($(this).html().endsWith('split')){
                    splitSlices.push($(this).attr("id").slice('sliceSplit'.length));
                }
            })
        })();

    (function(){
            $('.taskStatus').each(function(){
                if (!NOTRUNNING.includes($(this).html())){
                        var currentID = $(this).attr("id");
                        var slice = currentID.slice(currentID.indexOf('ts')+2);
                        $('#taskStatusFilter'+slice).html('running');
                } else{
                        var currentID = $(this).attr("id");
                        var slice = currentID.slice(currentID.indexOf('ts')+2);
                        if ($('#taskStatusFilter'+slice).html()!='running'){
                            $('#taskStatusFilter'+slice).html('No running');
                        }

                }
                if(REDTASKSTATUS.includes($(this).html())){
                    var currentID = $(this).attr("id");
                    var slice = currentID.slice(currentID.indexOf('ts')+2);
                    $('#redTaskFilter'+slice).html('exists');
                }
                if($(this).html() === 'exhausted'){
                    var currentID = $(this).attr("id");
                    var slice = currentID.slice(currentID.indexOf('ts')+2);
                    $('#exhTaskFilter'+slice).html('exists');
                }



            })
        })();
        (function(){
            $('.actionStatus').each(function(){
                        var currentID = $(this).attr("id");
                        var slice = currentID.slice(currentID.indexOf('as')+2);
                        $('#actionStatusFilter'+slice).html('exists');



            })
        })();
    (function(){
            $('.sliceOrigin').each(function(){
                if($(this).html().endsWith('original')){
                    $(this).attr("style",'');
                }
            })
        })();
    (function(){
            $('.managementPriority').each(function(){
                var priority = $(this).attr("id").slice('managementPriorityChange'.length);
                $(this).val(priority);

            })
        })();
    (function(){
            $('.storeBulk').bind('change',function(){saveBulkStepChanges(this);});
        })();
    (function(){
            $('.storeSliceBulk').bind('change',function(){saveBulkSliceChanges(this);});
        })();

    (function(){
           $(".actionProgressBar").each(function(){$(this).progressbar({value: parseInt($(this).attr("my_value")),max:parseInt($(this).attr("my_total"))})})
        })();
    (function(){
                {% autoescape off %}
                    var selected_slices = $.evalJSON('{{ selected_slices }}');
                {% endautoescape %}
                if (selected_slices!=undefined){
                    if ((selected_slices.length != 0)){
                        $(".checkboxSlice").prop('checked', false);
                        for(var i=0;i<selected_slices.length;i++){
                            $("#checkbox"+selected_slices[i]).prop('checked', true);
                    }
                }
                }


    })();
    $("#approveDialog").dialog({
        autoOpen: false,
        buttons : {
                OK : function(){
                    $( this ).dialog( "close" );
                }
            }
        });
    $("#problemDialog").dialog({
        autoOpen: false,
        buttons : {
                Cancel : function(){
                    $( this ).dialog( "close" );
                }
            }
        });
    makeJobOptionURL();
{#    $("#tagFormatSelect").change(function(){return tagFormatChange()});#}
{#    {% if not show_as_huge %}#}
{#        refreshTagFormats(null);#}
{#    {% endif %}#}
    {% if needed_management_approve %}
        $('#longDescription').show();

    {% endif %}
    {% if async_task %}
        progressCeleryBar('{{ async_task.id }}','{{ async_task.name }}','{{ async_task.user }}');
    {% endif %}
});

    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    function makeJobOptionURL(){
        $('.makeJOUrl').each(function(){

              var joboptions = $(this).html().replace(/ /g,'');
		      if ((joboptions!='')&&(joboptions!=undefined)) {
               if (joboptions.indexOf('/') == -1){
                var jo = joboptions.split(".");
                var dsid = jo[1].substring(0, 3) + "xxx";
                var link = "https://gitlab.cern.ch/atlas-physics/pmg/infrastructure/" + jo[0].toLowerCase() + "joboptions/blob/master/share/DSID" + dsid + "/" + joboptions;
                $(this).attr('href', link);
                var jo_project = jo[0].substring(0,4).toLowerCase();
                var request_project = $('#requestProject').html().substring(0,4).toLowerCase();
                if (request_project == 'mc16'){

                    if (jo_project != request_project){
                        var sliceID = $(this).attr("id").slice('sliceInputJobOptions'.length);
                        if (suspectSplit.indexOf(sliceID)==-1){
                            suspectSplit.push(sliceID);
                        }
                   }
                  }

                } else {
                    var jo = joboptions.split("/");
                    var dsid = jo[0].substring(0, 4) + "xxx/";
                    var link = "https://gitlab.cern.ch/atlas-physics/pmg/mcjoboptions/tree/master/" + dsid + joboptions;
                    $(this).attr('href', link);

                }
               }


        });
    };
    function changePriority(input){
            var limitMax = {{  limit_priority.max }};
            var limitMin = {{ limit_priority.min }};
            if (input.value < limitMin) input.value = limitMin;
            if (input.value > limitMax) input.value = limitMax;
    }

function saveChangesAsync(sendData){
    $( "#waitingDialog" ).dialog();

    var ajaxURL = '';
    ajaxURL = "{% url 'prodtask:request_steps_save_async' pr_id %}";

    sendAsyncTask(ajaxURL, sendData)
    $( "#waitingDialog" ).dialog('close');

}

    function saveChanges(isApprove, doSplit, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets){
                $( "#waitingDialog" ).dialog();

                var ajaxURL = '';

                if (isApprove){
                    if (doSplit){
                        ajaxURL = "{% url 'prodtask:home' %}" +"request_steps_approve_split/{{ pr_id }}/"+approveLevel.toString()+'/'+waitingLevel.toString()+'/';
                    } else{
                        ajaxURL = "{% url 'prodtask:home' %}" +"request_steps_approve/{{ pr_id }}/"+approveLevel.toString()+'/'+waitingLevel.toString()+'/';
                    }

                } else {
                    ajaxURL = "{% url 'prodtask:request_steps_save' pr_id %}";
                }
                $.ajax({
                    url: ajaxURL,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    timeout: 0,
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        if(status){
                            var missedList = $.evalJSON(data).missing_tags;
                            var errorSlices =  $.evalJSON(data).error_slices;
                            var notChangedSlices = $.evalJSON(data).no_action_slices;
                            var slices = $.evalJSON(data).slices;
                            var wrongSLices = $.evalJSON(data).wrong_slices;
                            var doubleTrf = $.evalJSON(data).double_trf;
                            var newStatus = $.evalJSON(data).new_status;
                            var removeDataset =  $.evalJSON(data).removed_input;
                            var approveProblem = $.evalJSON(data).error_approve_message;
                            if (missedList == undefined){
                                missedList = [];
                            }

                            if (doubleTrf == undefined){
                                doubleTrf = [];
                            }
                            if (wrongSLices == undefined){
                                wrongSLices = [];
                            }
                            if (slices == undefined){
                                slices = [];
                            }
                            if (errorSlices == undefined){
                                errorSlices = [];
                            }
                            if (notChangedSlices == undefined){
                                notChangedSlices = [];
                            }
                            if (removeDataset == undefined){
                                removeDataset = [];
                            }
                            var additionalComment = '';
                            if (approveProblem){
                                additionalComment = '\n You should be request manager to approve it.'
                            }
                            if ((newStatus != undefined) && (newStatus != '')){
                                $('#requestStatus').html(newStatus);
                            }
                            if ((missedList.length != 0)||(doubleTrf.length != 0)) {
                                if (missedList.length != 0) {
                                    $("#missing_tags_string").html(missedList.toString());
                                    $("#missing_tags").show();
                                }
                                if (doubleTrf.length != 0){
                                    $("#doubleTagsString").html(doubleTrf.toString());
                                    $("#doubleTags").show();
                                }
                            } else {
                                if(wrongSLices.length>0){
                                    $("#wrongSliceString").html(wrongSLices.toString());
                                    $("#wrongSlice").show();
                                } else {
                                    $("#wrongSlice").hide();
                                }
                                if((slices.length >0)||(errorSlices.length>0)||(notChangedSlices.length>0)) {
                                    var datasets = $.evalJSON(data).datasets_dict;
                                    $("#missing_tags").hide();
                                    $("#doubleTags").hide();
                                    $("#approveDialog").html('');
                                    if (errorSlices.length == 1) {
                                        $("#approveDialog").append($('<p/>').html('Slice has problem: ' + errorSlices[0]));
                                    } else {
                                        if (errorSlices.length > 1) {
                                            $("#approveDialog").append($('<p/>').html(errorSlices.length + 'Slices have problem: ' + errorSlices.toString()));
                                        }
                                    }
                                    if (notChangedSlices.length == 1) {
                                        $("#approveDialog").append($('<p/>').html('Slice was not changed: ' + notChangedSlices[0]));
                                    } else {
                                        if (notChangedSlices.length > 1) {
                                            $("#approveDialog").append($('<p/>').html(notChangedSlices.length + 'Slices were not changed: ' + notChangedSlices.toString()));
                                        }
                                    }
                                    if (doReload) {
                                        location.reload();
                                    }
                                }

                                    if (isApprove) {
                                        $("#approveDialog").append($('<p/>').html("Sucessfully approved slices: " + slices.toString() + additionalComment));
                                        $("#approveDialog").attr("title", "Steps approved");
                                        for (i = 0; i < slices.length; i++) {
                                            $("#aprroveLabel".concat(slices[i])).css({'color': 'greenyellow'}).html("Submitted");
                                            $("#aprroveLabelLong".concat(slices[i])).css({'color': 'greenyellow'}).html("Submitted")
                                        }

                                    } else {
                                        $("#approveDialog").append($('<p/>').html("Sucessfully saved slices: " + slices.toString()));
                                        $("#approveDialog").attr("title", "Steps saved");
                                    }

                                   $("#approveDialog").dialog("open");

                            }
                            for (var j=0;j<toChangeDatasets.length;j++){
                                $("#inputDatasetName"+toChangeDatasets[j]).html($("#inputDatasetSelect"+toChangeDatasets[j]).val());
                            }

                            for (var j=0; j < removeDataset.length; j++){
                                 $("#inputDatasetName"+removeDataset[j]).html('');
                            }
                            if (slices.length > 0){
                                for (var j = 0; j < slices.length; j++) {
                                    $("#saveStatus"+slices[j]).html("edit (saved)");
                                }
                            }

                        } else {
                            $('#errorDialogMessage').html('');
                            $( "#problemDialog" ).dialog("open");
                        }

                    }
                });
    }

function saveChangesWithInput(isApprove, doSplit, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets){
    $( "#progressSliceSaved" ).dialog();

    var ajaxURL = '';

    if (isApprove){
        if (doSplit){
            ajaxURL = "{% url 'prodtask:home' %}" +"request_steps_approve_split/{{ pr_id }}/"+approveLevel.toString()+'/'+waitingLevel.toString()+'/';
        } else{
            ajaxURL = "{% url 'prodtask:home' %}" +"request_steps_approve/{{ pr_id }}/"+approveLevel.toString()+'/'+waitingLevel.toString()+'/';
        }

    } else {
        ajaxURL = "{% url 'prodtask:request_steps_save' pr_id %}";
    }
    var missedListTotal = [];
    var wrongSLicesTotal = [];
    var slicesTotal = [];
    var errorSlicesTotal = [];
    var notChangedSlicesTotal = [];
    var removeDatasetTotal = [];
    var additionalComment = '';
    var slicesKeys = Object.keys(sendData);
    var total = slicesKeys.length;

    var SLICE_LENGHT = 10;
    var currentSlices = [];
    var processed = 0;
    $('#processedCount').html('processed :'+processed+'/'+total);

    for(i=0;i<total;i+=SLICE_LENGHT){
        var currentSendData = {};
        if ((i+SLICE_LENGHT)>slicesKeys.length){
            currentSlices = slicesKeys.slice(i,total)
        } else{
            currentSlices = slicesKeys.slice(i,i+SLICE_LENGHT)
        }
        for (j=0;j<currentSlices.length;j++){
            currentSendData[currentSlices[j]]=sendData[currentSlices[j]]
        }
        (function(currentSendData) {
            $.ajax({
            url: ajaxURL,
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: $.toJSON(currentSendData),
            dataType: 'text',
            success: function(data,status) {
                processed += Object.keys(currentSendData).length;
                $('#processedCount').html('processed :'+processed+'/'+total);
                if(status) {
                    var missedList = $.evalJSON(data).missing_tags;
                    var errorSlices = $.evalJSON(data).error_slices;
                    var notChangedSlices = $.evalJSON(data).no_action_slices;
                    var slices = $.evalJSON(data).slices;
                    var wrongSLices = $.evalJSON(data).wrong_slices;
                    var newStatus = $.evalJSON(data).new_status;
                    var removeDataset = $.evalJSON(data).removed_input;
                    var approveProblem = $.evalJSON(data).error_approve_message;
                    if (missedList !== undefined) {
                        missedListTotal=missedListTotal.concat(missedList);
                    }

                    if (wrongSLices !== undefined) {
                        wrongSLicesTotal=wrongSLicesTotal.concat(wrongSLices);
                    }

                    if (slices !== undefined) {
                        slicesTotal=slicesTotal.concat(slices);
                    }

                    if (errorSlices !== undefined) {
                        errorSlicesTotal=errorSlicesTotal.concat(errorSlices);
                    }
                    if (notChangedSlices !== undefined) {
                        notChangedSlicesTotal=notChangedSlicesTotal.concat(notChangedSlices);
                    }
                    if (removeDataset !== undefined) {
                        removeDatasetTotal=removeDatasetTotal.concat(removeDataset);
                    }
                    if (approveProblem) {
                        additionalComment = '\n You should be request manager to approve it.'
                    }
                    if ((newStatus !== undefined) && (newStatus !== '')) {
                        $('#requestStatus').html(newStatus);
                    }
                }
                if(processed === total){
                    $( "#progressSliceSaved" ).dialog('close');

                    if ((missedListTotal.length !== 0)) {
                        if (missedListTotal.length !== 0) {
                            $("#missing_tags_string").html(missedList.toString());
                            $("#missing_tags").show();
                        }

                    } else {
                        if(wrongSLicesTotal.length>0){
                            $("#wrongSliceString").html(wrongSLicesTotal.toString());
                            $("#wrongSlice").show();
                        } else {
                            $("#wrongSlice").hide();
                        }
                        if((slicesTotal.length >0)||(errorSlicesTotal.length>0)||(notChangedSlicesTotal.length>0)) {
                            $("#missing_tags").hide();
                            $("#doubleTags").hide();
                            $("#approveDialog").html('');
                            if (errorSlicesTotal.length === 1) {
                                $("#approveDialog").append($('<p/>').html('Slice has problem: ' + errorSlicesTotal[0]));
                            } else {
                                if (errorSlicesTotal.length > 1) {
                                    $("#approveDialog").append($('<p/>').html(errorSlicesTotal.length + 'Slices have problem: ' + errorSlicesTotal.toString()));
                                }
                            }
                            if (notChangedSlicesTotal.length === 1) {
                                $("#approveDialog").append($('<p/>').html('Slice was not changed: ' + notChangedSlicesTotal[0]));
                            } else {
                                if (notChangedSlicesTotal.length > 1) {
                                    $("#approveDialog").append($('<p/>').html(notChangedSlicesTotal.length + 'Slices were not changed: ' + notChangedSlicesTotal.toString()));
                                }
                            }
                            if (doReload) {
                                location.reload();
                            }
                        }
                        if (isApprove) {
                            $("#approveDialog").append($('<p/>').html("Sucessfully approved slices: " + slicesTotal.toString() + additionalComment));
                            $("#approveDialog").attr("title", "Steps approved");
                            for (i = 0; i < slicesTotal.length; i++) {
                                $("#aprroveLabel".concat(slicesTotal[i])).css({'color': 'greenyellow'}).html("Submitted");
                                $("#aprroveLabelLong".concat(slicesTotal[i])).css({'color': 'greenyellow'}).html("Submitted")
                            }

                        } else {
                            $("#approveDialog").append($('<p/>').html("Sucessfully saved slices: " + slicesTotal.toString()));
                            $("#approveDialog").attr("title", "Steps saved");
                        }

                        $("#approveDialog").dialog("open");

                    }
                    for (var j=0;j<toChangeDatasets.length;j++){
                        $("#inputDatasetName"+toChangeDatasets[j]).html($("#inputDatasetSelect"+toChangeDatasets[j]).val());
                    }

                    for (var j=0; j < removeDataset.length; j++){
                        $("#inputDatasetName"+removeDataset[j]).html('');
                    }
                    if (slicesTotal.length > 0){
                        for (var j = 0; j < slicesTotal.length; j++) {
                            $("#saveStatus"+slicesTotal[j]).html("edit (saved)");
                        }
                    }

                }



            }
        })}(currentSendData));
    }
}

    function approveSlices(isApprove, approveLevel, waitingLevel, slices, isAsync){

        var toChangeDatasets = [];
        var startFindig = false;
        var sendData = Object();
        var doReload = false;
        var doSplit = false;
        var noEvents = false;
        var askSplit = {'ask':false, 'slices':[]};
            for(var i=0;i<slices.length;i++){
                {#                   8 = "checkbox".length#}
                var sliceID = slices[i];
                var existSkipped = false;
                if (sliceID == '-1'){
                    doReload = true;
                }
                    if (! sendData[sliceID]){
                        sendData[sliceID] = Object();
                    }
                    var sliceSteps=[];
                    var foreignID = "0";
                    if (splitSlices.indexOf(sliceID) > -1){
                        doSplit = true;
                    }

                var steps_length = {{  step_list|length }};
                for(var j=0; j<steps_length; j++){
                        var val = " ";
                        var step_td_short = "td#short".concat(sliceID).concat("s"+ j.toString()+".showFullSpan");
                        var isSkipped = ($(step_td_short).css("background-color") ==  $("#skippedColor").css("background-color"));
                        if (isSkipped){
                            existSkipped = true;
                        }

                        if ($(step_td_short).css("background-color") !=  $("#foreignColor").css("background-color")){
                            val = $(step_td_short).html();
                        } else {
                            val = " ";
                        }

                        var step_td_short_foreign = "td#short".concat(sliceID).concat("s" + j.toString() + ".notShowFullSpan");
                        if ($(step_td_short_foreign).css("background-color") ==  $("#foreignColor").css("background-color")){
                            foreignID = $(step_td_short_foreign).children(".foreignStepID").html();
                            val = " ";
                        }
                        if ((!doSplit)&&(j==0)&&(val!=' ')&&(suspectSplit.indexOf(sliceID)>-1)&&(!(isSkipped))){
                            askSplit['ask'] = true;
                            askSplit['slices'].push([sliceID,val]);
                        }
                        if (sliceID in changesList){
                            if(changesList[sliceID].stepsInSlice.length>j){
                                sliceSteps[j] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':changesList[sliceID].stepsInSlice[j]};
                            }
                            else{
                                sliceSteps[j] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':''};
                            }

                        }
                        else{
                            sliceSteps[j] = {"value": val, "is_skipped": isSkipped, "formats": "", 'changes':''};
                        }
                }





                     sliceSteps[steps_length] = {"foreign_id":foreignID};
                     sliceSteps[steps_length+1] = {"input_dataset":$("#inputDatasetSelect" + sliceID).val()};


                    if (sliceID in changesList){
                        sendData[sliceID] = {'sliceSteps':sliceSteps, 'changes':changesList[sliceID]};
                    } else {
                        sendData[sliceID] = {'sliceSteps':sliceSteps, 'changes':''};
                    }
                    if (existSkipped && ($("#inputDatasetSelect" + sliceID).val() !== undefined) && ($("#inputDatasetSelect" + sliceID).val() !== null) &&  ($("#inputDatasetSelect" + sliceID).val() !== "") && ($("#inputDatasetName" + sliceID).html() == "")){
                        toChangeDatasets.push(sliceID);
                    }
                    if (existSkipped &&  !($("#inputDatasetSelect" + sliceID).val()) ){
                        startFindig = true;
                    }

            }
            if(askSplit['ask'] && isApprove){
{#                do async check for split with message#}
                var splitSliceData = $.toJSON(askSplit['slices']);
                $( "#waitingDialog" ).dialog();
              $.ajax({
                          url: construct_django_url('/prodtask/check_slices_for_request_split/', "{{ pr_id }}"),
                          type: 'POST',
                          contentType: 'application/json; charset=utf-8',
                          data: splitSliceData,
                          dataType: 'text',
                          success: function (data, status) {
                              $( "#waitingDialog" ).dialog('close');
                              doSplit = $.evalJSON(data).do_split;
                              if (doSplit) {
                                  doSplit = confirm('Some slices should be split between two request. Do splitting?');
                              }

                              if (doSplit) {
                                  doReload = true;
                                  saveChanges(isApprove, doSplit, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets);
                              } else {
                                  saveChanges(isApprove, doSplit, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets);
                              }

                          }
                      }
                );


            } else {
                if (toChangeDatasets.length!==0){
                    saveChangesWithInput(isApprove, false, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets);
                } else {
                    if (isAsync){
                        saveChangesAsync(sendData);
                    }
                    else {
                        saveChanges(isApprove, false, sendData, doReload, startFindig, approveLevel, waitingLevel, toChangeDatasets);
                    }
                }

            }



    }


    function approveClick(event,isApprove, approveLevel, isWaiting,isAsync){
        event.preventDefault();
        var slices = [];
        var waitingLevel=99;
        if (isWaiting){
            waitingLevel=1;
        }
        $(".checkboxSlice:checked").each(function() {
            {#                   8 = "checkbox".length#}
            var sliceID = $(this).attr("id").slice(8);
            var existSkipped = false;
            if ($("#inputList_div".concat(sliceID)).is(":visible")) {
                slices.push(sliceID);
            }
        });
        approveSlices(isApprove,approveLevel,waitingLevel, slices,isAsync );
    };
    function approveEmpty(event){
        event.preventDefault();
        var slices = [];
        approveSlices(true,99, 99, slices);
    };

    function emptyPattern(){
      var patternIsEmpty = true;
      {% for step in step_list %}
            patternIsEmpty = patternIsEmpty && ($("#patternform{{forloop.counter0}}").val() == '');
      {% endfor %}
      return patternIsEmpty;
    };
    var currentTags = [];
    function tagInfoUpdate(){
        var newTags = [];
        $(".patternForm").each(function(){
            if (this.val() != ''){
                newTags.push(this.val());
            }
        for (i=0;i<newTags.length;i++){
            if ($.inArray(newTags,currentTags) == -1){

            }
        }
        });
    }
    function bindClick(event){
        event.preventDefault();

            $(".checkboxSlice").each(function(){
                if ($(this).is(':checked')){
{#                   8 = "checkbox".length#}
                   var sliceID = $(this).attr("id").slice(8);
                   if ($("#inputList_div".concat(sliceID)).is(":visible")){
                       if (($("#aprroveLabel".concat(sliceID)).html()!="submitted")&&($("#aprroveLabel".concat(sliceID)).html()!="partially_submitted")){
                           $("#aprroveLabel".concat(sliceID)).html('not_submitted');
                           $("#aprroveLabel".concat(sliceID)).addClass('not_submitted');
                           $("#aprroveLabel".concat(sliceID)).css({'background-color':'transparent'});
                       }
                       {% for step in step_list %}
                           var stepValue = $("#patternform{{ forloop.counter0 }}").val();
                           var step_td_short = "td#short".concat(sliceID).concat("s{{ forloop.counter0 }}.showFullSpan");

                           var stepColor = $("#startStep{{ forloop.counter0 }}").css("background-color");

                           $(step_td_short).css({"background-color":stepColor});
                           var stepFormLong = "#".concat(sliceID).concat("s{{ forloop.counter0 }}.slice_form");
                           var step_th_long = "th#step".concat(sliceID).concat("s{{ forloop.counter0 }}.stepchoose");
                           $(step_th_long).css({"background-color":stepColor});
                           if(stepValue.length == 1){
                               $(stepFormLong).val('');
                               $(step_td_short).html('');
                           } else if($('#replaceByPattern').is(':checked')||(stepValue.length > 1)){
                               $(stepFormLong).val(stepValue);
                               $(step_td_short).html(stepValue);
                           }
                           $("#saveStatus"+sliceID.toString()).html("edit (not saved)");
                       {% endfor %}
                           var sliceIDint = parseInt(sliceID);
                           if (!(sliceIDint in changesList)){
                                changesList[sliceIDint] = new RequestSlice();
                            }

                            for(var i=0;i<patternDict.length;i++){
                                if (changesList[sliceIDint].stepsInSlice.length <= i){
                                    var newStep = new ProcessingStep();
                                    changesList[sliceIDint].addStep(newStep);
                                  }
                                var currentStep = changesList[sliceIDint].getStepByNumber(i);
                                for (field in patternDict[i]){
                                    if(field=='onlyTagsForFC'){
                                        if(patternDict[i][field] == 'True'){
                                            currentStep[field] = true;
                                        } else if (patternDict[i][field] == 'False'){
                                            currentStep[field] = false;
                                        }else{
                                             currentStep[field] = '';
                                        }
                                    } else {
                                        currentStep[field] = patternDict[i][field];
                                    }
                                }
                            }
                   }
                };
            });


    };

    function showPatternClick(event){
        event.preventDefault();
        $('#patternModalBody').html('');
         {% for step in step_list %}
             var currentStep = '{{ step.name }}:'+'{';
             for (field in patternDict[{{ forloop.counter0 }}]){
                currentStep = currentStep + ' ' + field + ':' + patternDict[{{ forloop.counter0 }}][field] +'; ';
             }
             currentStep = currentStep + '}';
             $('#patternModalBody').append($('<li/>').html(currentStep));
        {% endfor %}
            $('#patternModal').foundation('reveal', 'open')
    };


    function longFormChange(event){
      var step_td_short = "td#short".concat($(event.target).attr('id'))  ;
      $(step_td_short).html($(event.target).val());
      $("#saveStatus"+$(event.target).attr('id').split("s")[0]).html("edit (not saved)");
    };

    function selectClick(event){
      event.preventDefault();
      var firstCheckBox = true;
      var markAsChecked = false;
      $(".checkboxSlice").each(function(){
          var sliceID = $(this).attr("id").slice(8);
          if ($("#inputList_div".concat(sliceID)).is(":visible")){
              if (firstCheckBox){
                  markAsChecked = !($(this).prop('checked'));
                  firstCheckBox = false;
              }
              $(this).prop('checked', markAsChecked);
          }
      });

    };
     function checkSlice(event) {

             var currentSlice = sliceOrder.indexOf(($(event.target).attr('id')).slice('checkbox'.length));
             if (event.shiftKey) {
                 if (lastCheckedSlice > -1) {

                     if (lastCheckedSlice > currentSlice) {
                         fromSlice = currentSlice;
                         toSlice = lastCheckedSlice;
                     } else {
                         fromSlice = lastCheckedSlice;
                         toSlice = currentSlice;
                     }
                     for(var i=fromSlice;i<=toSlice;i++){
                        if ($("#inputList_div".concat(sliceOrder[i])).is(":visible")){
                            $('#checkbox'+sliceOrder[i]).prop("checked",lastChecked);
                        }
                     }

                 }

                 lastCheckedSlice = currentSlice;
             }
            lastCheckedSlice = parseInt(currentSlice);
            lastChecked = $(event.target).is(':checked');
     }
          function approveReprocessingClick(event){
            var sendData = Object();
            var i=0;
            var sliceList = getCheckedSlices();

            sendData = {'tagsFormats':$("#tagsFormatsTA").val(),'slices':sliceList}
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:request_reprocessing_steps_create' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    timeout: 0,
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                    }
                });
              return false;
       };
          function chnageStatusToTest(event){
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:make_test_request' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');

                    }
                });
              return false;
       };
        function chnageRequestToFast(event){
            event.preventDefault();
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:make_request_fast' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        $("#isFast").html(" :Yes");
                    }
                });
              return false;
        }

        function onHoldRequest(event){
            event.preventDefault();
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:change_production_request_status' pr_id 'hold'%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var newStatus =  $.evalJSON(data).newStatus;
                        var registrationMessage = $.evalJSON(data).registrationMessage;
                        if (newStatus != $('#requestStatus').html()) {
                            $('#requestStatus').html(newStatus);
                            $('#requestRegistButton').hide();
                            $('#requestCancelButton').hide();
                            $('#requestOnHoldButton').hide();
                            $('#onHoldRequestMessgae').html(registrationMessage);
                        }
                    }
                });
              return false;
        }

        function registerRequest(event){
            event.preventDefault();
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:do_mc_management_approve' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var newStatus =  $.evalJSON(data).newStatus;
                        var registrationMessage = $.evalJSON(data).registrationMessage;
                        if (newStatus != $('#requestStatus').html()) {
                            $('#requestStatus').html(newStatus);
                            $('#requestRegistButton').hide();
                            $('#requestCancelButton').hide();
                            $('#requestOnHoldButton').hide();
                            $('#registrationMessgae').html(registrationMessage);
                        }
                    }
                });
              return false;
        }
        function cancelRequest(event){
            event.preventDefault();
            sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:do_mc_management_cancel' pr_id%}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var newStatus =  $.evalJSON(data).newStatus;
                        var cancelationMessage = $.evalJSON(data).message;
                        if (newStatus != $('#requestStatus').html()) {
                            $('#requestStatus').html(newStatus);
                            $('#requestRegistButton').hide();
                            $('#requestCancelButton').hide();
                            $('#requestOnHoldButton').hide();
                            $('#cancelationMessgae').html(cancelationMessage);
                        }
                    }
                });
              return false;
        }
        function tagFormatChange(){
{#                 event.preventDefault();#}
                 sendData = {'tag_format':$("#tagFormatSelect").val()};
                  $( "#waitingDialog" ).dialog();
                  $.ajax({
                        url: "{% url 'prodtask:project_mode_from_tag' pr_id %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        success: function(data,status) {
                            $( "#waitingDialog" ).dialog('close');
                            var project_mode = $.evalJSON(data).project_mode;
                            var input_events = $.evalJSON(data).input_events;
                            var priority = $.evalJSON(data).priority;
                            var nEventsPerJob = $.evalJSON(data).nEventsPerJob;
                            var nEventsPerInputFile = $.evalJSON(data).nEventsPerInputFile;
                            $("#project_mode_input").val(project_mode);
                            $('#input_events_input').val(input_events);
                            $('#priority_input').val(priority);
                            $('#nEventsPerJob_input').val(nEventsPerJob);
                            $('#nEventsPerInputFile_input').val(nEventsPerInputFile);
                            $('#destination_input').val($.evalJSON(data).destination);
                        }
                    });
                  return false;
        };

         function refreshTagFormats(event){
             if(event != undefined){
                 event.preventDefault();
             }

             sendData = {};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:get_tag_formats' pr_id%}",
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var tagFormats = $.evalJSON(data).data;
                        $("#tagFormatSelect").html("");
                        for (var i=0;i<tagFormats.length;i++){
                            $("#tagFormatSelect").append($('<option>', {
                                value: tagFormats[i],
                                text: tagFormats[i]
                            }));
                        }
                        tagFormatChange();
                    }
                });

              return false;
         };

        function updateStepParametrs(event){
            event.preventDefault();
            sendData = {'tag_format':$("#tagFormatSelect").val(),'project_mode':$("#project_mode_input").val(),
              'input_events':$('#input_events_input').val(),'priority':$('#priority_input').val(),
              'nEventsPerJob':$('#nEventsPerJob_input').val(),
                  'nEventsPerInputFile':$('#nEventsPerInputFile_input').val(),
              'destination_token':$('#destination_input').val()};
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:update_project_mode' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        var slices = $.evalJSON(data).slices;
                        if(slices.length >0){
                            $("#approveDialog>span").text("Sucessfully update slices: ".concat(slices.toString()));
                            $("#approveDialog").attr("title","Steps updated");
                            $("#approveDialog").dialog("open");
                        }
                    }
                });
              return false;
        };
        function testAsyncClick(event){
            event.preventDefault();
            sendData = {'text':'test'};
            url = "{% url 'prodtask:test_celery_task' pr_id %}";
            sendAsyncTask(url,sendData);
        }
        function sendAsyncTask(url, sendData){
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: $.toJSON(sendData),
                dataType: 'json',
                success: function(data,status) {
                    if (data.status === 'OK'){
                        progressCeleryBar(data.task_id, data.name, data.user);
                    }
                    if (data.status === 'busy'){
                        progressCeleryBar(data.task_id, data.name, data.user);
                        alert('Previous command is still executing, please wait before sending a new command');
                    }

                },
                error: function (data,status){
                    alert('Some problem during command sending'+data.toString());
                }
            });
        }

    function prepare_async_comment(results) {
        var async_name = results.async_name;
        var comment = '';
        switch (async_name) {
            case 'save_slices':
                var missedList = results.missing_tags;
                var errorSlices =  results.error_slices;
                var notChangedSlices = results.no_action_slices;
                var slices = results.slices;
                var wrongSLices = results.wrong_slices;
                var doubleTrf = results.double_trf;
                var removeDataset =  results.removed_input;
                if (missedList === undefined){
                    missedList = [];
                }

                if (doubleTrf === undefined){
                    doubleTrf = [];
                }
                if (wrongSLices === undefined){
                    wrongSLices = [];
                }
                if (slices === undefined){
                    slices = [];
                }
                if (errorSlices === undefined){
                    errorSlices = [];
                }
                if (notChangedSlices === undefined){
                    notChangedSlices = [];
                }
                if (removeDataset === undefined){
                    removeDataset = [];
                }
                console.log(slices);

                if((slices.length >0)||(errorSlices.length>0)||(notChangedSlices.length>0)) {
                    if (errorSlices.length === 1) {
                        comment='Slice has problem: ' + errorSlices[0]+'\n';
                    } else {
                        if (errorSlices.length > 1) {
                            comment=errorSlices.length + ' Slices have problem: ' + errorSlices.toString()+'\n';
                        }
                    }
                    if (notChangedSlices.length === 1) {
                        comment='Slice was not changed: ' + notChangedSlices[0]+'\n';
                    } else {
                        if (notChangedSlices.length > 1) {
                            comment=notChangedSlices.length + ' slices were not changed: ' + notChangedSlices.toString()+'\n';
                        }
                    }
                    comment="Sucessfully saved slices: " + slices.toString()+'\n';

                }


                for (var j=0; j < removeDataset.length; j++){
                    $("#inputDatasetName"+removeDataset[j]).html('');
                }
                if (slices.length > 0){
                    for (var j = 0; j < slices.length; j++) {
                        $("#saveStatus"+slices[j]).html("edit (saved)");
                    }
                }
                break;

            default:
                return "";
        }
        return comment;
    }

    function progressCeleryBar(celery_task_id, function_name, user_name){
            $('.asyncProgressRef').show();
            $('.asyncTaskID').html(celery_task_id);
            $(".btn_is_authorized").each(function(){this.disabled=true;});
            $(".btn_is_authenticated").each(function(){this.disabled=true;});
            $('.asyncTaskName').html(function_name);
            $('.asyncTaskUserName').html(user_name);
            var pollInterval = undefined;
                    poll = function() {
                        $.ajax({
                            url: construct_django_url('/prodtask/celery_task_status/',celery_task_id),
                            dataType: 'json',
                            type: 'get',
                            success: function(data) { // check if available
                                $('.asyncStatus').html(data.status);
                                $('.asyncTaskName').html(data.celery_task_name);
                                console.log(data);
                                if ( data.status === 'PROGRESS' ) { // get and check data value
                                    $('.asyncProgressStat').html(data.progress.toString()+' %');
                                }
                                if ( data.status === 'SUCCESS' ) { // get and check data value
                                    $('.asyncTaskName').html('');
                                    $('.asyncProgressStat').html('100%');
                                    clearInterval(pollInterval); // optional: stop poll function

                                    if (confirm('Async task finish successfully, reload the page?')){
                                        location.reload();
                                    }
                                    $(".btn_is_authorized").each(function(){this.disabled=false;});
                                    $(".btn_is_authenticated").each(function(){this.disabled=false;});
                                    $('.asyncProgressRef').hide();


                                }
                                if ( data.status === 'FAILURE') { // get and check data value
                                    clearInterval(pollInterval); // optional: stop poll function
                                    if (confirm('Async task failed')){
                                        location.reload();
                                    }
                                    $(".btn_is_authorized").each(function(){this.disabled=false;});
                                    $(".btn_is_authenticated").each(function(){this.disabled=false;});
                                    $('.asyncProgressRef').hide();

                                }
                            },
                            error: function() { // error logging
                                console.log('Error!');
                                $(".btn_is_authenticated").each(function(){this.disabled=false;});
                                $(".btn_is_authorized").each(function(){this.disabled=false;});
                                $('.asyncProgressRef').hide();

                            }
                        });
                    };
                    poll();
                    pollInterval = setInterval(function() { // run function every 2000 ms
                        poll();
                    }, 10000);
        }
        function findInputClick(event) {
            event.preventDefault();
            var i=0;
            var sliceList = getCheckedSlices();

            findInputForSlices(sliceList);
        }
        function addComment(event){
            event.preventDefault();
            sendData = {'comment':$('#newComment').val()};
            $.ajax({
                    url: "{% url 'prodtask:add_request_comment' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {

                        $('#commentList').prepend('<li>Now; {{ request.user.username }}-'+sendData['comment']+'</li>');
                        $('#lastComment').html('{{ request.user.username }}-'+sendData['comment']);
                    }
                });
        }
        function addHashTag(event){
            event.preventDefault();
            sendData = {'hashtag':$('#newHashTag').val()};
            $.ajax({
                    url: "{% url 'prodtask:add_request_hashtag' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        var newHashtags =$.evalJSON(data).data;
                        $('.hashtags').html(newHashtags.html);
                        $('.hashtags').attr('href',construct_django_url('/prodtask/request_hashtags_outputs/', newHashtags.href));

                        redoHashtagList();
                    }
                });
        }
        function showStatusHistory(event){
            event.preventDefault();
{#            $('#statusHistoryModal').foundation('reveal', 'open');#}
            $('#chooseNewStatus').val($('#requestStatus').html());
            $('#requestStatusUpatde').html('');
            $.ajax({
                    url: "{% url 'prodtask:status_history' pr_id %}",
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'text',
                    success: function(data,status) {
                        var statusList =  $.evalJSON(data).data;
                        $('#statusTableBody').html('');
                        for (i=0;i<statusList.length;i++){
                            var statusRow = $('<tr></tr>');

                            statusRow.append("<td>"+statusList[i].status+"</td>");
                            statusRow.append("<td>"+statusList[i].user+"</td>");
                            statusRow.append("<td>"+statusList[i].date+"</td>");
                            statusRow.append("<td>"+statusList[i].comment+"</td>");
                            $('#statusTableBody').append(statusRow);

                        }
                        $('#statusHistoryModal').foundation('reveal', 'open');
                    }
                });
        }

        function makeUserOwner(event){
            event.preventDefault();
            changeOwner("{{ user.username }}");

        }
        function changeOwner(newUserName){
             sendData = {username:newUserName};
            $.ajax({
                    url: "{% url 'prodtask:make_user_as_owner' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        var newOwnerName =  $.evalJSON(data).ownerName;
                        if ((newOwnerName!='')&&(newOwnerName!=undefined)){
                            $('#ownerName').html(newOwnerName);
                            $('#requestStatus').html('working');
                             $('#changeOwnerWindow').foundation('reveal', 'close');
                        }
                    },
                    error: function(data,status) {
                        alert(data);
                    }
                });
        }
        function changeOwnerUser(event, newUserName){
            event.preventDefault();
            sendData = {username:newUserName};
            $.ajax({
                    url: "{% url 'prodtask:check_user_exists'  %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                            var userExists = $.evalJSON(data).user_exists;
                            if (!userExists) {
                                if(confirm("User doesn't exist. Change owner anyway?")){
                                    changeOwner(newUserName);
                                }
                            } else {
                                changeOwner(newUserName);
                            }
                             $('#changeOwnerWindow').foundation('reveal', 'close');
                        },

                    error: function(data,status) {

                        alert(data);
                    }
                });

        }
        function findInputForSlices(sliceList){

            var sendData = [];
              $( "#progressInputFind" ).dialog();
              $("#inputsCount").html("0/"+sliceList.length);
              var slicesDone = 0;
              for(var i=0;i<sliceList.length;i++){
                  sendData = [sliceList[i]]
                  $.ajax({
                      url: "{% url 'prodtask:find_input_datasets' pr_id %}",
                      type: 'POST',
                      contentType: 'application/json; charset=utf-8',
                      data: $.toJSON(sendData),
                      dataType: 'text',
                      success: function(data,status) {
                          var slices = $.evalJSON(data).data;
                          var slice;
                          slicesDone+=1;
                          $("#inputsCount").html(slicesDone+"/"+sliceList.length);
                          if (slicesDone === sliceList.length){
                              $( "#progressInputFind" ).dialog('close');
                          }
                          for (slice in slices) {
                              var sliceName = "#inputDatasetSelect" + slice;
                              var existReduced = false;
                              $(sliceName).html("");
                              for (var i=0;i<slices[slice].length;i++){
                                  if (!slices[slice][i].excluded){
                                      $(sliceName).append($('<option>', {
                                          value: slices[slice][i].dataset_name,
                                          text: slices[slice][i].dataset_name + " - " + slices[slice][i].events
                                      }));
                                  } else {
                                      $(sliceName).append($('<option>', {
                                          value: slices[slice][i].dataset_name,
                                          text: slices[slice][i].dataset_name + " - " + slices[slice][i].events + " (reduced)"
                                      }));
                                      existReduced = true;
                                  }


                              }
                              $(sliceName).show();
                              if (existReduced){
                                  $("#inputDatasetSelectReduced"+slice).html(" ! ");

                              } else {
                                  $("#inputDatasetSelectReduced"+slice).html("");
                              }
                              $("#inputDatasetSelectCount"+slice).html(slices[slice].length.toString());
                              if(slices[slice].length == 1){
                                  $("#inputDatasetSelectCount"+slice).css({'color':'green'})
                              }else{
                                  $("#inputDatasetSelectCount"+slice).css({'color':'red'})
                              }
                          }
                      }
                  });

              }

              return false;
        };

        function obsoleteOldTasks(event, is_group){

            event.preventDefault();
            var sliceCheckedList = getCheckedSlices();
            var sendData = {slices:sliceCheckedList };
            if ((sliceCheckedList.length > 10) && (is_group)){
                var url = construct_django_url('/prodtask/async_obsolete_old_deleted_tasks/',"{{ pr_id }}");
                sendAsyncTask(url,sendData);
            } else {
                $( "#waitingDialog" ).dialog();
                $.ajax({
                        url: construct_django_url('/prodtask/obsolete_old_deleted_tasks/',"{{ pr_id }}"),
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        timeout: 0,
                        dataType: 'text',
                        success: function(data,status) {
                            $( "#waitingDialog" ).dialog('close');
                            alert('Number of "obsolete" tasks: '+$.evalJSON(data).tasksObsolete);
                        },
                        error: function (data,status,error) {
                            $("#waitingDialog").dialog('close');

                            if (status == '403'){
                                alert("Not enough rights for this action");

                            } else {
                                alert('Some problems occured: ' +error);

                            }

                        },
                    }
                )
                return false;
            }

        };

        function prepareSliceInfo(check_steps,sliceID){
            changeMode = false;
                for(var i=0;i<check_steps.db_step_type.length;i++) {
                    stepHasChanges = false;
                    currentTag =  $.trim($("#short"+sliceID.toString() + 's' + i.toString()).html());
                    step_id = "#short" + sliceID.toString() + 's' + i.toString();
                    var currentType = 'not_skipped';
                    if ($(step_id).attr('class').indexOf("notShowFullSpan")>-1 ){
                                currentTag = 'Child step';
                            currentType = 'foreign';

                    } else{
                            if ($(step_id).css("background-color") == $("#skippedColor").css("background-color")) {
                                currentType = 'is_skipped';
                            }
                    }
                    if ((check_steps.db_step_type[i].step_name != "") || (currentTag != '')) {
                        if (currentTag != check_steps.db_step_type[i].step){
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').val(currentTag);
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').parent().css({'color': 'red'});
                           stepHasChanges = true;
                        }
                        else{
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').val(currentTag);
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'step').parent().css({'color': 'initial'});
                        }
                        if(currentType != (check_steps.db_step_type[i].step_type)){
                           $('#sliceModal .storeOutput' + i.toString() + '.' + 'skipped').parent().css({'color': 'red'});
                           stepHasChanges = true;
                        } else {
                            $('#sliceModal .storeOutput' + i.toString() + '.' + 'skipped').parent().css({'color': 'initial'});
                        }
                        if (currentType != 'not_skipped'){
                             $('#sliceModal .storeOutput' + i.toString() + '.' + 'skipped').prop('checked', true);

                        } else{
                             $('#sliceModal .storeOutput' + i.toString() + '.' + 'skipped').prop('checked', false);
                        }
                        for (fieldName in check_steps.db_step_type[i]) {
                            if ((fieldName != 'step_name')&&(fieldName != 'step')) {
                                notUpdateFromDB = false;
                                if (parseInt(sliceID) in changesList) {
                                    if (changesList[sliceID].stepsInSlice.length > i) {
                                        if (changesList[sliceID].getStepByNumber(i)[fieldName] != undefined) {
                                            if (changesList[sliceID].getStepByNumber(i)[fieldName] != check_steps.db_step_type[i][fieldName]) {
                                                notUpdateFromDB = true;
                                                if(fieldName=='onlyTagsForFC'){
                                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).prop({'checked':changesList[sliceID].getStepByNumber(i)[fieldName]});
                                                } else {
                                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).val(changesList[sliceID].getStepByNumber(i)[fieldName]);
                                                }
                                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).parent().css({'color': 'red'});

                                                stepHasChanges = true;

                                            }
                                        }
                                    }
                                }
                                if (!notUpdateFromDB) {
                                    $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).parent().css({'color': 'initial'});
                                    if(fieldName=='onlyTagsForFC'){
                                        $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).prop({'checked':check_steps.db_step_type[i][fieldName]});
                                    } else {

                                        $('#sliceModal .storeOutput' + i.toString() + '.' + fieldName).val(check_steps.db_step_type[i][fieldName]);
                                    }

                                }
                            }

                        }
                    } else {
                        $('#sliceModal .storeOutput'+ i.toString()).each(function () {
                            $(this).val('');
                            $(this).parent().css({'color': 'initial'});
                        });
                    }
                    currentHTML = $("#sectionName" + i.toString()).html()
                    if (stepHasChanges){

                              if (currentHTML.indexOf('*') == -1) {
                                  $("#sectionName" + i.toString()).html(currentHTML + '*');
                              }
                    }
                    else{
                                  newName = currentHTML.replace('*','');
                                 $("#sectionName" + i.toString()).html(newName);
                    }

                }
            check_steps['is_eaqual'] = undefined;
            check_steps['db_step_type'] = undefined;
            for (sliceField in check_steps){
                notUpdateFromDB = false;
                if (parseInt(sliceID) in changesList) {
                    if (changesList[sliceID][sliceField]!= undefined) {
                            if (changesList[sliceID][sliceField] != check_steps[sliceField]) {
                                notUpdateFromDB = true;
                                $('#'+sliceField+'Modal').val(changesList[sliceID][sliceField]);
                                $('#'+sliceField+'Modal').parent().css({'color': 'red'});
                            }
                    }
                }
                if (!notUpdateFromDB) {
                   $('#'+sliceField+'Modal').parent().css({'color': 'initial'});
                   $('#'+sliceField+'Modal').val(check_steps[sliceField]);
                }
            }
            $('.containerSelectForm').hide();
            $('#sliceModalSlice').html(sliceID);
            $('#sliceModal').foundation('reveal', 'open');
            changeMode = true;
        }

        $(document).foundation();
        function formSliceInfo(event, id){
          if(event != undefined){
              event.preventDefault();
          }
          if(!fromPreviousSlice){
              $("#saveButtonSlice").html('Save');
              workingOnSlices = [];
          }
          var sliceID = id.slice(10);
          $("#sliceInfo").attr({'class':'small content f-dropdown'});
          $("#sliceInfo").html('');
          var check_steps = changeSliceSaveStatus(sliceID);
            $('#sliceModal').on('opened', function () {
              $(this).foundation('section', 'reflow');
            });
          prepareSliceInfo(check_steps,sliceID);
        }

        function openPrevSlice(event, id, isPrev){
            event.preventDefault();
            var previous = undefined;
            var newSlice = undefined;
            var getNext = false;

            $(".checkboxSlice").each(function () {
                        {#                   8 = "checkbox".length#}
                        var sliceID = $(this).attr("id").slice(8);
                        if (getNext){
                            getNext = false;
                            newSlice = sliceID;
                        }
                        if (sliceID == id){
                            if (isPrev){
                                if  (previous != undefined){
                                    newSlice = previous;
                                }
                            }
                            else{
                                getNext = true;
                            }
                        }
                        previous = sliceID;
                    });
            if (newSlice !=  undefined){
                var numberToSave = 0;
                if (!workingOnSlices.includes(id) &&(id  in changesList) ) {
                    workingOnSlices.push(id);
                }
                if(workingOnSlices.includes(newSlice) ){
                    numberToSave = workingOnSlices.length;
                } else {
                    numberToSave = workingOnSlices.length+1;
                }
                if(numberToSave === 1){
                    $('#saveButtonSlice').html('Save');
                } else {
                    $('#saveButtonSlice').html('Save ('+(numberToSave).toString()+' slices)');
                }
                $('#closeReveal').click();
                fromPreviousSlice = true;
                setTimeout(function(){
                    formSliceInfo(undefined,'0123456789'+newSlice);
                 }, 1000);

            }
        }
        function getCheckedSlices(){
             var sliceList=[];
                $(".checkboxSlice:checked").each(function(){
                var sliceID = $(this).attr("id").slice(8);
                if ($("#inputList_div".concat(sliceID)).is(":visible")) {
                    sliceList.push(sliceID);
                }
            });
            return sliceList;
        }


        function  fillTagsForStep(slices, stepName){

            var sendData = {slices:slices, step:stepName };
            $.ajaxSetup({async: false});
              $.ajax({
                    url: construct_django_url('/prodtask/get_ami_tag_list/',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                            AMITags = $.evalJSON(data).AMITags;
                        $('#amitagBulkSelect').html('');
                            $('#amitagBulkSelect').append($('<option>', {
                                value: 'none',
                                text: 'none'
                            }));
                        if (AMITags.length>1) {
                            $('#amitagBulkSelect').append($('<option>', {
                                value: '',
                                text: 'all'
                            }));
                        }
                        for (i=0;i<AMITags.length;i++){

                                $('#amitagBulkSelect').append($('<option>', {
                                    value: AMITags[i],
                                    text: AMITags[i]
                                }));
                        }
                        }
                    }
                );
            $.ajaxSetup({async: true});
        }

        function showBulkSliceModal(event){
            event.preventDefault();
            bulkSliceChanges = {};
            changeMode = true;
            var sliceCheckedList = getCheckedSlices();
            $('#slicesBulkModalSize').html(sliceCheckedList.length);
            var sendData = {slices:sliceCheckedList };
            $.ajaxSetup({async: false});
              $.ajax({
                  url: construct_django_url('/prodtask/get_slices_bulk_info/', "{{ pr_id }}"),
                  type: 'POST',
                  contentType: 'application/json; charset=utf-8',
                  data: $.toJSON(sendData),
                  dataType: 'text',
                  success: function (data, status) {
                      fillStepBulkChange($.evalJSON(data).result,'storeSliceBulk');
                  }
              });
            $.ajaxSetup({async: true});



            $('#slicesBulkChangeModal').foundation('reveal', 'open')
        }

        function showBulkStepModal(event){
            event.preventDefault();
            $(".bulkSelect").prop('disabled', false);
            var sliceCheckedList = getCheckedSlices();
            $('#allSlicesBulk').html('All'+'('+$('.checkboxSlice').length+')');
            $('#selectedSliceBulk').html('Only selected'+'('+sliceCheckedList.length+')');

{#            $('#radioSetStepSelect').removeAttr('checked');#}


            changeStepBulk();
            $('#stepsBulkChangeModal').foundation('reveal', 'open')
        }
        function fillStepBulkChange(input_dict, className){
            for (multiValueElement in input_dict['multivalues']){

                $('.'+className+'.'+multiValueElement).val('');
                $('.'+className+'.'+multiValueElement).attr('placeholder','(Multiple values)');
                $('.'+className+'.'+multiValueElement).parent().css({'color': 'initial'});
            }
            for (singleValueElement in input_dict['singlevalue']){
                if(singleValueElement == 'onlyTagsForFC'){
                    $('.'+className+'.'+singleValueElement).prop({'checked':input_dict['singlevalue'][singleValueElement]});
                } else {
                    $('.'+className+'.'+singleValueElement).val(input_dict['singlevalue'][singleValueElement]);
                }
                $('.'+className+'.'+singleValueElement).attr('placeholder','');
                $('.'+className+'.'+singleValueElement).parent().css({'color': 'initial'});
            }
            bulkStepChanges = {}
        }
        function  getStepBulkChange(slices, stepName, amiTag){
            var sendData = {slices:slices, step:stepName, amiTag:amiTag };
            $.ajaxSetup({async: false});
              $.ajax({
                  url: construct_django_url('/prodtask/get_steps_bulk_info/', "{{ pr_id }}"),
                  type: 'POST',
                  contentType: 'application/json; charset=utf-8',
                  data: $.toJSON(sendData),
                  dataType: 'text',
                  success: function (data, status) {
                      fillStepBulkChange($.evalJSON(data).result,'storeBulk');
                      $('#stepsApprovedBulk').html($.evalJSON(data).stepsApproved);
                      $('#stepsToChangeBulk').html($.evalJSON(data).stepsToChange);
                  }
              });
            $.ajaxSetup({async: true});
        }
        function saveStepsBulk(event){
            event.preventDefault();
            if ($('#amitagBulkSelect').val()!='none') {
                var sliceList = [];
                if ($('#radioSetStepBulk').val()=='all') {
                    $(".checkboxSlice").each(function () {
                        {#                   8 = "checkbox".length#}
                        var sliceID = $(this).attr("id").slice(8);
                        sliceList.push(sliceID);
                    });
                }
                else {
                    sliceList = getCheckedSlices();
                }
                var amiTag = $('#amitagBulkSelect').val();
                setStepBulkChange(sliceList, $('#chooseStepBulk').val(), amiTag);
            }
        }
        function selectContainer(event, that, step_class) {
                 event.preventDefault();
                $('.container_name.'+step_class).val($(that).val());
                $('.container_name.'+step_class).trigger('change');

        }
        function findContainers(event, step_class) {
                 event.preventDefault();
                 ami_tag =  $('.step.'+step_class).val();
                 $.ajax({
                    url: construct_django_url('/ami/sw_containers_by_amitag/', ami_tag),
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'text',
                    success: function(data,status) {
                            var containers = $.evalJSON(data);
                            if (containers.length == 1){
                                $('.container_name.'+step_class).val(containers[0]['container_name']);
                                $('.container_name.'+step_class).trigger('change');
                            }
                            if (containers.length == 0){
                                alert('No containers were found for this tag');
                            }
                            if (containers.length > 1){
                                $('.container_name.'+step_class).val(containers[0]['container_name']);
                                $('.container_name.'+step_class).trigger('change');
                                $('.containerSelectForm.'+step_class).show();
                                $('.containerSelect.'+step_class).html('');
                                for (var i=0;i<containers.length;i++){
                                      $('.containerSelect.'+step_class).append('<option  value=' +containers[i].container_name+'>'+containers[i].container_name+' (cmtconfig'+containers[i].cmtconfig+')'+'</option>');
                                }
                            }


                    },
                     error:function(data, status, error) {
                        alert("Error: can't retrieve info from AMI");
                     }

                });
        }


        function discardChangesBulk(event){
            event.preventDefault();
            $(".bulkSelect").prop('disabled', false);
            clickAmiStepBulk();
        }

        function  setStepBulkChange(slices, stepName, amiTag){
            var sendData = {slices:slices, step:stepName, amiTag:amiTag, newValues:bulkStepChanges };
                 $( "#waitingDialog" ).dialog();
              $.ajax({
                  url: construct_django_url('/prodtask/set_steps_bulk_info/', "{{ pr_id }}"),
                  type: 'POST',
                  contentType: 'application/json; charset=utf-8',
                  data: $.toJSON(sendData),
                  dataType: 'text',
                  timeout: 0,
                  success: function (data, status) {
                      $( "#waitingDialog" ).dialog('close');

                      if ($.evalJSON(data).status == 'success'){
                          clickAmiStepBulk();
                          $(".bulkSelect").prop('disabled', false);
                      } else {
                          $('#errorDialogMessage').html($.evalJSON(data).error);
                           $( "#problemDialog" ).dialog("open");
                      }
                  }
              });

        }
        function changeStepBulk(){

            var sliceList =[];

            $('#amitagBulkSelect').html('');
            if ($('#radioSetStepBulk').val()=='all'){
                $(".checkboxSlice").each(function(){
                    {#                   8 = "checkbox".length#}
                    var sliceID = $(this).attr("id").slice(8);
                    sliceList.push(sliceID);
                });
            }
            else{
                sliceList = getCheckedSlices();
            }
            fillTagsForStep(sliceList,$('#chooseStepBulk').val());
            clickAmiStepBulk();
        }
        function clickAmiStepBulk(){
            if ($('#amitagBulkSelect').val()!='none') {
                var sliceList = [];
                if ($('#radioSetStepBulk').val()=='all') {
                    $(".checkboxSlice").each(function () {
                        {#                   8 = "checkbox".length#}
                        var sliceID = $(this).attr("id").slice(8);
                        sliceList.push(sliceID);
                    });
                }
                else {
                    sliceList = getCheckedSlices();
                }
                var amiTag = $('#amitagBulkSelect').val();
                getStepBulkChange(sliceList, $('#chooseStepBulk').val(), amiTag);
            } else {
                $('.storeBulk').val('');
                $('.storeBulk').attr('placeholder','');
              $('#stepsApprovedBulk').html('0');
              $('#stepsToChangeBulk').html('0');
                bulkStepChanges = {};
            }

        }


        function saveOneSlice(event){
            event.preventDefault();
            var slices = workingOnSlices;
            var sliceID=$('#sliceModalSlice').html();
            if (!slices.includes((sliceID))){
                slices.push(sliceID);
            }
            approveSlices(false,99,99,slices);
        }
        function checkSliceIsSaved(sliceNumber){
            var is_equal = undefined;
            var step_types = undefined;
            var slice_data = {};
            $.ajaxSetup({async: false});
            $.get(construct_django_url('/prodtask/slice_steps/',"{{ pr_id }}",sliceNumber),function(data,status){
                step_types = data.step_types;
                slice_data['datasetName'] = data.dataset;
                slice_data['jobOption'] = data.jobOption;
                slice_data['eventsNumber'] = data.totalEvents;
                slice_data['comment']=data.comment;
                is_equal = true;
                var current_step_tag = [];
                for (var i=0;i<{{ step_list|length }};i++){
                    step_id = "#short" + sliceNumber + 's' + i.toString();
                    if ($(step_id).attr('class') == "notShowFullSpan" ){
                        current_step_tag.push({
                            step: $(step_id).children('a').html(),
                            step_type: 'foreign'
                        });

                    } else{

                            var current_type = '';
                            if ($(step_id).css("background-color") == $("#skippedColor").css("background-color")) {
                                current_type = 'is_skipped';
                            } else {
                                current_type = 'not_skipped';
                            }
                            current_step_tag.push({
                                step: $(step_id).html(),
                                step_type: current_type
                            });

                    }
                }

                for (var i=0;(i<step_types.length) ;i++){
                        no_changes = clearChanges(parseInt(sliceNumber),i,step_types[i]);

                        if (!(no_changes)){
                            is_equal = false;
                        }

                        if ((step_types[i].step != '') || (current_step_tag[i].step != '')){
                            if ((step_types[i].step != current_step_tag[i].step) || (step_types[i].step_type != current_step_tag[i].step_type) || !(no_changes)) {
                                is_equal = false;
                            }
                        }

                }
                is_equal = clearChangesSlice(parseInt(sliceNumber),slice_data);
            });
            $.ajaxSetup({async: true});
            return {is_equal:is_equal,db_step_type:step_types, datasetName:slice_data['datasetName'],comment:slice_data['comment'], jobOption:slice_data['jobOption'], eventsNumber: slice_data['eventsNumber'] };
        }

        function clearChangesSlice(sliceNumber, sliceData){
            var no_changes = true;

            if (sliceNumber in changesList){
                for (var field in sliceData){
                    if (field in changesList[sliceNumber]){
                        if (changesList[sliceNumber][field] != undefined){
                            if (changesList[sliceNumber][field] != sliceData[field]){

                                no_changes = false;
                            }else{
                                   changesList[sliceNumber][field] = undefined;
                               }
                        }
                    }
                }

            }
            return no_changes;
        }

        function clearChanges(sliceNumber,i,current_step){
            var no_changes = true;
            if (sliceNumber in changesList){
                if (changesList[sliceNumber].stepsInSlice.length > i){
                    current_changes = changesList[sliceNumber].getStepByNumber(i);
                    for (fieldName in current_step){
                        if (fieldName in current_changes){
                            if (current_changes[fieldName] != undefined){
                               if  (current_changes[fieldName] != current_step[fieldName]){
                                   no_changes = false;
                               }else{
                                   current_changes[fieldName] = undefined;
                               }
                            }
                        }
                    }
                }
            }
            return no_changes;
        }
        function saveBulkStepChanges(that){
            if(changeMode) {
                $(".bulkSelect").prop('disabled', 'disabled');
                var currentClass = $(that).attr("class").replace("storeBulk", '').replace(' ','');
                $(that).parent().css({'color': 'red'});
                if(currentClass.replace(",",'') != 'onlyTagsForFC'){
                    bulkStepChanges[currentClass.replace(",",'')] = $(that).val();
                } else{
                    bulkStepChanges[currentClass.replace(",",'')] = $(that).prop('checked');
                }

            }
        }

        function saveBulkSliceChanges(that){
            if(changeMode) {
                var currentClass = $(that).attr("class").replace("storeSliceBulk", '').replace(' ','');
                $(that).parent().css({'color': 'red'});
                bulkSliceChanges[currentClass.replace(",",'')] = $(that).val();
            }
        }
        function saveSlicedBulk(event){
            event.preventDefault();
            var slices = getCheckedSlices();
            for(key in bulkSliceChanges){
                $('.storeOutputSlice.'+key).val(bulkSliceChanges[key]);
            }
            for(var i=0;i<slices.length;i++){
                 $('#sliceModalSlice').html(slices[i]);
                 for(key in bulkSliceChanges){
                     changeSliceChanges($('.storeOutputSlice.'+key));
                 }
            }
            approveSlices(false,99,99,slices);
            changeMode = false;
            $('#slicesBulkChangeModal').foundation('reveal', 'close');

        }

        function changeSliceSaveStatus(sliceNumber){
            sliceDBInfo = checkSliceIsSaved(sliceNumber);
            if (! sliceDBInfo.is_equal){
                $("#saveStatus"+sliceNumber).html("edit (not saved)");
            }else{
                $("#saveStatus"+sliceNumber).html("edit (saved)");
            }
            fromPreviousSlice = false;


            return sliceDBInfo;
        }

        function saveRequestStatus(event){
            event.preventDefault();
            if ($('#requestStatus').html()=='approved'){
                alert('"approved" status could not be changed manually');
            } else {
                $('#loadStatusHistory').spin('small');
              $.ajax({
                    url:construct_django_url('/prodtask/change_production_request_status/',"{{ pr_id }}",$('#chooseNewStatus').val()),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: {},
                    dataType: 'text',
                    success: function(data,status) {
                        $('#loadStatusHistory').spin(false);
                        var newStatus =  $.evalJSON(data).newStatus;
                        if (newStatus==undefined){
                            $('#requestStatusUpatde').html('Problem this request status update');
                        } else {
                            $('#requestStatusUpatde').html('Request status was changed to '+newStatus);
                            if (newStatus != $('#requestStatus').html()) {
                                $('#requestStatus').html(newStatus);
                        }
                        }

                    }

                });
            }
        }
        function cloneRequest(event){
            event.preventDefault();
            var sliceList=[];
            if ($('#radioCloneAll').is(':checked')){
                $(".checkboxSlice").each(function(){
                    {#                   8 = "checkbox".length#}
                    var sliceID = $(this).attr("id").slice(8);
                    sliceList.push(sliceID);
                });
            }
            else{
               sliceList = getCheckedSlices();
            }
            var description = $('#newDescription').val();
            var newRef = $('#newLink').val();
            var newProject = $('#chooseNewCloneProject').val();
            var url = construct_django_url('/prodtask/request_clone2/',"{{ pr_id }}");
            if ($('#asyncRequestClone').prop('checked')){
                url = construct_django_url('/prodtask/request_clone_async/',"{{ pr_id }}");
            }
            var sendData = {slices:sliceList,description:description,ref:newRef,project:newProject};
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    timeout: 0,
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');


                       var newRequestID = $.evalJSON(data).new_request;
                       var is_good =  $.evalJSON(data).success;

                        if(is_good){
                           window.location.href = construct_django_url('/prodtask/inputlist_with_request/',newRequestID.toString());
                        }
                        }
                    }

                );
        }
        function cloneSlicesClick(event, makeLink, cloneFromStepNumber){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;

            var sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: construct_django_url('/prodtask/clone_slices_in_req/',"{{ pr_id }}",cloneFromStepNumber,makeLink),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    timeout: 0,
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };

        function retrySlicesClick(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;
            var sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: construct_django_url('/prodtask/retry_slices/',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    timeout: 0,
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                            location.reload();
                        }
                    }
                );
              return false;
        };

        function showTasksFromSlices(sliceList) {
            $("#waitingDialog").dialog();
            $.ajax({
                        url: construct_django_url('/prodtask/form_tasks_from_slices/', "{{ pr_id }}"),
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sliceList),
                        dataType: 'text',
                        success: function (data, status) {
                            $("#waitingDialog").dialog('close');
                            var slices_str =  $.evalJSON(data).slices_range;
                            window.location.href = construct_django_url('/reqtask/',"{{ pr_id }}",slices_str);

                        }
                    }
            );
        }

        function  showTasks(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();

            showTasksFromSlices(sliceList)
        }

        function splitSlicesByTIDClick(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;
            var sendData = {slices:sliceList};
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: construct_django_url('/prodtask/split_slices_by_tid/',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        }


        function splitSlicesByOutputClick(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;
            var sendData = {slices:sliceList};
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: construct_django_url('/prodtask/split_slices_by_output/',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        }

        {#    function findParentClick(event, parentRequestNumber){#}
        {#        event.preventDefault();#}
        {#        var sliceList = getCheckedSlices();#}
        {#        var i=0;#}
        {##}
        {#        var sendData = {slices:sliceList};#}
        {#          $( "#reloadDialog" ).dialog();#}
        {#          $.ajax({#}
        {#                url: construct_django_url('/prodtask/find_parent_slices/',"{{ pr_id }}",parentRequestNumber),#}
        {#                type: 'POST',#}
        {#                contentType: 'application/json; charset=utf-8',#}
        {#                data: $.toJSON(sendData),#}
        {#                dataType: 'text',#}
        {#                timeout: 0,#}
        {#                success: function(data,status) {#}
        {#                    $( "#reloadDialog" ).dialog('close');#}
        {#                    if(status){#}
        {#                        location.reload();#}
        {#                    }#}
        {#                    }#}
        {#                }#}
        {#            );#}
        {#          return false;#}
        {#};#}

            function findParentClick(event, parentRequestNumber, useAsync){
                event.preventDefault();
                var sliceList = getCheckedSlices();
                var sendData = {slices:sliceList};

                if (useAsync){
                    var url = construct_django_url('/prodtask/async_find_parent_slices/',"{{ pr_id }}",parentRequestNumber);
                    sendAsyncTask(url,sendData);
                } else {
                    $( "#reloadDialog" ).dialog();
                    $.ajax({
                            url: construct_django_url('/prodtask/find_parent_slices/',"{{ pr_id }}",parentRequestNumber),
                            type: 'POST',
                            contentType: 'application/json; charset=utf-8',
                            data: $.toJSON(sendData),
                            dataType: 'text',
                            timeout: 0,
                            success: function(data,status) {
                                $( "#reloadDialog" ).dialog('close');
                                if(status){
                                    location.reload();
                                }
                            }
                        }
                    );
                    return false;
                }
            }

            function changeParentClick(event, changeSliceNumber){
                event.preventDefault();
                var i=0;
                var sliceList = getCheckedSlices();

                var sendData = {slices:sliceList};
                  $( "#reloadDialog" ).dialog();
                  $.ajax({
                        url: construct_django_url('/prodtask/change_parent/',"{{ pr_id }}",changeSliceNumber),
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        timeout: 0,
                        success: function(data,status) {
                            $( "#reloadDialog" ).dialog('close');
                            if(status){
                                location.reload();
                            }
                            }
                        }
                    );
                  return false;
        };


        function splitSlicesClick(event, splitNumber){
            event.preventDefault();
            var i=0;
            var sliceList = getCheckedSlices();
            var sendData = {slices:sliceList,divider:splitNumber};
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: construct_django_url('/prodtask/split_slices_in_req/',"{{ pr_id }}"),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    timeout: 0,
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };
        function showModalClone(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;
            $('#allClone').html('All'+'('+$('.checkboxSlice').length+')');
            if($('.checkboxSlice').length>20){
                $('#asyncRequestClone').prop('checked',true);
            }


            $('#selectClone').html('Only selected'+'('+sliceList.length+')');
            $('#chooseNewCloneProject').val("{{ trequest.project }}");
             $('#cloneModal').foundation('reveal', 'open');

        }

        function showModalDatasetInfo(event, sliceNumber){
            event.preventDefault();
            $('#datasetsInfoList').html('');
            $('#datasetsInfoLoad').show();
             $('#datasetInfoWindow').foundation('reveal', 'open');
            $.ajax({
                    url: construct_django_url('/prodtask/dataset_slice_info/',"{{ pr_id }}",sliceNumber),
                    type: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'text',
                    success: function(data,status) {
                        var datasetList =  $.evalJSON(data).data;
                        for (i=0;i<datasetList.length;i++){
                            var datasetRow = $('<tr class=' +  datasetList[i].currentCampaign +' ></tr>');
                            datasetRow.append('<td><a href="https://rucio-ui.cern.ch/did?name='+
                                    datasetList[i].dataset+'">'+datasetList[i].dataset+ '</a></td>');
                            datasetRow.append('<td>'+'<a href="{{ bigpanda_base }}'+datasetList[i].input_task+'">'+datasetList[i].events+'</a>'+'</td>');
                            datasetRow.append('<td>'+datasetList[i].SubCampaing+'</td>');

                            var tasksCell = $('<td></td>');

                            for(j=0;j<datasetList[i].Tasks.length;j++){
                                tasksCell.append('<a href="{{ bigpanda_base }}'+datasetList[i].Tasks[j]+'">'+datasetList[i].Tasks[j]+'</a>');
                            }
                                     datasetRow.append(tasksCell);
                            $('#datasetsInfoList').append(datasetRow);
{#                            tasksCell = $('<td></td>');#}
{##}
{#                            for(j=0;j<datasetList[i].otherTasks.length;j++){#}
{#                                tasksCell.append('<a href="{{ bigpanda_base }}'+datasetList[i].otherTasks[j]+'">'+datasetList[i].otherTasks[j]+'</a>');#}
{#                            }#}
{#                                     datasetRow.append(tasksCell);#}
{#                            $('#datasetsInfoList').append(datasetRow);#}

                        }
                       $('#datasetsInfoLoad').hide();


                    }
                });

        }

         function rejectSlicesClick(event){
            event.preventDefault();
            var sliceList = getCheckedSlices();
            var i=0;
            sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:reject_slices_in_req' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    timeout: 0,
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };
        function savePriorityRequest(event,priority){
            event.preventDefault();
            var new_priority = $('#managementPriorityChange'+priority).val();
            if (new_priority!=priority){
                $( "#reloadDialog" ).dialog();
                $.ajax({
                    url: construct_django_url('/prodtask/change_request_priority/',"{{ pr_id }}",priority,new_priority),
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: {},
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                            location.reload();
                        }
                    }
                );
            }

              return false;
        }

        function closeOpenEnded(event){
            event.preventDefault();
            var sliceList=[];

            sendData = [];
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:close_open_ended' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
        }
        function makeOpenEnded(event){
            event.preventDefault();
            var sliceList=[];

            sendData = [];
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:make_open_ended' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
        }

         function hideClick(event){
            event.preventDefault();
            var i=0;
            var sliceList = getCheckedSlices();

            sendData = sliceList;
              $( "#reloadDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:hide_slices_in_req' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#reloadDialog" ).dialog('close');
                        if(status){
                            location.reload();
                        }
                        }
                    }
                );
              return false;
        };

        function closeDeftRef(event){
            event.preventDefault();
            sendData = {'close':true};
              $.ajax({
                    url: "{% url 'prodtask:close_deft_ref' pr_id %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $('#closeDeftRef').css({'display':'none'});
                        $('#deftRef').css({'display':'none'});
                    }
              });
              return false;
        };
    ;(function(factory) {

  if (typeof exports == 'object') {
    // CommonJS
    factory(require('jquery'), require('spin.js'))
  } else if (typeof define == 'function' && define.amd) {
    // AMD, register as anonymous module
    define(['jquery', 'spin'], factory)
  } else {
    // Browser globals
    if (!window.Spinner) throw new Error('Spin.js not present')
    factory(window.jQuery, window.Spinner)
  }

}(function($, Spinner) {

  $.fn.spin = function(opts, color) {

    return this.each(function() {
      var $this = $(this)
        , data = $this.data()

      if (data.spinner) {
        data.spinner.stop()
        delete data.spinner
      }
      if (opts !== false) {
        opts = $.extend(
          { color: color || $this.css('color') }
        , $.fn.spin.presets[opts] || opts
        )
        data.spinner = new Spinner(opts).spin(this)
      }
    })
  }

  $.fn.spin.presets = {
    tiny:  { lines:  8, length: 2, width: 2, radius: 3 }
  , small: { lines:  8, length: 4, width: 3, radius: 5 }
  , large: { lines: 10, length: 8, width: 4, radius: 8 }
  }

}));
        function spreadAMI(that){
            currentStep = $(that).attr("class").replace("storeInput",'').replace("step",'').replace(' ','').slice('storeOutput'.length).replace(' ','');
            currentSlice = $('#sliceModalSlice').html();
            $("#short"+currentSlice+"s"+currentStep).html($(that).val());
            $("#short"+currentSlice+"s"+currentStep).css({"background-color":$("#doColor").css("background-color")});
            $("#"+currentSlice+"s"+currentStep+".slice_form").val($(that).val());
            $("#step"+currentSlice+"s"+currentStep+".stepchoose").css({"background-color":$("#doColor").css("background-color")});

        }

        function spreadSkipped(that){
            currentStep = $(that).attr("class").replace("storeInput",'').replace("skipped",'').replace(' ','').slice('storeOutput'.length).replace(' ','');
            currentSlice = $('#sliceModalSlice').html();
            if($(that).is(':checked')){
                $("#short"+currentSlice+"s"+currentStep).css({"background-color":$("#skippedColor").css("background-color")});
            } else{
                 $("#short"+currentSlice+"s"+currentStep).css({"background-color":$("#doColor").css("background-color")});
            }

        }
        function extendRequest(event){
            event.preventDefault();
            $('#extendModalWindow').foundation('reveal', 'open');

        }
        function changeExtendtoCheck(){
            $('#sliceExtend').html('');
            $('#stepsExtend').html('');
            $('#checkExtend').html('Check');
        }
        function checkExtendRequest(event, that){
            event.preventDefault();
            $('#loadExtend').spin('small');
            var sendData = {'spreadsheet':$('#extendSpreadsheet').val(),'is_new':$('#new_extend_workflow').prop('checked')};

            if ($(that).html() == 'Check'){
                  $.ajax({
                        url: "{% url 'prodtask:check_extend_request' pr_id %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        success: function(data,status) {
                            $('#loadExtend').spin(false);
                            var return_status =  $.evalJSON(data).success;
                            if(return_status){
                                $('#sliceExtend').html('New slices: '+$.evalJSON(data).slices_number);
                                $('#stepsExtend').html('New steps: '+$.evalJSON(data).steps_number);
                                $('#checkExtend').html('Extend');
                            } else {
                                alert($.evalJSON(data).message);
                            }
                        }
                  });
            }else {
                  $.ajax({
                        url: "{% url 'prodtask:extend_request' pr_id %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        success: function(data,status) {
                            $('#loadExtend').spin(false);
                            var return_status =  $.evalJSON(data).success;
                            if(return_status){
                                 location.reload();
                            } else{
                                alert($.evalJSON(data).message);
                            }
                        }
                  });
            }

        }


        function showModalComment(event){
                event.preventDefault();
            $.ajaxSetup({async: false});
            $.get("{% url 'prodtask:request_comments' pr_id %}",function(data,status){
                $('#commentList').html('');
                var comments = data.comments;
                for (var i=0;i<comments.length;i++){
                    $('#commentList').prepend('<li>'+comments[i]+'</li>');
                }
            });
            $.ajaxSetup({async: true});
                $('#commentModalWindow').foundation('reveal', 'open');
            }
            function showModalInputErrors(event){
                event.preventDefault();
                $.ajaxSetup({async: false});
                $.get("{% url 'prodtask:input_with_slice_errors' pr_id %}",function(data,status){

                    var inputErrors = data.input_errors;
                    if (inputErrors !== undefined){
                        $('#inputErrorsList').html(inputErrors.join('\n'));
                    }
                });
                $.ajaxSetup({async: true});
                $('#inputErrorsModalWindow').foundation('reveal', 'open');
            }
        function removeHashTag(hashtag){

            removeUrl = construct_django_url('/prodtask/remove_hashtag_request/', {{ pr_id }});
            var sendData = {'hashtag':hashtag};

            $.post(removeUrl,$.toJSON(sendData), function(data,status){
                var newHashtags =data.data;
                $('.hashtags').html(newHashtags.html);
                $('.hashtags').attr('href',construct_django_url('/prodtask/request_hashtags_outputs/', newHashtags.href));
                redoHashtagList();
            });
        }
        function redoHashtagList(){
            $.ajaxSetup({async: false});
            $.get("{% url 'prodtask:hashtags_by_request' pr_id %}",function(data,status){
                $('#hashtagList').html('');
                var hashtagList = data.hashtags;
                for (var i=0;i<hashtagList.length;i++){
                    $('#hashtagList').prepend('<li>'+hashtagList[i]+' <a class="button" onclick=removeHashTag("'+ hashtagList[i]+'");>(-)</a></li>');
                }
            });
            $.ajaxSetup({async: true});
        }
        function showModalHashTag(event){
            if(event!=undefined) {
                event.preventDefault();
            }
                        redoHashtagList();
                $('#hashtagModalWindow').foundation('reveal', 'open');
            }
        function createReprocessing(event){
            event.preventDefault();
            var sendData = {slices:getCheckedSlices()};
            $.ajax({
                        url: "{% url 'prodtask:reprocessing_object_form' pr_id %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        timeout: 0,
                        success: function(data,status) {
                            var return_status =  $.evalJSON(data).success;
                            var return_url = $.evalJSON(data).url;
                            if(return_status){
                                window.location.href = return_url;
                            } else{
                                alert($.evalJSON(data).message);
                            }
                        }
                  });
        }
        function syncTasksJEDI(event){
            event.preventDefault();
            var sendData = {slices:getCheckedSlices()};
            $( "#reloadDialog" ).dialog();
            $.ajax({
                        url: "{% url 'prodtask:sync_request_tasks' pr_id %}",
                        type: 'GET',
                        contentType: 'application/json; charset=utf-8',
                        timeout: 0,
                        success: function(data,status) {
                            location.reload();

                        },
                        error: function(data,status) {
                            alert(status);

                        }
                  });
        }

        function checkParentTrain(){
             $('#errorTrainMessage').html('');
             $('#makeTrainsButton').hide();
            var sliceList = getCheckedSlices();

            $('#loadTrain').spin('small');
            if($('#trainParentStep').length){
                var sendData = {slices:sliceList,step_number:$('#trainParentStep').val(),production_request:'{{ pr_id }}',
                train_id:$('#trainPatternRequest').val()};
            }else{
                var sendData = {slices:sliceList,train_id:$('#trainPatternRequest').val(),step_number:-1,production_request:'{{ pr_id }}'};
            }

            $('#trainSlices').html(sliceList.toString());

                  $.ajax({
                        url: "{% url 'prodtask:check_slices_for_trains'  %}",
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: $.toJSON(sendData),
                        dataType: 'text',
                        timeout: 0,
                        success: function(data,status) {
                            $('#loadTrain').spin(false);
                            var return_status =  $.evalJSON(data).success;
                            if(return_status){
                                $('#makeTrainsButton').show();
                            } else{
                                $('#errorTrainMessage').html($.evalJSON(data).message);
                            }
                        }
                  });
        }
        function changeParentTrainStep(){
            checkParentTrain();
        }
        function showTrainExtendModal(event){
            event.preventDefault();
            $.ajaxSetup({async: false});
            $.get("{% url 'prodtask:request_train_patterns' pr_id %}",function(data,status){
                $('#trainPatternRequest').html('');
                var patterns = data;
                for (var i=0;i<patterns.length;i++){
                    $('#trainPatternRequest').append('<option  value=' +patterns[i].train_id+'>'+patterns[i].name+'</option>');
                }
            });
            $.ajaxSetup({async: true});
            checkParentTrain();

            $('#trainModalWindow').foundation('reveal', 'open');
        }
        function showOwnerChangeModal(event){
            event.preventDefault();
            $('#changeOwnerWindow').foundation('reveal', 'open');
        }
function changeStatusFilter(){

       var valThis = $('#filter').val().toLowerCase();
    var statusFilterValue = $('#statusFilter').val();
    if((valThis == "")){
           $(".inputListDivs").show();
       } else{
        $(".inputListDivs").hide();
        if ($("#filterType").val()!='tag'){

           $(".filterField").each(function(){
              if($(this).text().toLowerCase().indexOf(valThis)>=0){
                  $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().show();
              }
           });
        } else {
           $(".filterTag").each(function(){
              if($(this).text().toLowerCase().indexOf(valThis)>=0){
                  $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().show();
              }
           });
        }

       }


        switch (statusFilterValue) {
            case  '!submitted':
                $('.StatusFilter').each(function(){
                  if($(this).html()=='submitted'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }
               });
                break;
            case  'error_slices':
                $('.noSliceError').each(function(){
                        $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                });
                break;
            case  'partially_submitted':
                $('.StatusFilter').each(function(){
                  if($(this).html()!='partially_submitted'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }
               });
                break;
            case  'not_submitted':
                $('.StatusFilter').each(function(){
                  if($(this).html()!='not_submitted'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }
               });
                break;
            case 'running_tasks':
                $('.TaskStatusFilter').each(function(){
                  if($(this).html()!='running'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }});
                 break;
            case 'no_running_tasks':
                $('.TaskStatusFilter').each(function(){
                    if($(this).html()!='No running'){
                        $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                    }});
                break;
            case 'exhausted':
                $('.ExhStatusFilter').each(function(){
                    if($(this).html()!='exists'){
                        $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                    }});
                break;

            case 'aborted_tasks':
                $('.RedStatusFilter').each(function(){
                    if($(this).html()!='exists'){
                        $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                    }});
                break;
            case 'no_tasks':
                $('.TaskStatusFilter').each(function(){
                  if($(this).html()!='no_tasks'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }
               });
                 break;
            case 'waiting':
                $('.ActionStatusFilter').each(function(){
                  if($(this).html()!='exists'){
                      $(this).parentsUntil(".inputListDivs").filter(".outsideInputListTables").parent().hide();
                  }
               });
                break;
        }



}
function changeSortSelect(sortType){
  switch (sortType) {
             case  'sliceID':
                 sortBySliceID();
                break;
            case  'dataset':
                sortByJobOption('DatasetSort','inputDatasetName');
                break;
            case  'JO':
                sortByJobOption('JOSort','sliceInputJobOptions');
                break;
  }
}
function sortBySliceID(){
    var sliceIDs = $.extend([],sliceOrder);
    sliceIDs.sort(function(a,b){return parseInt(a)-parseInt(b)});
    moveSlices(sliceIDs);
}

function sortByJobOption(sortClassName,sortElementName){
    var JOTuple = [];
{#    JOSort#}
    $('.'+sortClassName).each(function(){
{#        sliceInputJobOptions#}
        var sliceID = $(this).attr("id").slice(sortElementName.length);
        JOTuple.push([sliceID,$(this).attr('title')]);
    });

    JOTuple.sort(function(a,b){
        if (a[1]==b[1]) {
            return a[0]-b[0]
        }else{
            return a[1].localeCompare(b[1])
    }
    });

    var JOSorted=[];
    for(var i=0;i<JOTuple.length;i++){
        JOSorted.push(JOTuple[i][0]);
    }

    moveSlices(JOSorted);
}



function moveSlices(newOrder){
    for(var i=0;i<newOrder.length;i++){
        $('#baseInput').append($('#inputList_div'+newOrder[i]));
    }
    changeSliceOrder();

}
function changeSliceOrder(){
     sliceOrder = [];
    $(".checkboxSlice").each(function () {
                    {#                   8 = "checkbox".length#}
                    var sliceID = $(this).attr("id").slice(8);
                        sliceOrder.push(sliceID);
                });
}
var sliceOrder = [];
function changeSliceChanges(that){
    if(changeMode) {
        currentClass = $(that).attr("class").replace("storeInput", '').split(' ');
        $(that).parent().css({'color': 'red'});
        var currentStepNumber = '';
        var currentField = '';
        var isSliceData = false;
        for (i = 0; i < currentClass.length; i++) {
            if (currentClass[i] != '') {
                if (currentClass[i].lastIndexOf('storeOutputSlice', 0) === 0) {
                    isSliceData = true;
                }
                else if (currentClass[i].lastIndexOf('storeOutput', 0) === 0) {
                    currentStepNumber = currentClass[i].slice('storeOutput'.length);
                    currentHTML = $("#sectionName" + currentStepNumber).html();

                    if (currentHTML.indexOf('*') == -1) {
                        $("#sectionName" + currentStepNumber).html(currentHTML + '*');
                    }
                }
                else {
                    currentField = currentClass[i];
                }
            }
        }
        currentSlice = $('#sliceModalSlice').html();
        if (!(currentSlice in changesList)) {
            changesList[currentSlice] = new RequestSlice();
        }
        if (isSliceData) {
            changesList[currentSlice][currentField] = $(that).val();
            $('.change' + currentField + currentSlice.toString()).html(changesList[currentSlice][currentField]);
            $('.change' + currentField + currentSlice.toString()).attr('title',changesList[currentSlice][currentField]);
            if (currentField=='jobOption'){
                makeJobOptionURL();
            }

        } else {

            if (changesList[currentSlice].stepsInSlice.length < (parseInt(currentStepNumber) + 1)) {
                for (i = changesList[currentSlice].stepsInSlice.length; i < (parseInt(currentStepNumber) + 1); i++) {
                    var newStep = new ProcessingStep();
                    changesList[currentSlice].addStep(newStep);
                }
            }
            var currentChangeStep = changesList[currentSlice].getStepByNumber(parseInt(currentStepNumber));
            if (currentField=='onlyTagsForFC'){
                currentChangeStep[currentField] = $(that).prop('checked');
            } else{
                currentChangeStep[currentField] = $(that).val();
            }

        }
    }
};


function ProcessingStep() {
  this.step = undefined;
  this.ctag = undefined;
  this.output_formats = undefined;
  this.input_format = undefined;
  this.status = undefined;
  this.priority = undefined;
  this.memory = undefined;
  this.nEventsPerJob = undefined;
  this.nEventsPerInputFile = undefined;
  this.project_mode = undefined;
  this.token = undefined;
  this.position = undefined;
  this.status = undefined;
  this.input_events = undefined;
  this.merging_tag = undefined;
  this.nFilesPerMergeJob = undefined;
  this.nEventsPerMergeJob = undefined;
  this.nGBPerMergeJob = undefined;
  this.nMaxFilesPerMergeJob = undefined;
  this.nFilesPerJob = undefined;
  this.predifinitionActionParameters = undefined;
  this.predifinitionAction = undefined;
};

 function RequestSlice(sliceNumber) {
    this.stepsInSlice = [];
    this.sliceNumber = sliceNumber;
    this.datasetName = undefined;
    this.jobOption = undefined;
    this.eventsNumber = undefined;
    this.comment = undefined;
};

RequestSlice.prototype.addStep = function(newStep){
      this.stepsInSlice.push(newStep);
};

RequestSlice.prototype.getStepByNumber = function(stepNumber){
  if( this.stepsInSlice.length > stepNumber){
      return this.stepsInSlice[stepNumber];
  } else {
      throw 'Wrong step number';
  }
};
var bulkSliceChanges = {};
var bulkStepChanges = {};
var changesList = {};
var patternDict = [];
var changeMode = true;
var lastCheckedSlice = -1;
var lastChecked = true;
var splitSlices = [];
var suspectSplit = [];
var workingOnSlices = [];
var fromPreviousSlice = false;
var celery_task = undefined;
var NOTRUNNING = ['finished','done','obsolete','aborted','failed','broken'];
var REDTASKSTATUS = ['aborted','failed','broken'];
function ProjectModeForm(parentDiv, inputField){
    this.parentDiv = parentDiv;
    this.inputField = inputField;
    this.possibleParameters = [
        {name:'cmtconfig',type:'string'},
        {name:'skipScout',type:'boolean'},
        {name:'corecount',type:'integer'}
    ];

}

ProjectModeForm.prototype.createForm = function(inputString){
 this.parentDiv.append('')
};
</script>

<div id="approveDialog" style="display: none">
    <span></span>
</div>
 <div id="problemDialog" title='Error' style="display: none">
    <span>Something has gone wrong!</span><span id="errorDialogMessage"></span>
</div>
<div id="waitingDialog" title="Run" style="display: none">
  <p>Please wait...</p>
</div>
    <div id="progressInputFind" title="Run" style="display: none">
        <p>Inputs ready:</p><span id="inputsCount"></span>
    </div>
    <div id="progressSliceSaved" title="Run" style="display: none">
        <p>Slices saving:</p><span id="processedCount"></span>
    </div>
<div id="reloadDialog" title="Run" style="display: none">
  <p>Page reloading</p>
</div>
<div class="row">
<div class="large-12">
<table>
<tr>
  <th></th>
  <th>Request ID:</th>
  <th>Description:</th>
  <th>Reference:</th>
  <th>Manager:</th>
  <th>Physic group:</th>
{% ifequal trequest.request_type "MC" %}
 <th>SubCampaign Project:</th>
    {% else %}
    <th>Project:</th>
{% endifequal %}

    <th>
    {% ifequal trequest.request_type "MC" %}
        Priorities:
    {% endifequal %}
    </th>
  <th>Status:</th>
    <th>DEFT:</th>
</tr>
<tr>
  <td><a href="#" data-dropdown="drop1" >menu(&#9776;)</a>
      <ul id="drop1" class="f-dropdown" data-dropdown-content>
        {% if user.is_authenticated %}
          <li><a href="{% url 'prodtask:request_update' pr_id %}">Update</a></li>
          <li><a href="#" onclick="showModalClone(event);">Clone</a></li>
            <li><a href="#" onclick="extendRequest(event);">Extend</a></li>
          <li><a href="#" onclick="approveEmpty(event);">Approve</a></li>
            {% if not is_open_ended %}
                <li><a href="#" onclick="makeOpenEnded(event);">Make Open Ended</a></li>
            {% else %}
                <li><a href="#" onclick="closeOpenEnded(event);">Close Open Ended</a></li>
            {% endif  %}
                <li><a href="#" onclick="createReprocessing(event);">Create base on this</a></li>
             <li><a href="#" onclick="syncTasksJEDI(event);">Sync tasks with JEDI</a></li>
        {% else %}
          <li><a href="{% url 'prodtask:login' %}?next={{ request.get_full_path|urlencode }}">Login</a></li>
        {% endif %}
    </ul>
  </td>
  <td>{{ trequest.reqid}}</td>
  <td>{{ trequest.description}}</td>
  <td><a href='{{trequest.ref_link}}' id='request_link'>{{ trequest.ref_link}}</a></td>
  <td><span id="ownerName">{{ trequest.manager}}</span><a class='button tiny btn_is_authenticated' onclick="showOwnerChangeModal(event);"><i class="fa fa-edit"></i></a></td>
  <td>{{ trequest.phys_group}}</td>
{% ifequal trequest.request_type "MC" %}
  <td id="requestProject">{{ trequest.campaign}}:{{ trequest.subcampaign}} {{ trequest.project}}</td>
    <td>

            {{ priorities_str }}

    </td>
    {% else %}
   <td id="requestProject">{{ trequest.project}}</td>
  <td></td>
{% endifequal %}
    <td><a onclick="showStatusHistory(event);"><u><span  style="cursor: pointer;" id="requestStatus">{{ trequest.cstatus}}</span></u></a></td>
    <td>
        {% if jira_problem_link %}
            <u><a href="https://its.cern.ch/jira/browse/{{ jira_problem_link }}" target="_blank">JIRA</a></u>
        {% endif %}
        </tr>
</table>
</div>
</div>
<div>
    <div class="row">
        <div class="large-2 column"><a id='hashtagWork' class="button prefix" onclick="showModalHashTag(event);">Add/Del #</a></div>
        <div class="large-10 column"><span>HashTags: <a class="hashtags" href="">{{ hashtags_string }}</a></span></div>


    </div>
</div>
<div>
    <div class="row">
        <div class="large-5 column"><span>last comment: <span id="lastComment">{{ comment_author }}-{{ last_comment }}</span></span></div>
        <div class="large-2 column"><a class="button postfix" onclick="showModalComment(event);">New comment</a></div>
         <div class="large-5 column"></div>
    </div>
</div>
<div class="row">
<div class="large-12">
    <a onclick="$('#longDescription').toggle('slow')" style="cursor: pointer;"><u>Show/hide long description</u></a>
    <div id="longDescription" style="display: none">{{ long_description|linebreaks}}</div>
</div>
</div>
{% if child_requests %}
    <div class="row">
    <div class="large-12">
        <a onclick="$('#childRequests').toggle('slow')" style="cursor: pointer;"><u>Related requests: {{ child_requests|length }}</u></a>
    </div>
    </div>
        <div id="childRequests" style="display: none">
            {% for child_request in child_requests %}
                <div class="row">
                    {% if child_request.request %}
                        <div class="large-2 column"><a href= "{% url 'prodtask:input_list_approve' child_request.request %}">{{ child_request.request }}</a></div>
                    {% else %}
                        <div class="large-2 column" >None</div>
                    {% endif %}
                    {% if child_request.pattern_id %}
                    <div class="large-8 column"><a href= "{%  url 'prodtask:input_list_approve' child_request.pattern_id %}">{{ child_request.pattern_name }}</a></div>
                    {% else %}
                        {% if child_request.pattern_name %}
                            <div class="large-8 column"><span>{{ child_request.pattern_name }}</span></div>
                        {% else %}
                            <div class="large-8 column"></div>
                        {% endif %}
                    {% endif %}
                    <div class="large-2 column">{{ child_request.type }}</div>


                </div>
            {% endfor %}
        </div>


{% endif %}





    {% if needed_management_approve %}
        <div class="row">
       {% if not user.is_authenticated %}
           <div class="large-1 column">
            <a class="small radio button success"
               href="{% url 'prodtask:login' %}?next={{ request.get_full_path|urlencode }}"
            >Login</a>
            </div>
        {% else %}
            <div class="large-1 column">
            </div>
        {% endif %}
        <div class="large-3 column">
            <a id='requestRegistButton' class=" button success radius btn_is_authenticated" onclick="registerRequest(event);">PMG approval</a>
             <span id="registrationMessgae"></span>
        </div>
        <div class="large-3 column">
            <a id='requestOnHoldButton' class=" button radius  btn_is_authenticated" style="background-color:#ffce15;" onclick="onHoldRequest(event);">On hold</a>
             <span id="onHoldMessgae"></span>
        </div>
        <div class="large-3 column">
            <a id='requestCancelButton' class=" button radius alert  btn_is_authenticated" onclick="cancelRequest(event);">Cancel</a>
             <span id="cancelationMessgae"></span>
        </div>
        <div class="large-4 column">
        </div>
        </div>
        {% for manage_priority in manage_priorities %}
            <div class="row">
                <div class="large-3 column">{{ manage_priority.slices }} slices with priority: </div>
                 <div class="large-1 column">
                     <select id="managementPriorityChange{{ manage_priority.value }}" class="managementPriority" >
                         {% for priority in  priorities_list%}
                                <option value="{{ priority.value }}" >{{ priority.name }}</option>
                         {% endfor %}

                    </select>
                </div>
                <div class="large-3 column">
                    <a id='savePriority' class=" button btn_is_authenticated" onclick="savePriorityRequest(event,{{ manage_priority.value }});">Change priority</a>
                </div>
                <div class="large-5 column">
                </div>
            </div>
        {% endfor %}
    {% else %}
         <div class="row">
         <div class="large-12 column">
            <span>{{ first_approval_message }}</span>
        </div>
        </div>
    {% endif %}



{% ifequal trequest.request_type "MC" %}
    <div class="row">
        <div class="large-12 column">
            <u><a href="{{ original_spreadsheet }}" target="_blank">Original spreadsheet</a></u>
        </div>
    </div>

{% endifequal %}
{% if is_open_ended %}
    <div class="row">
<div class="large-12">
    <h6>Request is open eneded</h6>
    </div>
    </div>
{% endif %}
<div class="row">
<div class="large-12">
{% if not show_as_huge  %}
{% if hidden_slices > 0 %}
    <h6> Total input: {{ totalSlice }}, from them approved: {{ approvedCount }} and hidden: {{ hidden_slices }}</h6>
{% else %}
    <h6> Total input: {{ totalSlice }}, from them approved: {{ approvedCount }}</h6>
{% endif %}




{% endif %}
</div>
</div>

    {% if  tasks_by_status     %}
        <div class="row">
        <div class="large-10 columns">
            <table>
            <tr>
                {% for  status, number, filter in tasks_by_status%}
                    {% if filter %}
                        <th><span class="rstat tstat {{ status }}" onclick="$('#statusFilter').val('{{ filter }}');changeStatusFilter();" style="cursor: pointer;" >{{ status }}</span></th>
                    {% else %}
                        <th><span class="rstat tstat {{ status }}">{{ status }}</span></th>

                    {% endif %}
                {% endfor %}
            </tr>
            <tr>

            {% for  status, number, filter in tasks_by_status%}
                {% if filter %}
                    <th><span class="rstat tstat {{ status }}" onclick="$('#statusFilter').val('{{ filter }}');changeStatusFilter();" style="cursor: pointer;" >{{ number }}</span></th>
                {% else %}
                    <th><span class="rstat tstat {{ status }}">{{ number }}</span></th>

                {% endif %}
            {% endfor %}
            </tr>

            </table>
        </div>
            <div class="large-2 columns">
                <a class="button btn_is_authenticated" onclick="window.location.href = construct_django_url('/reqtask/','{{ pr_id }}');">Manage all</a>
            </div>
        </div>
    {% endif %}
{% if show_as_huge  %}
<u><a href="{% url "prodtask:task_table" %}#/?time_period=all&task_type=production&request={{ trequest.reqid}}">All task</a></u>

{% endif %}

    <div class="row" >
        <div class="large-2 column"><button id="select_slice_checkobx" title="Select/unselect all" onclick="selectClick(event);">Select All</button></div>
        <div class="large-2 column">
            <label>
                Filter by:
                <select id="filterType" onchange="changeStatusFilter();">
                    <option value="fields">slice data</option>
                    <option value="tag">ami tag</option>
                </select>
            </label>
        </div>
        <div class="large-4 column">
            <label>
                Filter:
                <input type="text" id="filter" >
            </label>
        </div>
        <div class="large-2 column">
            <label>
                Filter by status:
            <select id="statusFilter" onchange="changeStatusFilter();">
                <option value="all">all</option>
                <option value="error_slices">slice with errors</option>
                <option value="!submitted">hide submitted</option>
                <option value="partially_submitted">partially submitted</option>
                <option value="not_submitted">not submitted</option>
                <option value="running_tasks">running tasks</option>
                <option value="no_tasks">no tasks</option>
                <option value="waiting">actions</option>
                <option value="no_running_tasks">No running</option>
                <option value="exhausted">exhausted</option>
                <option value="aborted_tasks">aborted/broken/failed</option>
            </select>
           </label>
        </div>
        <div class="large-2 column">
            <label>
                Sort:
            <select id="sortSelect" onchange="changeSortSelect($(this).val());">
                <option value="sliceID">slice ID</option>
                <option value="dataset">dataset name</option>
                <option value="JO">job options</option>
            </select>
            </label>
        </div>
    </div>
    <div class="row">
        <div class="large-12">
{% if has_deft_problem %}
    <table>
    <tr>
    <td>
    <button class="btn_is_authenticated" id='closeDeftRef' onclick="closeDeftRef(event);">Remove</button>
        <button  onclick="$('.showSliceError').show();">Show messages</button>
        <button  onclick="$('#statusFilter').val('error_slices');changeStatusFilter();">Filter</button>
        {% ifequal trequest.request_type "GROUP" %}
            <button  onclick="showModalInputErrors(event);">Show Input</button>

        {% endifequal %}
    </td>
    <td>
        <div id="deftRef" class="alert-box alert round" ><strong >Error: </strong> <span> Some task can't be created by DEfT: </span>
    <a href="https://its.cern.ch/jira/browse/{{ jira_problem_link }}" target="_blank">{{ jira_problem_link }}</a></div>
    </td>
    </tr>
    </table>
{% endif %}
</div>
</div>
<div id="missing_tags" class="alert-box alert round" style="display: none"><strong >Error: </strong>
    <span> Please create these tags before approval: </span>
    <a href="http://panda.cern.ch/server/pandamon/query?mode=defNewTag" target="_blank"><span id="missing_tags_string"></span></a></div>
<div id="doubleTags" class="alert-box alert round" style="display: none"><strong >Error: </strong>
    <span> Please replace these old tags with double trf before approval: </span><span id="doubleTagsString"></span></div>
<div id="wrongSlice" class="alert-box alert round" style="display: none"><strong >Error: </strong>
<span> Check these slices: </span><span id="wrongSliceString"></span></div>

{% if show_as_huge %}
    <div>
    <div class="row" >
        <div class="large-12 column">Steps:</div>
    </div>
    <div class="row" >
        <div class="large-2 column">Total steps: {{ total_steps }} </div>
        <div class="large-3 column">steps approved: {{ approved_steps }} </div>
        <div class="large-8 column"></div>
    </div>
    <div class="row" >
        <div class="large-12 column">Tasks:</div>
    </div>
    <div class="row" >
        <div class="large-3 column"><span style="color: red">failed/broken/aborted {{ total_tasks.red }} </span></div>
        <div class="large-2 column"><span style="color: green">done {{ total_tasks.done }} </span> </div>
        <div class="large-2 column"><span style="color: green">finished {{ total_tasks.finished }} </span> </div>
        <div class="large-2 column"><span style="color: greenyellow">running {{ total_tasks.running }} </span> </div>
        <div class="large-2 column"><span style="color: blue">other states {{ total_tasks.blue }} </span> </div>
        <div class="large-1 column"> </div>
    </div>
    </div>

{% endif %}

    <div class="row" >
        <a id="asyncLink" href="#" data-dropdown="dropAsyncTask">
            <div  style="display: none" class="alert-box info round asyncProgressRef" >Async task: "<span class="asyncTaskName"></span>" has status: "<span class="asyncStatus"></span>" completion:  <span class="asyncProgressStat" ></span></div></a>        </a>
    </div>

<table style="margin-left: 50px;border: hidden" id="patternTable">
<tr>
    <th colspan="11">
        <select class="selectPattern" >
            <option value="" disabled selected>Select pattern</option>
            {% for pattern, steps in pattern_list %}
                <option value="{{ pattern }}">{{ pattern }}</option>
            {% endfor %}
        </select>
    </th>
    <th >
        <td><button id="showPattern" title="Show current pattern" onclick="showPatternClick(event);">Show</button></td>
    </th>
    <th >
        <td><button class="btn_is_authenticated" id="bind" title="Create step execution" onclick="bindClick(event);">Bind</button></td>
    </th>

</tr>
<tr>
{% for step in step_list %}
        <th class="stepchoose" id="startStep{{ forloop.counter0 }}"  > <div > {{step.name}}</div></th>
{% endfor %}
</tr>
    <tr>
        {% for step in step_list %}
            <td style="padding: 0px;width: 50px">
            <form><input type="text" class="patternForm"  id="patternform{{forloop.counter0}}" value=""/></form>
            </td>
        {% endfor %}
          <td colspan="4">
              <label> Replace empty
                <input type="checkbox" class="replaceEmptyCeckboxes" id="replaceByPattern" onclick="$('.replaceEmptyCeckboxes').prop('checked',$(this).is(':checked'));" />
              </label>
          </td>
    </tr>
</table>

<div id="sliceInfo" class="small content f-dropdown" data-dropdown-content>
     <strong>Slice:</strong>
</div>

    <div >
    <div  id="baseInput"></div>
    {% for inputList, step_exec_dict, approved, show_task, show_action, foreignStepID, approveLevel, cloned, is_waiting, slice_output,slice_output_full,real_events, total_events  in inputLists %}
        <div class="inputListDivs" id="inputList_div{{ inputList.slice }}">
        <table class="outsideInputListTables" id="outsideInputListTables{{ inputList.slice }}"><tr>
            <td style="width: 29px;padding:0px;margin:0px"><form ><input  type="checkbox" class="checkboxSlice" id="checkbox{{ inputList.slice }}" onclick='checkSlice(event);' checked></form></td>
            <td style="padding:0px;margin:0px">
            <table class="inputListTables {{ inputList.is_error }}" >
            <tr class="inputListRow">
                <td style="width: 20px" ><a name="inputList{{ inputList.slice }}">{{ inputList.slice }}</a></td>
                {% if  not_use_input_date_for_pattern %}
                    <td colspan="12" style="width: 550px" >
                         <span class="showTasksInSlice">+ </span><span class="showFullSpan changedatasetName{{ inputList.slice }} DatasetSort filterField" id="inputDatasetName{{ inputList.slice }}" style="padding:0px" title="{{ inputList.dataset }}">
                            {{ inputList.dataset }}
                        </span>
                    </td>
                    <td colspan="2"><a href="#" onclick="showModalDatasetInfo(event,{{ inputList.slice }})">datasets</a></td>
                    {% if cloned != 'no' %}
                        <td><a href="#inputList{{ cloned }}" style="color: red"><u>Cloned</u></a></td>

                    {% else %}
                        <td></td>
                    {% endif %}
                {% else %}
                    <td colspan="12" style="width: 550px" >
                        <span class="showTasksInSlice">+ </span><a href='' class='changejobOption{{ inputList.slice }} makeJOUrl JOSort filterField' target="_blank" style="padding:0px" id="sliceInputJobOptions{{ inputList.slice }}" title="{{ inputList.input_data }}">
                            {{ inputList.input_data}}
                        </a>
                    </td>
                    <td  colspan="2"><a href="#" onclick="showModalDatasetInfo(event,{{ inputList.slice }})"><span class="changedatasetName{{ inputList.slice }} DatasetSort filterField" id="inputDatasetName{{ inputList.slice }}" title="{{ inputList.dataset }}">{{ inputList.dataset }}</span></a> </td>
                    <td></td>
                {% endif %}
{#                <td>{{ inputList.brief }}</td>#}

            </tr>
            <tr class="showSliceError" style="display: none">
                <td colspan="16"  >
                    <span  style="padding:0px;color: red" title="{{ inputList.errorMessage }}">{{ inputList.errorMessage}}</span>
                </td>
            </tr>
            {% if  not not_use_input_date_for_pattern %}
              <tr>

                        {% ifequal trequest.request_type "MC" %}
                            <td colspan="13" style="width: 500px" >
                            <span class="showFullSpan changecomment{{ inputList.slice }}" style="padding:0px" title="{{ inputList.comment }}">
                                {{ inputList.comment }}
                             </span>
                            </td>
                            <td colspan="2" >events: <span  class="changeeventsNumber{{ inputList.slice }}">{{ real_events }}</span></td>

                         {% else %}

                            <td colspan="15" style="width: 500px" >
                            <span class="showFullSpan" style="padding:0px" title="{{ slice_output_full }}">Slice outputs:<span class="sliceOutput filterField"><b>
                                {{ slice_output}}</b></span>
                            </span>
                            </td>
                        {% endifequal %}


                   {% if cloned != 'no' %}
                        <td><a href="#inputList{{ cloned }}" style="color: red"><u>Cloned</u></a></td>

                    {% else %}
                        <td></td>
                    {% endif %}
              </tr>
            {%else %}
                 <tr>
                <td colspan="13" style="width: 500px" >
                        <span class="showFullSpan" style="padding:0px" title="{{ slice_output_full }}">Slice outputs:<span class="sliceOutput filterField"><b>
                            {{ slice_output}}</b></span>
                        </span>
                        <span style="display: none" class="filterField">{{ slice_output_full }}</span>
                    </td>
                    <td colspan="2" ></td>
                        <td></td>

              </tr>
            {% endif %}
            <tr>
                <td colspan="13" style="width: 500px" >
                    <select id="inputDatasetSelect{{ inputList.slice }}" style="display: none">

                    </select>
                </td>
                <td colspan="2"><strong id="inputDatasetSelectCount{{ inputList.slice }}"></strong><strong style="color:orangered" id="inputDatasetSelectReduced{{ inputList.slice }}" title="Some datasets from container will not be processed due to sub campaign mutually exclusive"></strong></td><td></td>
            </tr>

            <tr class="inputListRow">
                <td style="width: 20px"> </td>
                {% for step in step_exec_dict %}
                        {% ifequal step.skipped 'foreign' %}
                            {% if step.is_another_request %}
                                <td class="notShowFullSpan filterTag" id="short{{ inputList.slice }}s{{ forloop.counter0 }}"
                                style="font-size:12px;width:50px;padding:0px;border:1px solid black"><a target="_blank" href="{% url 'prodtask:input_list_approve' step.slice.request%}#inputList{{ step.slice.slice }}">{{ step.tag }}</a><span class="foreignStepID" style="display: none">{{ foreignStepID }}</span></td>

                            {% else %}
                                <td class="notShowFullSpan filterTag" id="short{{ inputList.slice }}s{{ forloop.counter0 }}"
                                style="font-size:12px;width:50px;padding:0px;border:1px solid black"><a href="#inputList{{ step.slice.slice }}">{{ step.tag }}</a><span class="foreignStepID" style="display: none">{{ foreignStepID }}</span></td>
                            {% endif %}
                        {% else %}
                        <td class="showFullSpan filterTag" id="short{{ inputList.slice }}s{{ forloop.counter0 }}"
                            style="font-size:12px;width:50px;padding:0px;border:1px solid black">{{ step.tag }}</td>
                        {% endifequal %}
                {% endfor %}
                    <span id="taskStatusFilter{{ inputList.slice }}" class="TaskStatusFilter" style="display: none;">no_tasks</span>
                    <span id="redTaskFilter{{ inputList.slice }}" class="RedStatusFilter" style="display: none;">no_tasks</span>
                    <span id="exhTaskFilter{{ inputList.slice }}" class="ExhStatusFilter" style="display: none;">no_tasks</span>

                    <span id="actionStatusFilter{{ inputList.slice }}" class="ActionStatusFilter" style="display: none;">no_actions</span>
                    <td colspan="2" id="aprroveLabel{{ inputList.slice }}" style="width: 8em;text-align:center"><span class="{{ approved.submitted }} {{ approved.original }} StatusFilter" >{{ approved.submitted }}</span><span id="sliceOrigin{{ inputList.slice }}" class="sliceOrigin" style="display: none"> {{ approved.original }}</span></td>
                <span id="sliceSplit{{ inputList.slice }}" class="sliceSplit" style="display: none">{{ approved.split }}</span><td>
                       <u> <a href="#" id="saveStatus{{ inputList.slice }}" onclick="formSliceInfo(event, this.id);" data-options="is_hover:true" >
                            edit (saved)
                        </a></u></td>
            {% if show_action %}
                        <tr class="actionRow">
                        <td>A:</td>

                        {% for step in step_exec_dict %}
                            {% if step.merge_spans > 0 %}
                            <td style="padding:0px;margin:0px" colspan="{{ step.merge_spans }}">
                            {% if step.progress_bar %}
                                {% if  step.total == -1 %}
                                    <a href="{{ step.progress_bar_link }}"> <span style="color: #0c0c0c"><b>Queued</b></span></a>
                                {% else %}
                                    <a href="{{ step.progress_bar_link }}"> <div class="actionProgressBar" my_value="{{ step.done }}" style="border:1px solid black" my_total="{{ step.total }}">{{ step.done }}/{{ step.total }} </div></a>
                                {% endif %}

                            {% else %}
                                <table style="padding:0px;margin:0px">
                            {% for action in step.actions %}
                                {% if action %}

                                <tr style="padding:0px;margin:0px;height: 20px">
                                <td  style="padding: 0px;width: 50px;border:1px solid black" class="action {{ action.status }} " >
                                    <div>
                                       <a class="actionStatus" id="{{ action.id }}as{{ inputList.slice }}" href="/{{ action.path }}/{{ action.id }}">{{ action.status }}</a>
                                    </div>
                                </td>
                                {% else %}
                                    <td  style="padding: 0px;width: 50px;border:1px solid black" ></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                            </table>
                             {% endif %}
                            </td>
                            {% endif %}
                        {% endfor %}

                        <td colspan="3"></td>
                        </tr>
            {% endif%}
            {% if show_task %}
                        <tr>
                        <td>T:</td>

                        {% for step in step_exec_dict %}
                        {% if step.tasks|length == 1 %}
                        {% for task in step.tasks %}
                        {% if task %}
                        <span id="{{ task.id }}ts{{ inputList.slice }}" class="taskStatus" style="display: none;">{{ task.status }}</span>
                        <td  style="padding: 0px;width: 50px;border:1px solid black" class="{{ task.status }} {{ task.finished_rate }}" >
                            <div>
                               <a  href="{{ task.href }}"><span  class="{{ task.finished_rate }}">{{ task.short }}</span></a>
                            </div>
                        </td>
                        {% else %}
                            <td  style="padding: 0px;width: 50px;border:1px solid black" ></td>
                        {% endif %}
                        {% endfor %}

                        {% else %}
                        <td style="padding:0px;margin:0px">
                        <table style="padding:0px;margin:0px">
                        {% for task in step.tasks %}
                        {% if task %}

                        <tr style="padding:0px;margin:0px;height: 20px">
                        <span id="{{ task.id }}ts{{ inputList.slice }}" class="taskStatus" style="display: none;">{{ task.status }}</span>
                        <td  style="padding: 0px;width: 50px;border:1px solid black" class="{{ task.status }} {{ task.finished_rate }} " >
                            <div>
                               <a  href="{{ task.href }}"><span  class="{{ task.finished_rate }}">{{ task.short }}</span></a>
                            </div>
                        </td>
                        {% else %}
                            <td  style="padding: 0px;width: 50px;border:1px solid black" ></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        </table>
                        </td>
                        {% endif %}
                        {% endfor %}
                        <td colspan="3">Produced events: {{ total_events }}</td>
                        </tr>
            {% endif%}
            </tr>
            </table>

        </td>
        </tr></table>
        </div>
	{% endfor %}
    </div>
    <div class="row">
        <a id="asyncLink" href="#" data-dropdown="dropAsyncTask">
    <div  style="display: none" class="alert-box info round asyncProgressRef" >Async task: "<span class="asyncTaskName"></span>" has status: "<span class="asyncStatus"></span>" completion:  <span class="asyncProgressStat" ></span></div></a>
        <div id="dropAsyncTask" class="f-dropdown content" data-dropdown-content>
            <div class="row">
                Task ID: <span class="asyncTaskID"></span>
            </div>
            <div class="row">
                Task Name: <span class="asyncTaskName"></span>
            </div>
            <div class="row">
                User Name: <span class="asyncTaskUserName"></span>
            </div>
            <div class="row">
                Status: <span class="asyncStatus"></span>
            </div>
            <div class="row">
                progress: <span class="asyncProgressStat" ></span>
            </div>

        </div>
    </div>
    {#    <button style="display: none" onclick="testAsyncClick(event);">Test</button>#}
 <form>
    <div class="row collapse hiddenNonEdit">
    <button id="select_slice_checkobx" title="Select/unselect all" onclick="selectClick(event);">Select All</button>
    </div>
        <div class="row collapse hiddenNonEdit">
        <strong class="hiddenNonEdit">Work with selected slices:</strong><p/>
                {% if not user.is_authenticated %}
                    <a class="small radio button success"
                       href="{% url 'prodtask:login' %}?next={{ request.get_full_path|urlencode }}"
                    >Login</a>
                {% endif %}

            <button class="btn_is_authenticated" id="saveButton" title="Save selected slices without approval" onclick="approveClick(event,false,'-1',false,false);">Save</button>
            {% ifequal trequest.request_type "MC" %}
{#                true#}
                <button class="btn_is_authenticated" id="approveButton" title="Approve selected slices" onclick="approveClick(event,true,'99',true,false);">Submit</button>
            {% else  %}
                <button class="btn_is_authenticated" id="approveButton" title="Approve selected slices" onclick="approveClick(event,true,'99',false,false);">Approve</button>

            {% endifequal %}
            <button class="btn_is_authenticated" title="Clone slices" onclick="cloneSlicesClick(event,'0',-1);">Clone </button>
            <button class="btn_is_authenticated"  title="Fix slices" href="#" data-dropdown="dropCloneMenu">Fix </button>
            <button class="btn_is_authenticated" id="rejectSlice" title="Reject slices, if tasks are not started yet" onclick="rejectSlicesClick(event);">Reject </button>
            <button class="btn_is_authenticated" id="hideButton" title="Hide slices from request page" onclick="hideClick(event);">Hide</button>
            <button class="btn_is_authenticated" id="checkInputButton" title="Find input data for skipped steps" onclick="findInputClick(event);">Find input</button>


        <div id="dropCloneMenu" class="f-dropdown content" data-dropdown-content>
                <div class="row">
                    <label> Clone from step:
                    <select id="cloneFromStep" >
                    <option value="-1">all</option>
                    {% for step in step_list %}
                            <option value="{{forloop.counter0}}">{{ step.name }}</option>
                    {% endfor %}
                    </select>
                    </label>
                </div>
             <div class="row">
                 <button id="cloneSlice" class="btn_is_authenticated" title="Clone slices" onclick="cloneSlicesClick(event,'1',$('#cloneFromStep').val());">Fix</button>
             </div>
        </div>

    </div>
    <div class="row">
                <div class="large-3 columns">
                    {% ifequal trequest.request_type "MC" %}
                        <button href="#" class="button prefix btn_is_authenticated"  onclick="approveClick(event,true,$('#approveToInput').val(),false,false);">Submit only steps before:</button>
                    {% else  %}
                         <button href="#" class="button prefix btn_is_authenticated"  onclick="approveClick(event,true,$('#approveToInput').val(),false,false);">Approve only steps before:</button>
                    {% endifequal %}
                </div>

                <div class="large-1 columns">
                    <select id="approveToInput" >
                    {% for step in step_list %}
                        {% if forloop.counter0 > 0 %}
                            <option value="{{forloop.counter0}}">{{ step.name }}</option>
                        {% endif %}
                    {% endfor %}
                    </select>
                </div>

     <div class="large-1 columns">
         <button id="retrySlice" class="btn_is_authenticated" title="Very smart algorithm to retry slices" onclick="retrySlicesClick(event);">Retry</button>
    </div>
         <div class="large-1 columns">

             <button id="trainsSlices" class="btn_is_authorized" title="Create child trains" onclick="showTrainExtendModal(event);">Trains</button>

        </div>
             <div class="large-2 columns">

                 <button id="findParent" class="btn_is_authorized" title="Find steps from parent request" href="#" data-dropdown="dropFindParentMenu">Find parents</button>
                <div id="dropFindParentMenu" class="f-dropdown content" data-dropdown-content style="display: none">
                        <div class="row">
                            <label> Parent request:
                                <input type="number" id="parentRequestNumber" value="{{ parent_request_id }}" />
                            </label>
                        </div>
                     <div class="row">
                         <button id="findParentAction" class="btn_is_authenticated" title="Find parent slices" onclick="findParentClick(event,$('#parentRequestNumber').val(), false);">Find</button>
                     </div>
                    <div class="row">
                        <button id="findParentAsyncAction" class="btn_is_authenticated" title="Find parent slices async" onclick="findParentClick(event,$('#parentRequestNumber').val(),true);">Async</button>
                    </div>
                </div>

            </div>
    <div class="large-2 columns">
        {% if show_split %}
            <button class="btn_is_authenticated"  title="Split slices" href="#" data-dropdown="dropSplitMenu">Split </button>
            <div id="dropSplitMenu" class="f-dropdown content" data-dropdown-content style="display: none">
                    <div class="row">
                        <label> Split on:
                            <input type="number" id="splitNumber" value="10000000" />
                        </label>
                    </div>
                 <div class="row">
                     <button id="splitSlice" class="btn_is_authenticated" title="Split slices" onclick="splitSlicesClick(event,$('#splitNumber').val());">Split</button>
                 </div>
                 <div class="row">
                     <button id="splitSliceByTID" class="btn_is_authenticated" title="Split slices by tid" onclick="splitSlicesByTIDClick(event);">Split by tid</button>
                 </div>

            </div>
        {% endif %}
                   {% ifequal trequest.request_type "GROUP" %}
                    <div class="row">
                     <button id="splitSliceByOutput" class="btn_is_authenticated" title="Split merge by outputs" onclick="splitSlicesByOutputClick(event);">Split merge step</button>
                 </div>
                    {% endifequal %}
    </div>
     <div class="large-2 columns">
         {% ifequal trequest.request_type "GROUP" %}
            <button id="obsoleteOldTasksSlices" class="btn_is_authorized" title="Obsolete old tasks with empty input" onclick="obsoleteOldTasks(event, true);">Prepare to recreate</button>
         {% else %}
             <button id="obsoleteOldTasksSlices" class="btn_is_authorized" title="Obsolete old tasks with empty input" onclick="obsoleteOldTasks(event, false);">Prepare to recreate</button>

         {% endifequal %}
     </div></div>

    <div class="row">
        <div class="large-3 columns">
            <button class="button btn_is_authenticated" onclick="showBulkStepModal(event);">Bulk steps modification</button>

        </div>
        <div class="large-3 columns">
            <button class="button btn_is_authenticated" onclick="showBulkSliceModal(event);">Bulk slice modification</button>

        </div>
        <div class="large-2 columns">
            <a class="button btn_is_authenticated" onclick="showTasks(event);">Manage tasks</a>
        </div>
        <div class="large-2 columns">
            <button id="changeParent" class="btn_is_authorized" title="Change parent slice" href="#" data-dropdown="dropChangeParentMenu">Change parent</button>
                <div id="dropChangeParentMenu" class="f-dropdown content" data-dropdown-content style="display: none">
                        <div class="row">
                            <label> Parent slice:
                                <input type="number" id="parentSliceNumber" value="" />
                            </label>
                        </div>
                     <div class="row">
                         <button id="changeParentAction" class="btn_is_authenticated" title="Change parent slice" onclick="changeParentClick(event,$('#parentSliceNumber').val());">Change</button>
                     </div>

                </div>
        </div>
        <div class="large-1 columns"><button class="btn_is_authenticated" id="saveButton" title="Save selected slices without approval" onclick="approveClick(event,false,'-1',false,true);">Save Async</button></div>

    </div>
 </form>

<div id="patternModal" class="reveal-modal" data-reveal>
  <ul id="patternModalBody">
  </ul>
  <a id='closeReveal' class="close-reveal-modal" >&#215;</a>
</div>

<div id="cloneModal" class="reveal-modal" data-reveal>
    <p>Request: {{  trequest.reqid }}<br/>
    <p>Old description: {{  trequest.description }}<br/>
    <label> New description:
        <input type="text" id="newDescription" placeholder=" "   />
    </label>
    <p>Old link: {{  trequest.ref_link }}<br/>
    <label> New link:
        <input type="text" id="newLink" placeholder=" "   />
    </label>
        <label> New project:
                  <select id="chooseNewCloneProject" >
                           {% for project in project_list %}
                                <option value="{{ project }}" >{{ project }}</option>
                           {% endfor %}
                    </select>
    </label>
      <label for="radioClone"><input name="radioClone" type="radio" id="radioCloneAll"  CHECKED><span class="custom radio checked"></span><span id='allClone'>All</span></label>
      <label for="radioClone"><input name="radioClone" type="radio" id="radioCloneSelect" ><span class="custom radio"></span > <span id='selectClone'>Selected</span></label>
    <button id="cloneRequestButton" title="clone request" onclick="cloneRequest(event);$('#closeCloneReveal').click()">Clone request</button>
    <label>Do asynchronous
        <input type="checkbox"  id="asyncRequestClone" />
    </label>
<a id='closeCloneReveal' class="close-reveal-modal" >&#215;</a>
</div>

<div id="statusHistoryModal" class="reveal-modal" data-reveal>
    <div class="row">
        <div class="column large-3">
            <label> Status:
                    <select id="chooseNewStatus" >
                        <option value="registered" >registered</option>
                        <option value="hold" >hold</option>
                        <option value="waiting" >waiting</option>
                        <option value="working" >working</option>
                        <option value="approved" >approved</option>
                        <option value="finished" >finished</option>
                        <option value="monitoring" >monitoring</option>
                        <option value="reworking" >reworking</option>
                        <option value="remonitoring" >remonitoring</option>
                        <option value="cancelled" >cancelled</option>
                        <option value="test" >test</option>
                    </select>
            </label>
         </div>
            <div class="column large-1">
                 <a class="button btn_is_authenticated" onclick="saveRequestStatus(event);">Save</a>
            </div>
            <div class="column large-1">&nbsp</div>
            <div class="large-2 column"><span id="loadStatusHistory"></span></div>
            <div class="column large-2"><span id="requestStatusUpatde"></span></div>
            <div class="column large-3"></div>
    </div>
    <div>
        <table>
            <thead>
                <tr>
                    <th>Status</th>
                    <th>User</th>
                    <th>Date</th>
                    <th>Comment</th>
                </tr>
            </thead>
            <tbody id="statusTableBody">

            </tbody>
        </table>
    </div>
    <a  class="close-reveal-modal">&#215;</a>
</div>

<div id="sliceModal" class="reveal-modal" data-reveal>

    <a style="cursor: pointer;" onclick="openPrevSlice(event, $('#sliceModalSlice').html(), true);" >Prev</a>
    Slice: <span id="sliceModalSlice"></span>
    <a style="cursor: pointer;" onclick="openPrevSlice(event,$('#sliceModalSlice').html(), false);">Next</a><br/>
    <div>
    <div class="row">
        <div class="column large-12">
            <label> Dataset: <input id='datasetNameModal' type="text" class="datasetName storeOutputSlice  storeInput" placeholder=" "  /></label>
        </div>
    </div>
    <div class="row">
        <div class="column large-9">
            <label> job options: <input id="jobOptionModal" type="text" class="jobOption storeOutputSlice storeInput" placeholder=" "  /></label>
        </div>
        <div class="column large-3">
            <label> Input events: <input id='eventsNumberModal' type="number" class="eventsNumber storeOutputSlice storeInput"  placeholder="-1"  /></label>
        </div>
    </div>
    <div class="row">
        <div class="column large-12">
            <label> Comment: <input id="commentModal" type="text" class="comment storeOutputSlice storeInput" placeholder=" "  /></label>
        </div>
    </div>
        <div class="row" style="display: none">
        <div class="column large-12">
            <label> Slice priority: <input id="priorityModal" type="number" class="priority storeOutputSlice storeInput" placeholder=" "  /></label>
        </div>
    </div>
    </div>
<div>


<div class="section-container auto" id="sliceInfoContainer" data-section>
        {% for step in step_list %}
               {% if  forloop.counter0 == 0%}

                <section class="active">
                   {% else %}
                   <section>
                {% endif %}
                 <p class="title" data-section-title><a href="#" id="sectionName{{forloop.counter0}}">{{step.name}}</a></p>
                    <div class="content" data-section-content>
                        <fieldset>
                        <div class="row">
                                <div class="large-2 columns">
                                  <label> AMI tag
                                    <input type="text" class="step storeOutput{{forloop.counter0}} storeInput" placeholder=" " onchange="spreadAMI(this);"  />
                                  </label>
                                </div>
                                <div class="large-2 columns">
                                  <label>Step is skipped
                                    <input type="checkbox" class="skipped storeOutput{{forloop.counter0}} storeInput"  onchange="spreadSkipped(this);" />
                                  </label>

                                </div>
                                 <div class="large-3 columns">
                                  <label>Events per Input file
                                    <input type="number" class="nEventsPerInputFile storeOutput{{forloop.counter0}} storeInput"  placeholder=""  />
                                  </label>

                                </div>
                                 <div class="large-3 columns">
                                  <label>Events per job
                                    <input type="number" class="nEventsPerJob storeOutput{{forloop.counter0}} storeInput"  placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>Total events
                                    <input type="number" class="input_events storeOutput{{forloop.counter0}} storeInput" placeholder="-1"  />
                                  </label>
                                </div>
                               </div>
                               <div class="row">
                                <div class="large-2 columns">
                                  <label>Files per job
                                    <input type="number" class="nFilesPerJob storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>nGB per job
                                    <input type="number" class="nGBPerJob storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                   <div class="large-2 columns">
                                    <label>evntFilterEff
                                    <input type="number" class="evntFilterEff storeOutput{{forloop.counter0}} storeInput" step="0.001" min="0" placeholder=""  />
                                  </label>
                                       </div>
                                    <div class="large-1 columns">
{#                                    <input id="TTCDays{{forloop.counter0}}" min="0" type="number" class="TTCDays storeOutput{{forloop.counter0}} storeInput" placeholder="D"  />#}
                                      </div>


                                <div class="large-2 columns">
                                  <label>max failure attempt
                                    <input type="number" class="maxFailure storeOutput{{forloop.counter0}} storeInput" placeholder=""  />
                                  </label>
                                </div>
                                </div>
                                <div class="row">
                                <div class="large-5 columns">
                                  <label>Output formats
                                    <input type="text" class="output_formats storeOutput{{forloop.counter0}} storeInput" placeholder=" "  />
                                  </label>
                                </div>

                                 <div class="large-5 columns">
                                  <label>Input format
                                    <input type="text" class="input_format storeOutput{{forloop.counter0}} storeInput" placeholder=" "  />
                                  </label>
                                </div>
                                 </div>
                                <div class="row">
                                <div class="large-9 columns">
                                  <label>project mode
                                    <input type="text" class="project_mode storeOutput{{forloop.counter0}} storeInput" placeholder=" " />
                                  </label>
                                </div>
                                <div class="large-3 columns">
                                  <label>Priority
                                    <input type="number" class="priority storeOutput{{forloop.counter0}} storeInput" onchange="changePriority(this);" placeholder=" " />
                                  </label>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-12 columns">
                                  <label>Destination
                                    <input type="text" class="token storeOutput{{forloop.counter0}} storeInput" placeholder=" " />
                                  </label>
                                </div>
                              </div>
                                <div class="row">
                                <div class="large-12 columns">
                                  <strong>JEDI internal merging:
                                  </strong>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-2 columns">
                                  <label>merging tag
                                    <input type="text" class="merging_tag storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>nFilesPerMergeJob
                                    <input type="number" class="nFilesPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                  <div class="large-2 columns">
                                  <label>nGBPerMergeJob
                                    <input type="number" class="nGBPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                                  <div class="large-3 columns">
                                  <label>nEventsPerMergeJob
                                    <input type="number" class="nEventsPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                      </div>
                                 <div class="large-3 columns">
                                  <label>nMaxFilesPerMergeJob
                                    <input type="number" class="nMaxFilesPerMergeJob storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                  </div>
                              </div>
                            <div class="row">
                                <div class="large-4 columns">
                                  <label>Pre definition action
                                    <select  class="PDA storeOutput{{forloop.counter0}} storeInput"   >
                                        <option value="">None</option>
                                        <option value="postpone">Postpone</option>
                                        <option value="check2rep">Wait 2 replicas</option>
                                        <option value="empty">Do Pre Stage</option>
                                        <option value="preStageWithTaskArchive">Check Archive</option>
                                        <option value="preStage">Special</option>
                                    </select>
                                  </label>
                                </div>
                                <div class="large-8 columns">
                                  <label>Parameters
                                    <input type="text" class="PDAParams storeOutput{{forloop.counter0}} storeInput"  placeholder=" " />
                                  </label>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-12 columns">
                                  <label>Previous tasks
                                    <input type="text" class="previousTasks storeOutput{{forloop.counter0}}"  placeholder=" " readonly/>
                                  </label>
                                </div>
                              </div>

                            <div class="containerSelectForm storeOutput{{forloop.counter0}} row" style="display: none">
                                <div class="large-12 columns" >
                                  <label>Possible containers
                                    <select  class="containerSelect storeOutput{{forloop.counter0}} " onchange="selectContainer(event,this,'storeOutput{{forloop.counter0}}');"  > </select>
                                  </label>
                              </div>
                             </div>

                            <div class="row">
                                <div class="large-1 columns">
                                       <button id="findButton" class="btn_is_authenticated" title="Find containers for this ami tag" onclick="findContainers(event,'storeOutput{{forloop.counter0}}');">Find</button>
                                </div>
                                <div class="large-8 columns">
                                  <label>Container name
                                    <input type="text" class="container_name storeOutput{{forloop.counter0}} storeInput"  placeholder=" " />
                                  </label>
                                </div>
                                <div class="large-3 columns">
                                  <label>Use only tags for FC
                                    <input type="checkbox" class="onlyTagsForFC storeOutput{{forloop.counter0}} storeInput"  />
                                  </label>
                                </div>
                              </div>
                            </fieldset>
                    </div>
            </section>
        {% endfor %}

</div>
</div>
   <button id="saveButtonSlice" class="btn_is_authenticated" title="Save selected slice without approval" onclick="saveOneSlice(event);$('#closeReveal').click()">Save</button>
  <a id='closeReveal' class="close-reveal-modal" onclick="changeSliceSaveStatus($('#sliceModalSlice').html());">&#215;</a>
</div>

    <div id="slicesBulkChangeModal" class="reveal-modal" data-reveal>

    Slices: <span id="slicesBulkModalSize"></span>

        <div class="row">
            <div class="column large-12">
                <label> Dataset: <input id='datasetNameModal' type="text" class="datasetName storeSliceBulk " placeholder=" "  /></label>
            </div>
        </div>
        <div class="row">
            <div class="column large-9">
                <label> job options: <input id="jobOptionModal" type="text" class="jobOption storeSliceBulk" placeholder=" "  /></label>
            </div>
            <div class="column large-3">
                <label> Input events: <input id='eventsNumberModal' type="number" class="eventsNumber storeSliceBulk"   /></label>
            </div>
        </div>
        <div class="row">
            <div class="column large-12">
                <label> Comment: <input id="commentModal" type="text" class="comment storeSliceBulk" placeholder=" "  /></label>
            </div>
        </div>
        <div class="row">
                    <div class="column large-3">
                <label> Priority: <input id='priorityModal' type="number" class="priority storeSliceBulk"  onchange="changePriority(this);" /></label>
            </div>
             </div>
    <button id="saveSliceBulkButton" class="btn_is_authenticated" title="Save selected slices" onclick="saveSlicedBulk(event);">Save</button>

     <a class="close-reveal-modal">&#215;</a>
    </div>

<div id="stepsBulkChangeModal" class="reveal-modal" data-reveal>
<p><span style="color: green">Steps approved: <span id="stepsApprovedBulk"></span></span>
    <span>Steps to change (not approved): <span id="stepsToChangeBulk"></span></span><br/>
    <div>
    <div class="row">
        <div class="column large-3">
            <label> AMI Tag: <select id='amitagBulkSelect' class="bulkSelect" ></select></label>
        </div>
        <div class="column large-3">
                    <label> Step:
                    <select id="chooseStepBulk" class="bulkSelect" >
                    <option value="" >all</option>
                    {% for step in step_list %}
                            <option value="{{ step.name }}">{{ step.name }}</option>
                    {% endfor %}
                    </select>
                    </label>
        </div>
        <div class="column large-6">
            <label> Slices:
                    <select id="radioSetStepBulk" class="bulkSelect" >
                    <option id='allSlicesBulk' value="all" selected >all</option>
                    <option id='selectedSliceBulk' value="selected" >selected</option>
                </select>
            </label>
        </div>
    </div>
    <div class="row">
        <div class="column large-12">

        </div>

    </div>

    </div>


                        <fieldset>
                        <div class="row">
                                <div class="large-3 columns">
                                  <label> AMI tag
                                    <input type="text" class="ctag storeBulk" placeholder="" readonly />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>Events per Input file
                                    <input type="number" class="nEventsPerInputFile storeBulk"  placeholder=""  />
                                  </label>

                                </div>
                                 <div class="large-2 columns">
                                  <label>Events per job
                                    <input type="number" class="nEventsPerJob storeBulk"  placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>Total events
                                    <input type="number" class="input_events storeBulk" placeholder=""  />
                                  </label>
                                </div>
                               </div>
                               <div class="row">
                                <div class="large-2 columns">
                                  <label>Files per job
                                    <input type="number" class="nFilesPerJob storeBulk" placeholder=""  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>nGB per job
                                    <input type="number" class="nGBPerJob storeBulk" placeholder=""  />
                                  </label>
                                </div>
                                <div class="large-2 columns">
                                  <label>max failure attempt
                                    <input type="number" class="maxFailure storeBulk" placeholder=""  />
                                  </label>
                                </div>
                                </div>
                                <div class="row">
                                <div class="large-5 columns">
                                  <label>Output formats
                                    <input type="text" class="output_formats storeBulk" placeholder=" "  />
                                  </label>
                                </div>

                                 <div class="large-5 columns">
                                  <label>Input format
                                    <input type="text" class="input_format storeBulk" placeholder=" "  />
                                  </label>
                                </div>
                                 </div>
                                <div class="row">
                                <div class="large-9 columns">
                                  <label>project mode
                                    <input type="text" class="project_mode storeBulk" placeholder="" />
                                  </label>
                                </div>
                                <div class="large-3 columns">
                                  <label>Priority
                                    <input type="number" class="priority storeBulk" placeholder="" onchange="changePriority(this);"/>
                                  </label>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-12 columns">
                                  <label>Destination
                                    <input type="text" class="token storeBulk" placeholder="" />
                                  </label>
                                </div>
                              </div>
                                <div class="row">
                                <div class="large-12 columns">
                                  <strong>JEDI internal merging:
                                  </strong>
                                </div>
                              </div>
                              <div class="row">
                                <div class="large-2 columns">
                                  <label>merging tag
                                    <input type="text" class="merging_tag storeBulk"  />
                                  </label>
                                </div>
                                 <div class="large-2 columns">
                                  <label>nFilesPerMergeJob
                                    <input type="number" class="nFilesPerMergeJob storeBulk"  />
                                  </label>
                                </div>
                                  <div class="large-2 columns">
                                  <label>nGBPerMergeJob
                                    <input type="number" class="nGBPerMergeJob storeBulk"  />
                                  </label>
                                </div>
                                  <div class="large-3 columns">
                                  <label>nEventsPerMergeJob
                                    <input type="number" class="nEventsPerMergeJob storeBulk"  />
                                  </label>
                                </div>
                                 <div class="large-3 columns">
                                  <label>nMaxFilesPerMergeJob
                                    <input type="number" class="nMaxFilesPerMergeJob storeBulk"  />
                                  </label>
                                  </div>
                              </div>
                                                            <div class="row">
                                <div class="large-4 columns">
                                  <label>Pre definition action
                                    <select  class="PDA storeBulk"   >
                                        <option value="" disabled="disabled">(multiple values)</option>
                                        <option value="none">None</option>
                                        <option value="postpone">Postpone</option>
                                        <option value="check2rep">Wait 2 replicas</option>
                                        <option value="empty">Do Pre Stage</option>
                                        <option value="preStageWithTaskArchive">Check Archive</option>
                                        <option value="preStage">Special</option>

                                    </select>
                                  </label>
                                </div>
                                <div class="large-8 columns">
                                  <label>Parameters
                                    <input type="text" class="PDAParams storeBulk"  placeholder=" " />
                                  </label>
                                </div>
                              </div>
                            <div class="row">
                                <div class="large-9 columns">
                                  <label>Container name
                                    <input type="text" class="container_name storeBulk"  placeholder=" " />
                                  </label>
                                </div>
                                <div class="large-3 columns">
                                  <label>Use only tags for FC
                                    <input type="checkbox" class="onlyTagsForFC storeBulk"  />
                                  </label>
                                </div>
                              </div>
                            </fieldset>


<button id="saveBulkButton" class="btn_is_authenticated" title="Save selected steps without approval" onclick="saveStepsBulk(event);">Save</button>
<button id="discardChange" class="btn_is_authenticated" title="Discard changes" onclick="discardChangesBulk(event);">Discard changes</button>
  <a class="close-reveal-modal">&#215;</a>
</div>



<div id="commentModalWindow" class="reveal-modal" data-reveal>
    <h3>Comments:</h3>
    <div class="row">
            <div class="large-4 column">
                <label>{{ request.user.username }}:
                <textarea  id="newComment"  maxlength="250"  ></textarea></label>
            </div>
            <div class="large-1 column">
                <a href='#' class="button btn_is_authorized postfix" onclick="addComment(event);">Add</a>
            </div>
            <div class="large-7 column"></div>
        </div>

    <ul id="commentList">

    </ul>
  <a  class="close-reveal-modal">&#215;</a>
</div>

    <div id="inputErrorsModalWindow" class="reveal-modal" data-reveal>
        <code id="inputErrorsList">

        </code>
        <a  class="close-reveal-modal">&#215;</a>
    </div>

    <div id="datasetInfoWindow" class="reveal-modal" data-reveal>
    <h5 id="datasetsInfoLoad">Loading...</h5>
    <table >
        <thead>
            <tr>
               <th >
                Dataset Name
            </th>
         <th>
             Events Number
         </th>
         <th >
             SubCampaing
         </th>
        <th >
             Tasks
         </th>
{#        <th >#}
{#             Other T.#}
{#         </th>#}
    </tr>
        </thead>
    <tbody id="datasetsInfoList">

    </tbody>

    </table>

  <a  class="close-reveal-modal">&#215;</a>
</div>


<div id="changeOwnerWindow" class="reveal-modal" data-reveal>
   <h3>Change request owner:</h3>
    <div class="row">
            <div class="large-1 column">
                <a href='#' class="button btn_is_authorized postfix" onclick="makeUserOwner(event);">Me</a>
            </div>
         <div class="large-11 column">
         </div>
    </div>
    <div class="row">
             <div class="large-4 column">
                <label>or :
                <input type="text"  id="newOwnerName"  maxlength="80" placeholder="username" /></label>
             </div>
            <div class="large-2 column">
                <a href='#' class="button btn_is_authorized postfix" onclick="changeOwnerUser(event,$('#newOwnerName').val());">Change</a>
            </div>
            <div class="large-6 column"></div>
        </div>


  <a  class="close-reveal-modal">&#215;</a>
</div>




<div id="hashtagModalWindow" class="reveal-modal" data-reveal>
    <ul id="hashtagList">

    </ul>
    <a class="hashtags" href="">{{ hashtags_string }}</a>
    <h3>New hashtag:</h3>
    <div class="row">
            <div class="large-4 column">
                <label>New HashTag:
                <input type="text"  id="newHashTag"  maxlength="80"  /></label>
            </div>
            <div class="large-1 column">
                <a href='#' class="button btn_is_authorized postfix" onclick="addHashTag(event);">Add</a>
            </div>
            <div class="large-7 column"></div>
        </div>



  <a id='closeHashtagModal' class="close-reveal-modal">&#215;</a>
</div>

<div id="extendModalWindow" class="reveal-modal" data-reveal>
    <h3>Extend request using google spreadsheet</h3>
    <div class="row">

            <div class="large-12 column">
                <label> link to spreadsheet:
                <input  id="extendSpreadsheet" type="url" onchange="changeExtendtoCheck();" ></label>
            </div>
        </div>
        <div class="row">
             <div class="large-2 column"><input type="checkbox" id="new_extend_workflow"/>New</div>
            <div class="large-1 column"><span id="sliceExtend"></span></div>
            <div class="large-1 column"><span id="stepsExtend"></span></div>
            <div class="large-2 column">
                <a href='#' id="checkExtend" class="button btn_is_authorized postfix" onclick="checkExtendRequest(event,this);">Check</a>
            </div>
            <div class="large-1 column"><span id="loadExtend"></span></div>
            <div class="large-5 column"></div>
        </div>

  <a  class="close-reveal-modal">&#215;</a>
</div>

    <div id="trainModalWindow" class="reveal-modal" data-reveal>
    <h3>Create trains:</h3>
    <div class="row">

            <div class="large-12 column">
                <span> Slices:</span><span id='trainSlices'></span>

            </div>
        </div>

     <div class="row">
     {% ifnotequal trequest.request_type 'MC' %}
         <div class="large-4 column">
             <label> Parent step:
                        <select id="trainParentStep" onchange="changeParentTrainStep();" >
                        {% for step in step_list %}
                                <option value="{{forloop.counter0}}">{{ step.name }}</option>
                        {% endfor %}
                        </select>
                        </label>
          </div>
     {% else %}
         <div class="large-4 column">
             <label> Parent step:
                        <select id="trainParentStep" onchange="changeParentTrainStep();" >

                                <option value="0">EVNT</option>
                                <option value="6">Reco Merge</option>
                                <option value="8">Atlf Merge</option>
                        </select>
                        </label>
          </div>
     {% endifnotequal %}
          <div class="large-8 column">
         <label> Pattern:
                    <select id="trainPatternRequest" onchange="changeParentTrainStep();" >
                    </select>
                    </label>
      </div>
     </div>

        <div class="row">
            <div class="large-2 column">
                <a href='{% url 'prodtask:train_as_child' pr_id %}' id="makeTrainsButton" style="display: none" class="button btn_is_authorized postfix" >Make trains</a>
            </div>
            <div class="large-1 column"><span id="loadTrain"></span></div>
            <div class="large-5 column"><span id="errorTrainMessage"></span></div>
        </div>

  <a  class="close-reveal-modal">&#215;</a>
</div>
<table style="margin-left: 50px;border: hidden" id="patternTable">
    <tr>
        <th colspan="11">
            <select class="selectPattern" >
                <option value="" disabled selected>Select pattern</option>
                {% for pattern, steps in pattern_list %}
                    <option value="{{ pattern }}">{{ pattern }}</option>
                {% endfor %}
            </select>
        </th>
        <th >
        <td><button id="showPattern" title="Show current pattern" onclick="showPatternClick(event);">Show</button></td>
        </th>
        <th >
        <td><button class="btn_is_authenticated" id="bind" title="Create step execution" onclick="bindClick(event);">Bind</button></td>
        </th>

    </tr>
    <tr>
        {% for step in step_list %}
            <th class="stepchoose" id="bstartStep{{ forloop.counter0 }}"  > <div > {{step.name}}</div></th>
        {% endfor %}
    </tr>
    <tr>
        {% for step in step_list %}
            <td style="padding: 0px;width: 50px">
                <form><input type="text" class="patternForm"  id="bpatternform{{forloop.counter0}}" value=""/></form>
            </td>
        {% endfor %}
        <td colspan="4">
            <label> Replace empty
                <input type="checkbox" class="replaceEmptyCeckboxes" id="breplaceByPattern" onclick="$('.replaceEmptyCeckboxes').prop('checked',$(this).is(':checked'));"  />
            </label>
        </td>
    </tr>
</table>
{% if hidden_slices > 0 %}
    <a href= "{% url 'prodtask:input_list_approve_full' pr_id %}">Show {{ hidden_slices }} hidden slices </a>
    <p/>

{% endif %}
{% if show_is_fast %}
    <a href="#" class="tiny secondary" onclick="chnageRequestToFast(event);">Start tasks without delay</a>
    {% if trequest.is_fast %}
        <span id="isFast"> :Yes</span>
    {% else %}
        <span id="isFast"> :No</span>
    {% endif %}
{% endif %}
    <p/>
    <a href="#" class="tiny secondary" onclick="chnageStatusToTest(event);">Make as test</a>
{% endblock %}