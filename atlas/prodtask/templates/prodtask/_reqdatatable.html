{% extends parent_template %}
{% load i18n %}
{% load url from future %}
{% load static from staticfiles %}

{% block bl_title %}Core App of Monitoring{% endblock %}

{% block bl_subtitle %}
{% if title %}{{ title }}{% else %}Datatable{% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
	<style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
        @import "{% static "css/jquery.dataTables_themeroller.css" %}";
	</style>
{% endblock %}

{% block base_js %}
{{ block.super }}
<script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
    <script type="text/javascript" src="{% static "js/jquery.dataTables.min.js" %}"></script>
{% endblock %}


{% block body %}
<!-- TODO: Replace next tables by independet from field objects   -->
<script>
$(document).ready(function(){
{#  $("#select_pattern").change(function(){#}
{#    {% for pattern in pattern_list %}#}
{#    {% for step in step_list %}#}
{#      var name1 = "#{{ step.idname }}" + "{{pattern}}"#}
{#      $(name1).css({"display":"none"});#}
{#    {% endfor %}#}
{#    {% endfor %}#}
{#  {% for step in step_list %}#}
{#    var name2 = "#{{ step.idname }}" + $("#select_pattern").val()#}
{#    $(name2).fadeIn("slow");#}
{#   {% endfor %}#}
{#  });#}






$(".stepchoose").css({"font-size": "12px","width": "50px","padding":"0px","border": "1px solid black",
                         "cursor":"pointer","user-select": "none"});
$(".inputListRow").children("td").css({"padding":"1px"})
$(".input_list_tables").css({"border": "1px solid black","margin": "1px"})
$(".outside_input_list_tables").css({"border": "hidden","margin": "1px"})
$(".show_full_span").css({"cursor":"pointer","user-select":"none"});
$(".show_small_span").css({"cursor":"pointer"});

var step_bc=["#FFB734","#FFFFFF"]
 {% for step in step_list %}
    $("#start_step{{ forloop.counter0 }}").css({"background-color":step_bc[0]});
    step_bc[0] = $("#start_step{{ forloop.counter0 }}").css("background-color")

 {% endfor %}
$("#select_pattern").change(function(){
    {% for pattern, steps  in pattern_list %}
        if ($("#select_pattern").val() == "{{ pattern }}"){
            {% for step in steps %}
                $("#patternform{{forloop.counter0}}").val("{{ step }}");
                if("{{ step }}" != ""){
                    $("#start_step{{ forloop.counter0 }}").css({"background-color":step_bc[0]});
                }
            {% endfor %}
        };
    {% endfor %}
});
    $(".stepchoose").click(function(){
        var current_color = $(this).css("background-color");
        var current_index = (step_bc.indexOf(current_color)+1)%step_bc.length;
        $(this).css({"background-color":step_bc[current_index]});
        step_bc[current_index] =  $(this).css("background-color");
        if($(this).attr("id").substr(0,4) == 'step'){
            var step_td_short = "td#short".concat($(this).attr("id").substr(4)).concat(".show_full_span");
            $(step_td_short).css({"background-color":step_bc[current_index]});
        };
    })  ;

    $(".show_full_span").click(function(){
       $(this).parent().parent().parent().hide(0);
       $(this).parentsUntil(".input_list_divs").children(".input_list_tables_long").show(0);

        return false;

    });
    $(".show_small_span").click(function(){


       $(this).parent().parent().parent().siblings(".input_list_tables").show(0);
       $(this).parent().parent().parent().siblings(".input_list_tables").children().show(0);
        $(this).parent().parent().parent().hide(0);
         return false;

    });


});

    function approve_click(event){
        event.preventDefault();
        window.location.replace("{% url 'prodtask:request_steps_approve' pr_id %}");
    };
    function bind_click(event){
        event.preventDefault();
        {% for step in step_list %}
            $(".checkbox_slice").each(function(){
                if ($(this).is(':checked')){
{#                   8 = "checkbox".length#}
                   var slice_id = $(this).attr("id").slice(8);
                   var step_value = $("#patternform{{ forloop.counter0 }}").val();
                   var step_td_short = "td#short".concat(slice_id).concat("{{ forloop.counter0 }}.show_full_span");
                   $(step_td_short).html(step_value);
                   var step_color = $("#start_step{{ forloop.counter0 }}").css("background-color");
                   $(step_td_short).css({"background-color":step_color});
                   var step_form_long = "#".concat(slice_id).concat("{{ forloop.counter0 }}.slice_form");
                   $(step_form_long).val(step_value);
                   var step_th_long = "th#step".concat(slice_id).concat("{{ forloop.counter0 }}.stepchoose");
                   $(step_th_long).css({"background-color":step_color});
                };
            });

        {% endfor %}

    };
    function long_form_change(event){
      var step_td_short = "td#short".concat($(event.target).attr('id'))  ;
      $(step_td_short).html($(event.target).val());
    };
    function select_click(event){
      event.preventDefault();
      if($("#checkbox0").is(':checked')){
        $(".checkbox_slice").prop('checked', false);
      } else{
         $(".checkbox_slice").prop('checked', true);
      };

    };
</script>
<table>
<tr>
  <th>Request ID:</th>
  <th>Description:</th>
  <th>Reference:</th>
  <th>Physic group:</th>
</tr>
<tr>
  <td>{{ trequest.reqid}}</td>
  <td>{{ trequest.description}}</td>
  <td><a href={{trequest.ref_link}} >{{ trequest.ref_link}}</a></td>
  <td>{{ trequest.phys_group}}</td>
</tr>
</table>

<h6> Total input: {{ totalSlice }}, from them approved: {{ approvedCount }}</h6>
<h6> With pattern: {{ pattern }}</h6>
<table style="padding: 0px;margin-bottom:0px;border: hidden">
<tr><td><button id="select_slice_checkobx" title="Select/unselect all" onclick="select_click(event);">Select All</button></td>
    <td>Filter:</td><td><form><input type="text" id="filter" style="width: 500px"></form></td></tr>
</table>
<form >

<table style="margin-left: 50px;border: hidden">
<tr>
    <th colspan="10">
        <select id="select_pattern" >
            <option value="" disabled selected>Select pattern</option>
            {% for pattern, steps in pattern_list %}
                <option value="{{ pattern }}">{{ pattern }}</option>
            {% endfor %}
        </select>
    </th>
    <th rowspan="2">
        <td><button id="bind" title="Create step execution" onclick="bind_click(event);">Bind</button></td>
        <td></td>
    </th>

</tr>
<tr>
{% for step in step_list %}
        <th class="stepchoose" id="start_step{{ forloop.counter0 }}"  > <div > {{step.name}}</div></th>
{% endfor %}
</tr>
    <tr>
        {% for step in step_list %}
            <td style="padding: 0px;width: 50px">
            <form><input type="text"  id="patternform{{forloop.counter0}}" value=""></form>
            </td>
        {% endfor %}

    </tr>
</table>
</form>


    <div >
    {% for inputList, step_exec_dict, approved in inputLists %}
        <div class="input_list_divs" >
        <table class="outside_input_list_tables"><tr>
            <td style="width: 29px;padding:0px;margin:0px"><form ><input  type="checkbox" class="checkbox_slice" id="checkbox{{ inputList.slice }}" checked></form></td>
            <td style="padding:0px;margin:0px">
            <table class="input_list_tables" >
            <tr class="inputListRow">
                <td style="width: 20px" >{{ inputList.slice }}</td>
                {% if  inputList.input_data|length < 10  %}
                    <td colspan="10" style="width: 500px" >
                        <span class='show_full_span' style="padding:0px" title="{{ inputList.dataset.name }}">
                            {{ inputList.dataset.name|truncatechars:"58" }}
                        </span>
                    </td>
                    <td>{{ inputList.input_data }}</td>
                {% else %}
                    <td colspan="10" style="width: 500px" >
                        <span class='show_full_span' style="padding:0px" title="{{ inputList.input_data }}">
                            {{ inputList.input_data|truncatechars:"58" }}
                        </span>
                    </td>
                    <td>{{  inputList.dataset.name }}</td>
                {% endif %}
                <td>{{ inputList.brief }}</td>
            </tr>
            <tr class="inputListRow">
                <td style="width: 20px"> </td>
                {% for step in step_exec_dict %}
                    <td class="show_full_span" id="short{{ inputList.slice }}{{ forloop.counter0 }}"
                        style="font-size:12px;width:50px;padding:0px;border:1px solid black">{{ step }}</td>
                {% endfor %}
                {% ifequal approved "Approved" %}
                    <td colspan="2" style="color: greenyellow"> Approved </td>
                {% endifequal %}
                {% ifequal approved "Not approved" %}
                    <td colspan="2" style="color: red"> Not approved </td>
                {% endifequal %}
            </tr>
            </table>
            <table class="input_list_tables_long" style="display: none">
                <tr><td style="width: 20px" class='show_small_span' >{{ inputList.slice }}</td>
                 <td colspan="11" class='show_small_span'>Dataset: {{ inputList.dataset.name }}</td></tr>
                <tr><td></td><td colspan="11">JobOption: {{ inputList.input_data }}</td></tr>
                <tr><td></td><td colspan="11">Brief: {{ inputList.brief }}</td></tr>
                <tr style="display: none"><td></td><td colspan="9">
                    <select id="select_pattern" >
                        <option value="" disabled selected>Select pattern</option>
                        {% for pattern in pattern_list %}
                            <option value="{{ pattern }}">{{ pattern }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td><button id="bind{{ inputList.slice }}" class="slice_bind" title="Create step execution">Bind</button></td>
                <td><button id="approveButton{{ inputList.slice }}" title="Approve">Approve</button></td>
                <tr>
                <th rowspan="2"></th>
                {% for step in step_list %}
                        <th class="stepchoose" id="step{{ inputList.slice }}{{ forloop.counter0 }}" > {{step.name}}</th>
                {% endfor %}
                {% ifequal approved "Approved" %}
                    <th rowspan="2" style="color: greenyellow"> Approved </th>
                {% endifequal %}
                {% ifequal approved "Not approved" %}
                    <th rowspan="2" style="color: red"> Not approved </th>
                {% endifequal %}
                </tr>
                    <tr>
                    {% for step in step_exec_dict %}
                        <td  style="padding: 0px;width: 50px" >
                            <div  >
                                <form><input type="text" onchange="long_form_change(event)" class="slice_form" id="{{ inputList.slice }}{{ forloop.counter0 }}"  value="{{ step }}"></form>
                            </div>
                        </td>
                    {% endfor %}
                    </tr>
            </table>
        </td>
        </tr></table>
        </div>
	{% endfor %}
    </div>
<button id="approveButton" title="Approve" onclick="approve_click(event);">Approve</button>
{% endblock %}