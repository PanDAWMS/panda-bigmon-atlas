{% extends parent_template %}
{% load url from future %}
{% load static from staticfiles %}

{% block bl_title %}Core App of Monitoring{% endblock %}

{% block subtitle %}
{% if title %}{{ title }}. Last task submit time {{ last_task_submit_time|date:"DATETIME_FORMAT" }} Page was generated {% now "DATETIME_FORMAT" %}{% else %}Datatable{% endif %}
{% endblock %}

{% block extra_css %}
{{ block.super }}
	<style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
        @import "{% static "css/jquery.dataTables_themeroller.css" %}";
	</style>
	
  <style type="text/css">
 	span.obsolete	{ color : lightblue;}
	span.holding 	{ color : black;	}
	span.pending	{ color : blue;		}
	span.waiting	{ color : blue;	}
	span.submitting	{ color : blue;	}
	span.archived 	{ color : magenta;	}
 	span.submitted	{ color : green;	}
	
	span.running 	{ color : LightGreen;	}
	
	span.done 		{ color : darkgreen;	}
	span.finished	{ color : darkgreen;	}
	
	span.failures	{ color : orange;	}
	
	span.failed 	{ color : red;	}
	span.aborted 	{ color : red;	}
	span.broken		{ color : red;	}
	
	span.navy		{ color : blue; }
    span.registered { color : blue;}
    
    .breaked_word  { word-wrap: break-word; width: 300px; max-width: 300px; }
    
  </style>
  
{% endblock %}

{% block base_js %}
{{ block.super }}
    <script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
    <script type="text/javascript" src="{% static "js/jquery.dataTables.min.js" %}"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.0.0.js"></script>
    <script type="text/javascript" src="{% static "js/jquery.address-1.5.js" %}"></script>
{% endblock %}


{% block body %}
<table>
<tr>
<td>
<table style="text-align: right;">
    <thead><tr><th colspan="0" style="text-align:center">Tasks select parameters</th></tr></thead>
    <tbody>
 <!--   <tr>
        <td>Filter:</td>
        <td>Value</td>
    </tr>
   --> 
    <tr>
    <td>
    
    <table>
    <tr>
        <td>Tasks type:</td>
        <td>
        <select id="task_type">
            <option value="">All ({{ total_task }} tasks)</option>
            <option value="production" selected="selected">Production ({{ task_count_by_type.production }} tasks)</option>  
            <option value="analysis">Analysis ({{ task_count_by_type.analysis }} tasks)</option>
        </select>
        </td>
    </tr>
    
    <tr>
    
        <td>Project:</td>
        <td>
        <select id="project">
            <option value="">All ({{ total_task }} tasks)</option>
        {% for project in projects %}
            <option value="{{ project.project }}">{{ project.project }} ({{ project.count }} tasks)</option>
        {% endfor %}
    <!--    </select> 
            <input id="project-label">
            <input type="hidden" id="project">
        </td> -->
    </tr>
    
    <tr>
    
        <td>Owner:</td>
        <td>
        <select id="username">
            <option value="-1">All ({{ total_task }} tasks)</option>
        {% for username in usernames %}
            <option value="{{ username.username }}">{{ username.username }} ({{ username.count }} tasks)</option>
        {% endfor %}
        </select> 
      <!--      <input id="username-label">
            <input type="hidden" id="username"> -->
        </td>
    </tr>
    </table>
    
    </td>
    <td>
    
    <table>
    <tr>
        <td>Request:</td>
        <td>
        <select id="request">
            <option value="">All ({{ total_task }} tasks)</option>
        {% for request in requests %}
            <option value="{{ request.request__reqid }}">{{ request.request__reqid }} ({{ request.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    </tr>
    <tr>
        <td>Chain:</td>
        <td>
        <select id="chain">
            <option value="">All ({{ total_task }} tasks)</option>
        {% for chain in chains %}
            <option value="{{ chain.chain_tid }}">{{ chain.chain_tid }} ({{ chain.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    </tr>
    <tr>
        <td>Status:</td>
        <td>
        <select id="status">
            <option value="">All ({{ total_task }} tasks)</option>
        {% for status in status_stat %}
            <option value="{{ status.status }}">{{ status.status }} ({{ status.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    </tr>
    </table>
    
    </td>
    
    <td>
    
    <table>
    <tr>
        <td>Provenance:</td>
        <td>
        <select id="provenance">
            <option value="-1">All ({{ total_task }} tasks)</option>
        {% for provenance in provenances %}
            <option value="{{ provenance.provenance }}">
{% if provenance.provenance == 'AP' %}ATLAS{% else %}{% if provenance.provenance == 'GP' %}Group{% else %}{% if provenance.provenance == '' %}User{% else %}provenance.provenance{% endif %}{% endif %}{% endif %} ({{ provenance.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    </tr>
    <tr>
        <td>Physics group:</td>
        <td>
        <select id="phys_group">
            <option value="-1">All ({{ total_task }} tasks)</option>
        {% for phys_group in phys_groups %}
            <option value="{{ phys_group.phys_group }}">{{ phys_group.phys_group }} ({{ phys_group.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    </tr>
    <tr>
    <!--
        <td>Parent:</td>
        <td>
        <select id="parent">
            <option value="">All ({{ total_task }} tasks)</option>
        {% for parent in parents %}
            <option value="{{ parent.parent_id }}">{{ parent.parent_id }} ({{ parent.count }} tasks)</option>
        {% endfor %}
        </select>
        </td>
    -->
    </tr>
    </table>
    
    </td>
    
    <td>
    
    <table>
    <tr>
        <td>Last update time period:</td>
        <td>
        <select id="time_period">
            <option value="" disabled="disabled">Custom</option>
            <option value="day">Last day</option>
            <option value="week">Last week</option>
            <option value="month">Last month</option>
            <option value="year">Last year</option>
            <option value="all">All time</option>
        </select>
        </td>
    </tr>
    
    <tr>
        <td>
            Last update time from:
        </td>
        <td>
            <input type="text" id="time_from" name="time_from">
        </td>
    </tr>
    <tr>
        <td>
            Last update time to:
        </td>
        <td>
            <input type="text" id="time_to" name="time_to">
        </td>
    </tr>
    </tbody>
    </table>
    
    </td>
    
    
    </tr>
    
</table>
</td>
<td>
<div id="task_stat_table">

<table><thead><tr><th colspan="0" style="text-align:center">Tasks status statistics</th></tr><tr>

</tr></thead>
<tbody><tr>

</tr></tbody>
</table>

</div>

</td>
</tr>
</table>

<script type="text/javascript">

    function taskServerParams ( aoData )
    {
        var time_from = $( "#time_from" ).datepicker( "getDate" );
        var time_to = $( "#time_to" ).datepicker( "getDate" );
        
        time_from = new Date(time_from.getUTCFullYear(), time_from.getUTCMonth(), time_from.getUTCDate()+2, -17);
        time_to = new Date(time_to.getUTCFullYear(), time_to.getUTCMonth(), time_to.getUTCDate()+3, -17);
        
        aoData.push( { "name": "task_type", "value": $("#task_type").val() } );
        aoData.push( { "name": "time_from", "value": time_from.getTime() } );
        aoData.push( { "name": "time_to",   "value": time_to.getTime() } );
    }

    function taskDrawCallback()
    {
       // SetParametersToURL();
    }
    
    function parseDate(input) {
        var dparts = input.slice(0,10).split('-');
        var tparts = input.slice(10,19).split(':');
          
        return new Date(dparts[0], dparts[1]-1, dparts[2], tparts[0], tparts[1], tparts[2] ); // Note: months are 0-based
    }
    
    function taskServerData( sSource, aoData, fnCallback, oSettings ) {
        
      function prepareData( data, textStatus, jqXHR )
      {
        for(var i in data['aaData'])
        {
            var row = data['aaData'][i];
            
            row[0] = '<a class="breaked_word" href="/prodtask/task/'+row[4]+'/">'+row[0]+'</a>';
            
            row[4] = '<a href="/prodtask/task/'+row[4]+'/">'+row[4]+'</a>'; /*+
                                 '<span style="float: right;" ><a href="/prodtask/task_update/'+row[0]+'/">Update</a>&nbsp;'+
                                 '<a href="/prodtask/task_clone/'+row[0]+'/">Clone</a></span>'*/
                                 
            row[2] = '<a href="/prodtask/stepex/'+row[2]+'/">'+row[2]+'</a>';
            row[1] = '<a href="/prodtask/request/'+row[1]+'/">'+row[1]+'</a>';
                                 
            /*
            switch(row[8])
            {
                case 'AP': row[8]='ATLAS'; break;
                case 'GP': row[8]='Group'; break;
                case 'XP': row[8]='eXtended'; break;
            }*/
            
            var time_stamp_color = 'black';
            switch(row[11])
            {
                case "done":
                case "finished":
                case "broken":
                case "failed":
                case "aborted":
                case "obsoleted":
                    break;
                    
                default:
                    if( row[12]!='None' )
                    {   
                        var last_update = parseDate(row[12].slice(0,19));
                        var now = new Date();
                        var diff = now - last_update;
                        if(diff > (24 * 3600 * 1000))
                            time_stamp_color = 'yellow';
                        if(diff > (48 * 3600 * 1000))
                            time_stamp_color = 'orange';
                        if(diff > (72 * 3600 * 1000))
                            time_stamp_color = 'red';
                    }
                    else
                        time_stamp_color = 'red';
                    break;
            }    
            
            row[12] = row[12]=='None'? 'None' : parseDate(row[12].slice(0,19)).toString() ;
         //  row[13] = row[13]=='None'? 'None' : parseDate(row[13].slice(0,19)).toString() ;
         //   row[21] = row[21]=='None'? 'None' : parseDate(row[21].slice(0,19)).toString() ;
         //   row[14] = row[14]=='None'? 'None' : row[14].slice(0,19) ;
         
            row[12] = '<span style="color : '+time_stamp_color+';">'+ row[12].slice(4,10) + row[12].slice(15,21) +'</span>';
            
          //  row[13] = row[13]=='None'? 'None' :  row[13].slice(4,10) + row[13].slice(15,21);
          //  row[21] = row[21]=='None'? 'None' : row[21].slice(4,10) + row[21].slice(15,21);
         
            row[11] = '<span class="'+row[11]+'">'+row[11]+'</span>';
        }
        
        updateInterface(data['task_stat']);
        
        fnCallback( data, textStatus, jqXHR );
      }
    
      oSettings.jqXHR = $.ajax( {
        "dataType": 'json',
        "type": "GET",
        "url": sSource,
        "data": aoData,
        "success": prepareData
      } )
    }


    var parameters_list = [ 
        { name: 'task_type',    id: 'task_type'},
        { name: 'project',      id: 'project'},
        { name: 'username',     id: 'username'},
        
        { name: 'request',      id: 'request'},
        { name: 'chain',        id: 'chain'},
        { name: 'status',       id: 'status'},
        
        { name: 'provenance',   id: 'provenance'},
        { name: 'phys_group',   id: 'phys_group'},
        
        { name: 'time_from',    id: 'time_from'},
        { name: 'time_to',      id: 'time_to'},
    ];

    function SetParametersToURL()
    {
        for(var i in parameters_list)
        {
            var val = $( "#"+parameters_list[i].id ).val();
            $.address.path( parameters_list[i].name +'='+  val );
        }
    }
    
    var changed_params = {};
    
    function ParseParametersFromURL()
    {
        for(var i in parameters_list)
        {
            var value = $.address.parameter( parameters_list[i].name );
            if( value )
            {
                $( "#"+parameters_list[i].id ).val( value );
                changed_params[ parameters_list[i].name ] = parameters_list[i];
            }
            else
            {
                switch( parameters_list[i].name )
                {
                    case 'task_type': 
                        $("#task_type").val('production');
                        break;
                    case 'username':
                    case 'provenance':
                    case 'phys_group':
                        $('#'+parameters_list[i].name).val('-1');
                        break;
                    default:
                        $( "#"+parameters_list[i].id ).val( '' );
                        break;
                }
            }
        } 
    
        var time_from = new Date();
        var time_to = new Date();
        
        time_from.setMonth( time_from.getMonth() - 1 )
        
        $( "#time_from" ).datepicker( "setDate", time_from );
        $( "#time_to" ).datepicker( "setDate", time_to );
        
        $( "#time_from" ).datepicker( "option", "maxDate", time_to );
        $( "#time_to" ).datepicker( "option", "minDate", time_from );
        
      //  $( "#time_period" ).val('');
        $("#time_period").val('month');

    //    $("#task_type").val('production');
            
    //    $("#request").val('');
    //    $("#parent").val('');
    //    $("#status").val('');
     //   $("#chain").val('');
    //    $("#project").val(projects[0].value); 
    //    $("#username").val(usernames[0].value);

    }


    $( "#time_from" ).datepicker({
            defaultDate: "-2m",
            changeMonth: true,
            numberOfMonths: 1,
            onSelect: function( selectedDate ) {
                $( "#time_to" ).datepicker( "option", "minDate", selectedDate );
                $( "#time_period" ).val('');
                taskTable.fnDraw();
            }
        });
    $( "#time_to" ).datepicker({
            defaultDate: "+1w",
            changeMonth: true,
            numberOfMonths: 1,
            onSelect: function( selectedDate ) {
                $( "#time_from" ).datepicker( "option", "maxDate", selectedDate );
                $( "#time_period" ).val('');
                taskTable.fnDraw();
            }
    });
    
    
    var total_task = {{ total_task }};
    /*
    var projects = [    { value : "" , label : "All ({{ total_task }} tasks)" },
                        {% for project in projects %}
                            { value : "{{ project.project }}", label : "{{ project.project }} ({{ project.count }} tasks)" },
                        {% endfor %}
                    ];
                    
    var usernames = [    { value : "" , label : "All ({{ total_task }} tasks)" },
                        {% for username in usernames %}
                            { value : "{{ username.username }}", label : "{{ username.username }} ({{ username.count }} tasks)" },
                        {% endfor %}
                    ];
                    

    $("#project-label").val(projects[0].label);
    $("#project-label").focus( function(){
                  //  $("#project-label").val('');
                    $("#project-label").autocomplete( "search", "" );
                } );
    

    $("#username-label").val(usernames[0].label);
    $("#username-label").focus( function(){
                  //  $("#username-label").val('');
                    $("#username-label").autocomplete( "search", "" );
                } );
                */
    function updateInterface(data)
    {
        var table = '<table><thead><tr><th colspan="0" style="text-align:center">Tasks status statistics</th></tr><tr>';
        for( var i in data )
        {   
            table += '<th><span class="'+ data[i].status +'">'+ data[i].status +'</span></th>';
        }
        table += '</tr></thead><tbody><tr>';
        
       // table += '<td><span class="total">'+ total_task +'</span></td>';
        for( var i in data )
        {   
            table += '<td>'+ data[i].count +'</td>';
        }

        table += '</tr></tbody></table>';
        
        $('#task_stat_table').html(table);
    }
    
    ParseParametersFromURL();
    
</script>
 
{{ table.as_html }}
 
<script type="text/javascript">
$(document).ready(function() {
                   //     taskTable.fnSetColumnVis( 21, false, false );

                        $("#request").change(function () {
                                taskTable.fnFilter( $(this).val(), 1 );
                            });
                    //    if( 'request' in changed_params)
                    //        $("#request").change();
                            
                            /*
                        $("#parent").change(function () {
                                taskTable.fnFilter( $(this).val(), 3 );
                            });
                            */
                            
                        $("#status").change(function () {
                                taskTable.fnFilter( $(this).val(), 11 );
                            });
                            
                   //     if( 'status' in changed_params)
                   //         $("#status").change();
                            
                        $("#provenance").change(function () {
                                if( $(this).val() == '-1' )
                                    taskTable.fnFilter( '', 15 );
                                else
                                    taskTable.fnFilter( $(this).val(), 15 );  

                            });
                            
                        $("#phys_group").change(function () {
                                if( $(this).val() == '-1' )
                                    taskTable.fnFilter( '', 16 );
                                else
                                    taskTable.fnFilter( $(this).val(), 16 );
                            });
                            
                        $("#task_type").change(function () {
                                taskTable.fnDraw();
                                
                                if( $("#task_type").val() == 'analysis' )
                                {
                                    taskTable.fnSetColumnVis( 1, false, false );
                                    taskTable.fnSetColumnVis( 2, false, false );
                                    taskTable.fnSetColumnVis( 13, false, false );
                                    taskTable.fnSetColumnVis( 18, false, false );
                                }
                                else
                                {
                                    taskTable.fnSetColumnVis( 1, true, false );
                                    taskTable.fnSetColumnVis( 2, true, false );
                                    taskTable.fnSetColumnVis( 13, false, false );
                                    taskTable.fnSetColumnVis( 18, true, false ); 
                                }
                            });
                  //      if( 'task_type' in changed_params)
                  //          $("#task_type").change();
                            
                            
                        /*    
                         $( "#project-label" ).autocomplete({
                            minLength: 0,
                            source: projects,
                            focus: function( event, ui ) {
                                $( "#project-label" ).val( ui.item.label );
                                return false;
                                },
                            select: function( event, ui ) {
                                $( "#project-label" ).val( ui.item.label );
                                $( "#project-label" ).blur();
                                $( "#project" ).val( ui.item.value );
                                taskTable.fnFilter( $("#project").val(), 5 );
                                return false;
                            }
                        })
                        
                        $( "#username-label" ).autocomplete({
                            minLength: 0,
                            source: usernames,
                            focus: function( event, ui ) {
                                $( "#username-label" ).val( ui.item.label );
                                return false;
                                },
                            select: function( event, ui ) {
                                $( "#username-label" ).val( ui.item.label );
                                $( "#username-label" ).blur();
                                $( "#username" ).val( ui.item.value );
                                taskTable.fnFilter( $("#username").val(), 20 );
                                return false;
                            }
                        })
                            */
                            
                        $("#project").change(function (){  
                                taskTable.fnFilter( $("#project").val(), 6 );  
                            });
                    //    if( 'project' in changed_params)
                   //         $("#project").change();
                           
                           
                        $("#username").change(function (){
                                if( $(this).val() == '-1' )
                                    taskTable.fnFilter( '', 20 );
                                else
                                    taskTable.fnFilter( $(this).val(), 20 );  
                            });
                     //   if( 'username' in changed_params)
                     //       $("#username").change();
                            
                            
                        $("#chain").change(function () {
                                taskTable.fnFilter( $(this).val(), 7 );
                            });
                      //  if( 'chain' in changed_params)
                     //       $("#chain").change();
                            
                            
                        $( "#time_period" ).change(function () {
                        
                                var time_from = new Date();
                                var time_to = new Date();
                                
                                switch($(this).val())
                                {
                                    case 'day': time_from.setDate( time_from.getDate() - 1 ); break;
                                    case 'week': time_from.setDate( time_from.getDate() - 7 ); break;
                                    case 'month': time_from.setMonth( time_from.getMonth() - 1 ); break;
                                    case 'year': time_from.setFullYear( time_from.getFullYear() - 1 ); break;
                                    case 'all': time_from.setFullYear( time_from.getFullYear() - 3 ); break;
                                }
                                
                                $( "#time_from" ).datepicker( "setDate", time_from );
                                $( "#time_to" ).datepicker( "setDate", time_to );
                                
                                $( "#time_from" ).datepicker( "option", "maxDate", time_to );
                                $( "#time_to" ).datepicker( "option", "minDate", time_from );
                                
                                taskTable.fnDraw();
                            });
                            

});
 </script>
{% endblock %}

