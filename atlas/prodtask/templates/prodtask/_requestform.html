{% extends parent_template %}
{% load url from future %}
{% load static from staticfiles %}
{% load js %}

{% block extra_css %}
{{ block.super }}
    <style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
	</style>
	<style type="text/css" title="currentStyle">
	</style>
{% endblock %}

{% block subtitle %}
{{pre_form_text|safe}}
{% endblock %}
{% block base_js %}
{{ block.super }}

{%  django_js %}
<script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript" src="{% static "js/jquery.cookie.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.json-2.4.min.js" %}"></script>
{% endblock %}

{% block body %}
<script>

    function addMoreSlices(event){
        event.preventDefault();
        var nextNumber = parseInt($('#sliceNumber').html());
        var cloneForm = $('#form0_0').clone().prop({'id':"form"+nextNumber.toString()+'_0'});
        var idForm = "form"+nextNumber.toString()+'_0';
        var sliceDiv = $('<div/>').prop({'id':"sliceSteps"+nextNumber.toString()});
        cloneForm.children("legend").html("Slice #"+(nextNumber).toString()+' step #0');
        sliceDiv.append(cloneForm);
        $('#formSet').append(sliceDiv);
        $('#sliceNumber').html((nextNumber+1).toString());
        $("#"+idForm+" #searchDatasetButton0").prop({'id':"searchDatasetButton"+nextNumber.toString()});
        $("#" +idForm+ " .datasetTBody").html("");
        $("#" +idForm+ " .datasetTBody").prop({'id':"datasetsTable"+nextNumber.toString()});
        $("#" +idForm+ " #datasetPattern0").val('');
        $("#" +idForm+ " #datasetPattern0").prop({'id':"datasetPattern"+nextNumber.toString()});
        $("#" +idForm+ " #addStepButton0_0").prop({'id':"addStepButton"+nextNumber.toString()+'_0'}).removeAttr("disabled").attr('onclick','addStep(this.id);');
        bindOnChangeToFieldSet();
        fillSlicesField();
    }
     function addStep(buttonID){
        event.preventDefault();

        var currentSlice = parseInt(buttonID.replace('addStepButton','').split('_')[0]);
        var currentStep = parseInt(buttonID.replace('addStepButton','').split('_')[1])+1;
        var currentID = currentSlice.toString() + '_' + currentStep.toString();
        var cloneForm = $('#form0_0').clone().prop({'id':"form"+currentID});
        var idForm = "form"+currentID;
        cloneForm.children("legend").html("Slice #"+(currentSlice).toString()+' step #' + currentStep.toString()) ;
        $('#sliceSteps'+currentSlice.toString()).append(cloneForm);
        $("#" +idForm+ " .datasetTBody").html("");
        $("#" +idForm+ " .hideNotFirst").css({display:'none'});
        $("#" +idForm+ " #addStepButton0_0").prop({'id':"addStepButton"+currentID}).removeAttr("disabled").attr('onclick','addStep(this.id);');
        $('#'+buttonID).attr('disabled','disabled').attr('onclick','').click(undefined);

        $("#" +idForm+ " .showNotFirst").show();
        $("#" +idForm+ " .parentStep").val("Slice #"+(currentSlice).toString()+' step #' + (currentStep-1).toString());
        bindOnChangeToFieldSet();
        fillSlicesField();
    }
    var csrftoken = $.cookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

$(document).ready(function(){

        bindOnChangeToFieldSet();
});
        function bindOnChangeToFieldSet(){
            $('.storeInput').bind('change',function(){fillSlicesField();});
        }


        function fillSlicesField(){
            var resultObject = {};
            $(".sliceFiledset").each(function(){
               var sliceNumber = $(this).attr("id").replace("form","");
                var sliceObject = {};
               $(this).find(".storeInput").each(function(){
                   sliceObject[$(this).attr('class').replace(" storeInput","")] = $(this).val();
               });
               var datasets='';
               $(this).find(".datasetNames").each(function(){
                  if($(this).siblings(".innnerDatasetCheckbox.storeInput").find('input').is(':checked')) {
                      datasets += $(this).html() + ',';
                  }
               });
               sliceObject['datasets']='';
               if  (datasets&&(datasets!='')){
                   sliceObject['datasets']  = datasets;
               }
               if  (sliceObject['datasetList']&&(sliceObject['datasetList']!='')){
                   sliceObject['datasets'] += sliceObject['datasetList'].replace(/(\r\n|\n|\r)/gm,",");
               }
               resultObject[sliceNumber]  = sliceObject;
            });
            $("#{{ form.hidden_json_slices.auto_id }}").val($.toJSON(resultObject));

          }

        function findDatasets(currentButton){
            var sliceNumber = currentButton.slice("searchDatasetButton".length);
              sendData = {'datasetPattern':$("#datasetPattern" + sliceNumber).val()}
              $( "#waitingDialog" ).dialog();
              $.ajax({
                    url: "{% url 'prodtask:find_datasets_by_pattern' %}",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: $.toJSON(sendData),
                    dataType: 'text',
                    success: function(data,status) {
                        $( "#waitingDialog" ).dialog('close');
                        if(status){
                            var datasets = $.evalJSON(data).data;
                            $("#datasetsTable" + sliceNumber).html('');
                            for(var i=0;i<datasets.length;i++){
                              $("#datasetsTable" + sliceNumber).append('<tr><td class="datasetNames">'+
                                      datasets[i].dataset_name+'</td><td>'+datasets[i].events+
                                '</td><td class="innnerDatasetCheckbox storeInput"><input type="checkbox" value="checked"/> </td></tr>');
                            }
                            bindOnChangeToFieldSet();
                        }
                    }
                });
              return false;
        }


</script>

<div id="waitingDialog" title="Run" style="display: none">
  <p>Please wait...</p>
</div>
{% if error_message %}
    <strong>ERROR: {{ error_message }} </strong>
{% endif %}
{% if submit_url %}
{% if form.is_multipart %}
    <form action="{% if url_args %}{% url submit_url url_args %}{% else %}{% url submit_url %}{% endif %}" enctype="multipart/form-data" method="post">{% csrf_token %}
{% else %}
    <form action="{% if url_args %}{% url submit_url url_args %}{% else %}{% url submit_url %}{% endif %}" method="post">{% csrf_token %}
{% endif %}
<table>
{{ form.as_table }}
</table>
<input id="form_submit" type="submit" value="{% if submit_text %}{{submit_text}}{% else %}Submit{% endif %}" />
</form>
{% else %}
<table>
{{ form.as_table }}
</table>
{% endif %}

 <a class="button" onclick="addMoreSlices(event);">Add slice</a>
 <strong id="sliceNumber">1</strong>
 <div id="formSet">
    <div id="sliceSteps0">
     <fieldset id="form0_0" class="sliceFiledset">
      <legend>Slice #0 step #0</legend>
      <div class="row hideNotFirst">
        <div class="large-12 columns">
          <label>Dataset Filter
            <input type="text" id='datasetPattern0' placeholder="dataset pattern" />
          </label>
        </div>
      </div>
       <div class="row buttonRow hideNotFirst">
        <div class="large-4 columns">
            <a class="button" id='searchDatasetButton0' onclick="findDatasets(this.id);">Find datasets</a>
        </div>
      </div>
      <div class="row hideNotFirst">
          <div class="large-12 columns">
          <table>
              <thead>
              <tr>
                <th>Dataset Name</th>
                <th>events</th>
                <th><input type="checkbox"/> </th>
              </tr>
              </thead>
              <tbody class="datasetTBody" id="datasetsTable0">
              </tbody>
          </table>
          </div>
      </div>
        <div class="row hideNotFirst">
        <div class="large-12 columns">
          <label> Or datasets list:
            <textarea  class="datasetList storeInput" placeholder=" " ></textarea>
          </label>
        </div>
        </div>
        <div class="row showNotFirst" style="display: none">
        <div class="large-3 columns">
          <label> Parent step
            <input type="text" class="parentStep storeInput"  readonly />
          </label>
         </div>
        <div class="large-3 columns">
          <label> Input format
            <input type="text" class="inputFormat storeInput" placeholder="ESD"  />
          </label>
        </div>

         </div>
      <div class="row">
        <div class="large-3 columns">
          <label> Ami tag
            <input type="text" class="ctag storeInput" placeholder="r2222"  />
          </label>
        </div>
         <div class="large-4 columns">
          <label>Output formats
            <input type="text" class="formats storeInput" placeholder="ESD.AOD"  />
          </label>
        </div>
         <div class="large-2 columns">
          <label>Events per job
            <input type="number" class="eventsperjob storeInput"  value="1000"  />
          </label>
        </div>
         <div class="large-2 columns">
          <label>Total events
            <input type="number" class="totalevents storeInput" value="-1"  />
          </label>
        </div>
           <div class="large-1 columns">
          <label>ram
            <input type="number" class="ram storeInput" value="2000"  />
          </label>
        </div>
       </div>
        <div class="row">
        <div class="large-9 columns">
          <label>project mode
            <input type="text" class="projectmode storeInput" value="spacetoken=ATLASDATADISK" />
          </label>
        </div>
        <div class="large-3 columns">
          <label>Priority
            <input type="number" class="priority storeInput" value="900" />
          </label>
        </div>
      </div>
        <div class="row">
            <a class="button" id="addStepButton0_0" onclick="addStep(this.id);">Add step</a>
            <a class="button" disabled>Make step starting from new slice</a>
      </div>
    </fieldset>
    </div>
</div>

{% endblock %}


{% block bl_entry_point %}
    {{ block.super }}
    $( "#form_submit" ).button();
{% endblock %}