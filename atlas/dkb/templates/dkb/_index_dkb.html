{% extends parent_template %}
{% load url from future %}
{% load static from staticfiles %}
{% load js %}

{% block extra_css %}
{{ block.super }}
    <style type="text/css" title="currentStyle">
	    @import "{% static "css/jquery-ui-1.10.3.custom.min.css" %}";
	</style>
	<style type="text/css" title="currentStyle">
	</style>
{% endblock %}

{% block subtitle %}
{{pre_form_text|safe}}
{% endblock %}
{% block base_js %}
{{ block.super }}

{%  django_js %}
<script type="text/javascript" src="{% static "js/jquery-1.9.1.min.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery-ui-1.10.3.custom.min.js" %}"></script>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script type="text/javascript" src="{% static "js/jquery.cookie.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.json-2.4.min.js" %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-resource.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-route.min.js"></script>

{% endblock %}

{% block body %}


<script>


    {% verbatim %}

    var DKBServices = angular.module('DKBServices', ['ngResource']);
    DKBServices.run(run);
    run.$inject = ['$http'];
    /**
    * @name run
    * @desc Update xsrf $http headers to align with Django's defaults
    */
    function run($http) {
      $http.defaults.xsrfHeaderName = 'X-CSRFToken';
      $http.defaults.xsrfCookieName = 'csrftoken';
    }


    var DKBApp = angular.module('DKBApp',['ngRoute','DKBServices']);
       DKBApp.config(function($resourceProvider) {
       $resourceProvider.defaults.stripTrailingSlashes = false;
   });

    DKBApp.directive('atlastask', function() {
          return {
            scope: {
                taskMeta: '=taskmeta'
            },
            templateUrl: '/static/html/_ng_task.html'
          };
        });

    DKBApp.controller('DKBCtrl',['$scope','$http',  '$location',
        function (scope, http, location){

            scope.showTasks= function(){
                var toSend = {search_string:scope.keywords};
                http.post(Django.url('dkb:search_string_to_url'),toSend).
                  success(function(data, status, headers, config) {
                    var url = data.url;
                    window.location.href = '#/task_keywords/'+url;
                  }).
                  error(function(data, status, headers, config) {
                    console.log(status);
                  });
            }


        }]);

    DKBApp.controller('DKBSummaryCtrl',['$scope','$http','$routeParams',

        function (scope, http, routeParams) {

            scope.loading = true;
            scope.query_string  = '';
            var toSend = {search_string:routeParams.search_string};
            http.post(Django.url('dkb:es_task_search'), toSend).
             success(function(data, status, headers, config) {
                scope.tasks = data;
                scope.loading = false;

             }).
            error(function(data, status, headers, config) {
                        if (data.message != undefined){
                            alert(data.message);
                        }

            });
            http.post(Django.url('dkb:search_string_to_url'), toSend).
             success(function(data, status, headers, config) {
                scope.query_string = data.query_string;

             }).
            error(function(data, status, headers, config) {
                        if (data.message != undefined){
                            alert(data.message);
                        }

            });
        }]);

    DKBApp.config(function($routeProvider) {
          $routeProvider.
            when('/', {
              templateUrl:'/static/html/_ng_task_search.html',
              controller: 'DKBCtrl as DKBModel'
            }).
          when('/task_keywords/:search_string', {
              templateUrl: '/static/html/_ng_task_summary.html',
              controller: 'DKBSummaryCtrl'
            }).
            otherwise({
              redirectTo: '/'
            });
    });
</script>
{% endverbatim %}
<div ng-app="DKBApp">
    <div ng-view></div>

</div>
{% endblock %}